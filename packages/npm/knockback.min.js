// Generated by CoffeeScript 1.3.3
/*
  knockback.js 0.16.0beta2
  (c) 2011, 2012 Kevin Malakoff.
  Knockback.js is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/knockback/blob/master/LICENSE
  Dependencies: Knockout.js, Backbone.js, and Underscore.js.
    Optional dependency: Backbone.ModelRef.js.
*/(function(){var e,t,n,r,i,s,o,u,a,f,l=function(e,t){return function(){return e.apply(t,arguments)}},c={}.hasOwnProperty,h=function(e,t){function r(){this.constructor=e}for(var n in t)c.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};if(typeof require!="undefined")try{f=require("lodash")}catch(p){f=require("underscore")}else f=this._;f&&f.hasOwnProperty("_")&&(f=f._),e=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,s=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko,t=i=this.Knockback=this.kb=typeof exports!="undefined"?exports:{},i.VERSION="0.16.0beta2",i.locale_manager=void 0,i.TYPE_UNKNOWN=0,i.TYPE_SIMPLE=1,i.TYPE_MODEL=2,i.TYPE_COLLECTION=3,i.release=function(e,t){var n,r;if(!e)return!1;if(!t&&(s.isObservable(e)||typeof e.destroy=="function"||typeof e.release=="function"))e.destroy?(e.collection||!e.destroyAll||!e.indexOf)&&e.destroy():e.release?e.release():e.dispose&&e.dispose();else if(f.isObject(e)&&typeof e!="function")for(n in e){r=e[n];if(!r||n==="__kb")continue;if(!s.isObservable(r)&&typeof r.destroy!="function"&&typeof r.release!="function")continue;e[n]=null,r.destroy?(r.collection||!r.destroyAll||!r.indexOf)&&r.destroy():r.release?r.release():r.dispose&&r.dispose()}},n=Array.prototype.slice,r=Array.prototype.splice,u=function(e,t){throw""+e.constructor.name+": "+t+" is missing"},a=function(e,t){throw""+e.constructor.name+": "+t+" is unexpected"},o=function(e,t,n){var r;return i._legacy_warnings||(i._legacy_warnings={}),(r=i._legacy_warnings)[e]||(r[e]=0),i._legacy_warnings[e]++,console.warn("warning: '"+e+"' has been deprecated (will be removed in Knockback after "+t+"). "+n+".")},i.utils={},i.utils.wrappedDestroy=function(e){var t;if(!e.__kb)return;return e.__kb.model_watcher&&e.__kb.model_watcher.releaseCallbacks(e),t=e.__kb,e.__kb=null,t.observable&&(t.observable.destroy=t.observable.release=null,i.utils.wrappedDestroy(t.observable)),t.factory=null,t.model_watcher_is_owned&&t.model_watcher.destroy(),t.model_watcher=null,t.store_is_owned&&t.store.destroy(),t.store=null,i.release(t,!0)},i.utils.wrappedKey=function(e,t,n){return arguments.length===2?e&&e.__kb&&e.__kb.hasOwnProperty(t)?e.__kb[t]:void 0:(e||a(this,"no obj for wrapping "+t),e.__kb||(e.__kb={}),e.__kb[t]=n,n)},i.utils.wrappedModel=function(e,t){return arguments.length===1?(t=i.utils.wrappedKey(e,"object"),f.isUndefined(t)?e:t):i.utils.wrappedKey(e,"object",t)},i.utils.wrappedObservable=function(e,t){return r.call(arguments,1,0,"observable"),i.utils.wrappedKey.apply(this,arguments)},i.utils.wrappedObject=function(e,t){return r.call(arguments,1,0,"object"),i.utils.wrappedKey.apply(this,arguments)},i.utils.wrappedStore=function(e,t){return r.call(arguments,1,0,"store"),i.utils.wrappedKey.apply(this,arguments)},i.utils.wrappedStoreIsOwned=function(e,t){return r.call(arguments,1,0,"store_is_owned"),i.utils.wrappedKey.apply(this,arguments)},i.utils.wrappedFactory=function(e,t){return r.call(arguments,1,0,"factory"),i.utils.wrappedKey.apply(this,arguments)},i.utils.wrappedModelWatcher=function(e,t){return r.call(arguments,1,0,"model_watcher"),i.utils.wrappedKey.apply(this,arguments)},i.utils.wrappedModelWatcherIsOwned=function(e,t){return r.call(arguments,1,0,"model_watcher_is_owned"),i.utils.wrappedKey.apply(this,arguments)},i.utils.setToDefault=function(e){var t,n;if(!e)return;if(s.isObservable(e))typeof e.setToDefault=="function"&&e.setToDefault();else if(f.isObject(e))for(t in e)n=e[t],n&&t!=="__kb"&&i.utils.setToDefault(n);return e},i.utils.release=function(e,t){return o("kb.utils.release","0.16.0","Please use kb.release instead"),i.release(e,t)},i.utils.valueType=function(t){return t?t.__kb_is_o?t.valueType():t.__kb_is_co||t instanceof e.Collection?i.TYPE_COLLECTION:t instanceof i.ViewModel||t instanceof e.Model?i.TYPE_MODEL:i.TYPE_SIMPLE:i.TYPE_UNKNOWN},i.utils.pathJoin=function(e,t){return(e?e[e.length-1]!=="."?""+e+".":e:"")+t},i.utils.optionsPathJoin=function(e,t){return f.defaults({path:i.utils.pathJoin(e.path,t)},e)},i.RefCountable=function(){function t(){this.__kb_ref_count=1}return t.extend=e.Model.extend,t.prototype.__destroy=function(){},t.prototype.retain=function(){return this.__kb_ref_count>0||a(this,"ref count is corrupt"),this.__kb_ref_count++,this},t.prototype.releaseReferences=function(){},t.prototype.release=function(){return this.__kb_ref_count>0||a(this,"ref count is corrupt"),this.__kb_ref_count--,this.__kb_ref_count||this.__destroy(),this},t.prototype.refCount=function(){return this.__kb_ref_count},t}(),i.Factory=function(){function t(e){this.parent_factory=e,this.paths={}}return t.useOptionsOrCreate=function(e,t,n){var r;return e.factory&&!e.factories?r=i.utils.wrappedFactory(t,e.factory):r=i.utils.wrappedFactory(t,new i.Factory(e.factory)),e.factories&&r.addPathMappings(e.factories,n),r},t.prototype.hasPath=function(e){return this.paths.hasOwnProperty(e)||this.parent_factory&&this.parent_factory.hasPath(e)},t.prototype.addPathMapping=function(e,t){return this.paths[e]=t},t.prototype.addPathMappings=function(e,t){var n,r;for(r in e)n=e[r],this.paths[i.utils.pathJoin(t,r)]=n;return this},t.prototype.creatorForPath=function(t,n){var r;if(r=this.paths[n])return r.view_model?r.view_model:r;if(this.parent_factory)if(r=this.parent_factory.creatorForPath(t,n))return r;return t instanceof e.Model?i.ViewModel:t instanceof e.Collection?i.CollectionObservable:null},t.prototype.createForPath=function(e,t,n,r){return r||(r=this.creatorForPath(e,t)),r?r.hasOwnProperty("models_only")?e(r.models_only):typeof r=="function"?new r(e,{store:n,factory:this,path:t,creator:r}):r.create?r.create(e,{store:n,factory:this,path:t,creator:r}):a(this,"unrecognized creator for "+t):s.observable(e)},t.createDefault=function(t,n){return t instanceof e.Model?i.viewModel(t,n):t instanceof e.Collection?i.collectionObservable(t,n):s.observable(t)},t}(),i.Store=function(){function t(){this.objects=[],this.observables=[]}return t.useOptionsOrCreate=function(e,t,n){return e.store?(e.store.registerObservable(t,n,e),i.utils.wrappedStore(n,e.store)):(i.utils.wrappedStoreIsOwned(n,!0),i.utils.wrappedStore(n,new i.Store))},t.prototype.destroy=function(){var e,t,n;n=this.observables;for(e in n){t=n[e];if(!t)continue;typeof t.releaseReferences=="function"&&t.releaseReferences(),t.release?t.release():i.release(t)}return this.objects=null,this.observables=null},t.prototype.registerObservable=function(e,t,n){if(!e||!t)return;if(s.isObservable(t)||t.__kb_is_co)return;n||(n={}),this.objects.push(e),i.utils.wrappedObject(t,e),this.observables.push(t),typeof t.retain=="function"&&t.retain(),t.__kb||(t.__kb={});if(n.creator)return t.__kb.creator=n.creator;if(n.path&&n.factory)return t.__kb.creator=n.factory.creatorForPath(e,n.path)},t.prototype.findOrCreateObservable=function(t,n,r,o){var u,a,l,c,h,p;if(!r)a=(o?o:i.Factory.createDefault)(t,{path:n,store:this,creator:o});else{o||(o=r.creatorForPath(t,n));if(!o)return s.observable(t);if(o.models_only)return t;if(t&&!(t instanceof e.Collection)){p=this.objects;for(u=c=0,h=p.length;c<h;u=++c){l=p[u],a=this.observables[u];if(!a||!a.__kb)continue;if(l===t&&a.__kb.creator===o)return typeof a.retain=="function"&&a.retain(),a}}a=r.createForPath(t,n,this,o),a||(a=s.observable(null))}return f.indexOf(this.observables,a)<0&&this.registerObservable(t,a,{creator:o}),a},t.prototype.releaseObservable=function(e,t){var n;if(!e)return;if(arguments.length===2&&!t&&!e.release)return;i.release(e);if(e.refCount&&e.refCount()>0)return;i.utils.wrappedObject(e,null);if((n=f.indexOf(this.observables,e))<0)return;return this.objects[n]=null,this.observables[n]=null},t}(),i.ModelWatcher=function(){function t(e,t,n){this._onModelUnloaded=l(this._onModelUnloaded,this),this._onModelLoaded=l(this._onModelLoaded,this),this.__kb||(this.__kb={}),this.__kb.callbacks={},this.__kb._onModelLoaded=f.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=f.bind(this._onModelUnloaded,this),n&&this.registerCallbacks(t,n),e?this.model(e):this.m=null}return t.useOptionsOrCreate=function(e,t,n,r){return e.model_watcher?(e.model_watcher.model()!==t&&e.model_watcher.model_ref!==t&&a(this,"model not matching"),i.utils.wrappedModelWatcher(n,e.model_watcher).registerCallbacks(n,r)):(i.utils.wrappedModelWatcherIsOwned(n,!0),i.utils.wrappedModelWatcher(n,new i.ModelWatcher(t)).registerCallbacks(n,r))},t.prototype.destroy=function(){return this.model(null),this.__kb.callbacks=null,i.utils.wrappedDestroy(this)},t.prototype.model=function(t){var n,r,i,s,o,u,a,f;if(arguments.length===0||this.m===t)return this.m;this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),e.ModelRef&&t instanceof e.ModelRef?(this.model_ref=t,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),t=this.model_ref.model()):delete this.model_ref,o=this.m,this.m=t,f=this.__kb.callbacks;for(r in f){n=f[r],o&&o.unbind(r,n.fn),t&&t.bind(r,n.fn),s=n.list;for(u=0,a=s.length;u<a;u++)i=s[u],i.model&&i.model(t)}return t},t.prototype.registerCallbacks=function(t,n){var r,i,o,a;return t||u(this,"obj"),n||u(this,"options"),i=n.event_name?n.event_name:"change",r=this.__kb.callbacks[i],r||(a=[],r={list:a,fn:function(e){var t,n,r;for(n=0,r=a.length;n<r;n++){t=a[n];if(t.update){if(e&&t.key&&e.hasChanged&&!e.hasChanged(s.utils.unwrapObservable(t.key)))continue;t.update()}}return null}},this.__kb.callbacks[i]=r,this.m&&this.m.bind(i,r.fn)),o={},o.obj=t,o.model=n.model,o.update=n.update,o.key=n.key,r.list.push(o),this.m&&(e.RelationalModel&&this.m instanceof e.RelationalModel&&this._modelBindRelatationalInfo(i,o),o.model(this.m)&&o.model),this},t.prototype.releaseCallbacks=function(e){var t,n,r,i,s,o;if(!this.__kb.callbacks)return;s=this.__kb.callbacks;for(n in s){t=s[n],o=t.list;for(r in o){i=o[r];if(i.obj===e){t.list.splice(r,1),i.rel_fn&&this._modelUnbindRelatationalInfo(n,i),i.model&&i.model(null);return}}}},t.prototype._onModelLoaded=function(t){var n,r,i,s,o,u,a,f;s=e.RelationalModel&&t instanceof e.RelationalModel,this.m=t,f=this.__kb.callbacks;for(r in f){n=f[r],t.bind(r,n.fn),o=n.list;for(u=0,a=o.length;u<a;u++)i=o[u],s&&this._modelBindRelatationalInfo(r,i),i.model&&i.model(t)}return this},t.prototype._onModelUnloaded=function(e){var t,n,r,i,s,o,u;this.m=null,u=this.__kb.callbacks;for(n in u){t=u[n],e.unbind(n,t.fn),i=t.list;for(s=0,o=i.length;s<o;s++)r=i[s],r.rel_fn&&this._modelUnbindRelatationalInfo(n,r),r.model&&r.model(null)}return this},t.prototype._modelBindRelatationalInfo=function(e,t){var n,r;if(e==="change"&&t.key&&t.update){n=s.utils.unwrapObservable(t.key),r=f.find(this.m.getRelations(),function(e){return e.key===n});if(!r)return;t.rel_fn=function(){return t.update()},r.collectionKey?(t.is_collection=!0,this.m.bind("add:"+t.key,t.rel_fn),this.m.bind("remove:"+t.key,t.rel_fn)):this.m.bind("update:"+t.key,t.rel_fn)}return this},t.prototype._modelUnbindRelatationalInfo=function(e,t){if(!t.rel_fn)return;return t.is_collection?(this.m.unbind("add:"+t.key,t.rel_fn),this.m.unbind("remove:"+t.key,t.rel_fn)):this.m.unbind("update:"+t.key,t.rel_fn),t.rel_fn=null,this},t}(),i.modelObservable=function(e,t){return new i.ModelWatcher(e,t)},i.CollectionObservable=function(){function e(e,t){var n,r,o;return t||(t={}),!i.statistics||i.statistics.register(this),o=i.utils.wrappedObservable(this,s.observableArray([])),o.__kb_is_co=!0,this.in_edit=0,this.__kb||(this.__kb={}),this.__kb._onCollectionReset=f.bind(this._onCollectionReset,this),this.__kb._onCollectionResort=f.bind(this._onCollectionResort,this),this.__kb._onModelAdd=f.bind(this._onModelAdd,this),this.__kb._onModelRemove=f.bind(this._onModelRemove,this),this.__kb._onModelChange=f.bind(this._onModelChange,this),t.options&&(t=f.defaults(f.clone(t),t.options)),i.Store.useOptionsOrCreate(t,e,o),r=i.utils.wrappedFactory(o,new i.Factory(t.factory)),t.factories&&r.addPathMappings(t.factories,t.path),this.models_path=i.utils.pathJoin(t.path,"models"),n=r.creatorForPath(null,this.models_path),n?this.models_only=n.models_only:t.hasOwnProperty("models_only")?t.models_only?(r.addPathMapping(this.models_path,{models_only:t.models_only}),this.models_only=t.models_only):r.addPathMapping(this.models_path,i.ViewModel):t.view_model?r.addPathMapping(this.models_path,t.view_model):t.create?r.addPathMapping(this.models_path,{create:t.create}):r.addPathMapping(this.models_path,i.ViewModel),this.sort_attribute=t.sort_attribute,this.sorted_index=t.sorted_index,o.destroy=f.bind(this.destroy,this),o.collection=f.bind(this.collection,this),o.viewModelByModel=f.bind(this.viewModelByModel,this),o.sortedIndex=f.bind(this.sortedIndex,this),o.sortAttribute=f.bind(this.sortAttribute,this),o.hasViewModels=f.bind(this.hasViewModels,this),o.bind=f.bind(this.bind,this),o.unbind=f.bind(this.unbind,this),o.trigger=f.bind(this.trigger,this),i.utils.wrappedObject(o,null),e&&this.collection(e,{silent:!0,defer:t.defer}),o.subscribe(f.bind(this._onObservableArrayChange,this)),o}return e.prototype.destroy=function(){var e,t;return t=i.utils.wrappedObservable(this),e=i.utils.wrappedObject(t),e&&(this._collectionUnbind(e),this._clear(!0),i.utils.wrappedObject(t,null)),i.utils.wrappedDestroy(this),!i.statistics||i.statistics.unregister(this)},e.prototype.collection=function(e,t){var n,r;return n=i.utils.wrappedObservable(this),r=i.utils.wrappedObject(n),arguments.length===0||e===r?(n(),r):(e&&e.retain&&e.retain(),r&&(this._collectionUnbind(r),r.release&&r.release()),i.utils.wrappedObject(n,e),e?(this._collectionBind(e),this.sortedIndex(this.sorted_index,this.sort_attribute,t)):this._clear(),e)},e.prototype.sortedIndex=function(e,t,n){var r,s=this;return n||(n={}),e?(this.sorted_index=e,this.sort_attribute=t):t?(this.sort_attribute=t,this.sorted_index=this._sortAttributeFn(t)):(this.sort_attribute=null,this.sorted_index=null),r=function(){var e,t;t=i.utils.wrappedObservable(s),e=i.utils.wrappedObject(t);if(e.models.length===0&&t().length===0)return;s._collectionResync(!0);if(!n.silent)return s.trigger("resort",t())},n.defer?f.defer(r):r(),this},e.prototype.sortAttribute=function(e,t,n){return this.sortedIndex(t,e,n)},e.prototype.viewModelByModel=function(e){var t;return this.hasViewModels()?(t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid",f.find(i.utils.wrappedObservable(this)(),function(n){return n.__kb.object[t]===e[t]})):null},e.prototype.hasViewModels=function(){return!this.models_only},e.prototype._collectionBind=function(e){var t,n,r,i,s,o,u;e.bind("reset",this.__kb._onCollectionReset),this.sorted_index||e.bind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.bind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.bind(t,this.__kb._onModelRemove);return e.bind("change",this.__kb._onModelChange)},e.prototype._collectionUnbind=function(e){var t,n,r,i,s,o,u;e.unbind("reset",this.__kb._onCollectionReset),this.sorted_index||e.unbind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.unbind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.unbind(t,this.__kb._onModelRemove);return e.unbind("change",this.__kb._onModelChange)},e.prototype._onCollectionReset=function(){if(this.in_edit)return;return this._collectionResync()},e.prototype._onCollectionResort=function(e){return!this.sorted_index||a(this,"sorted_index"),f.isArray(e)?this.trigger("resort",i.utils.wrappedObservable(this)()):this._onModelResort(e),this},e.prototype._onModelAdd=function(e){var t,n,r,s;return s=this._createViewModel(e),r=i.utils.wrappedObservable(this),n=i.utils.wrappedObject(r),t=this.sorted_index?this.sorted_index(r(),s):n.indexOf(e),this.in_edit++,r.splice(t,0,s),this.in_edit--,this.trigger("add",s,r())},e.prototype._onModelRemove=function(e){var t,n;n=this.hasViewModels()?this.viewModelByModel(e):e;if(!n)return;t=i.utils.wrappedObservable(this),this.in_edit++,t.remove(n),this.in_edit--,this.trigger("remove",n,t);if(this.hasViewModels())return i.utils.wrappedStore(t).releaseObservable(n,i.utils.wrappedStoreIsOwned(t))},e.prototype._onModelChange=function(e){if(this.sorted_index&&(!this.sort_attribute||e.hasChanged(this.sort_attribute)))return this._onModelResort(e)},e.prototype._onModelResort=function(e){var t,n,r,s,o,u;r=i.utils.wrappedObservable(this),t=i.utils.wrappedObject(r),u=this.hasViewModels()?this.viewModelByModel(e):e,s=r.indexOf(u),this.sorted_index?(o=f.clone(r()),o.splice(s,1),n=this.sorted_index(o,u)):n=t.indexOf(e);if(s===n)return;return this.in_edit++,r.splice(s,1),r.splice(n,0,u),this.in_edit--,this.trigger("resort",u,r(),n)},e.prototype._onObservableArrayChange=function(e){var t,n;if(this.in_edit)return;return n=i.utils.wrappedObservable(this),t=i.utils.wrappedObject(n),this.in_edit++,t.reset(f.map(e,function(e){return i.utils.wrappedModel(e)})),this.in_edit--},e.prototype._clear=function(e){var t,n,r,s,o,u,a;n=i.utils.wrappedObservable(this),e||this.trigger("remove",n()),this.in_edit++,e?(t=n(),o=t.slice(0),t.splice(0,t.length)):o=n.removeAll(),this.in_edit--;if(!this.hasViewModels())return;r=i.utils.wrappedStore(n);for(u=0,a=o.length;u<a;u++)s=o[u],r.releaseObservable(s,i.utils.wrappedStoreIsOwned(n));return this},e.prototype._collectionResync=function(e){var t,n,r,s,o,u,a,l,c,h=this;this._clear(e),s=i.utils.wrappedObservable(this),n=i.utils.wrappedObject(s);if(this.sorted_index){u=[],c=n.models;for(a=0,l=c.length;a<l;a++)r=c[a],o=this._createViewModel(r),t=this.sorted_index(u,o),u.splice(t,0,o)}else u=this.hasViewModels()?f.map(n.models,function(e){return h._createViewModel(e)}):f.clone(n.models);this.in_edit++,s(u),this.in_edit--;if(!e)return this.trigger("add",s())},e.prototype._sortAttributeFn=function(e){return this.hasViewModels()?function(t,n){return f.sortedIndex(t,n,function(t){return i.utils.wrappedModel(t).get(e)})}:function(t,n){return f.sortedIndex(t,n,function(t){return t.get(e)})}},e.prototype._createViewModel=function(e){var t;return t=i.utils.wrappedObservable(this),this.hasViewModels()?i.utils.wrappedStore(t).findOrCreateObservable(e,this.models_path,i.utils.wrappedFactory(t)):e},e}(),h(i.CollectionObservable.prototype,e.Events),i.collectionObservable=function(e,t){return new i.CollectionObservable(e,t)},i.sortedIndexWrapAttr=i.siwa=function(e,t){return function(n,r){return f.sortedIndex(n,r,function(n){return new t(i.utils.wrappedModel(n).get(e))})}},i.DefaultWrapper=function(){function e(e,t){var n,r=this;return this.dv=t,n=i.utils.wrappedObservable(this,s.dependentObservable({read:function(){var t;return(t=s.utils.unwrapObservable(e()))?t:s.utils.unwrapObservable(r.dv)},write:function(t){return e(t)}})),n.destroy=f.bind(this.destroy,this),n.setToDefault=f.bind(this.setToDefault,this),n}return e.prototype.destroy=function(){return i.utils.wrappedDestroy(this)},e.prototype.setToDefault=function(){return i.utils.wrappedObservable(this)(this.dv)},e}(),i.defaultWrapper=function(e,t){return new i.DefaultWrapper(e,t)},i.toFormattedString=function(e){var t,r,i,o,u,a;u=e.slice(),r=n.call(arguments,1);for(i in r){t=r[i],a=s.utils.unwrapObservable(t),a||(a=""),o=e.indexOf("{"+i+"}");while(o>=0)u=u.replace("{"+i+"}",a),o=e.indexOf("{"+i+"}",o+1)}return u},i.parseFormattedString=function(e,t){var n,r,i,s,o,u,a,l,c,h,p,d;h=t.slice(),i=0,u=0,l={};while(h.search("\\{"+i+"\\}")>=0){a=t.indexOf("{"+i+"}");while(a>=0)h=h.replace("{"+i+"}","(.*)"),l[a]=i,u++,a=t.indexOf("{"+i+"}",a+1);i++}n=i,c=new RegExp(h),o=c.exec(e),o&&o.shift();if(!o||o.length!==u)return f.range(n).map(function(){return""});d=f.sortBy(f.keys(l),function(e,t){return parseInt(e,10)}),r={};for(s in d){a=d[s],i=l[a];if(r.hasOwnProperty(i))continue;r[i]=s}p=[],i=0;while(i<n)p.push(o[r[i]]),i++;return p},i.FormattedObservable=function(){function e(e,t){var r,o;return f.isArray(t)?(e=e,o=t):o=n.call(arguments,1),r=i.utils.wrappedObservable(this,s.dependentObservable({read:function(){var n,r,u;t=[s.utils.unwrapObservable(e)];for(r=0,u=o.length;r<u;r++)n=o[r],t.push(s.utils.unwrapObservable(n));return i.toFormattedString.apply(null,t)},write:function(t){var n,r,u;r=i.parseFormattedString(t,s.utils.unwrapObservable(e)),u=Math.min(o.length,r.length),n=0;while(n<u)o[n](r[n]),n++;return this}})),r}return e.prototype.destroy=function(){return i.utils.wrappedDestroy(this)},e}(),i.formattedObservable=function(e,t){return new i.FormattedObservable(e,n.call(arguments,1))},i.LocalizedObservable=function(){function t(e,t,n){var r,o=this;return this.value=e,this.vm=n,t||(t={}),this.vm||(this.vm={}),this.read||u(this,"read"),i.locale_manager||u(this,"kb.locale_manager"),this.__kb||(this.__kb={}),this.__kb._onLocaleChange=f.bind(this._onLocaleChange,this),this.__kb._onChange=t.onChange,this.value&&(e=s.utils.unwrapObservable(this.value)),this.vo=s.observable(e?this.read(e,null):null),r=i.utils.wrappedObservable(this,s.dependentObservable({read:function(){return o.value&&s.utils.unwrapObservable(o.value),o.vo(),o.read(s.utils.unwrapObservable(o.value))},write:function(e){o.write||a(o,"writing to read-only"),o.write(e,s.utils.unwrapObservable(o.value)),o.vo(e);if(o.__kb._onChange)return o.__kb._onChange(e)},owner:this.vm})),r.destroy=f.bind(this.destroy,this),r.observedValue=f.bind(this.observedValue,this),r.resetToCurrent=f.bind(this.resetToCurrent,this),i.locale_manager.bind("change",this.__kb._onLocaleChange),t.hasOwnProperty("default")&&(r=s.defaultWrapper(r,t["default"])),r}return t.extend=e.Model.extend,t.prototype.destroy=function(){return i.locale_manager.unbind("change",this.__kb._onLocaleChange),this.vm=null,i.utils.wrappedDestroy(this)},t.prototype.resetToCurrent=function(){var e;return this.vo(null),e=this.value?this.read(s.utils.unwrapObservable(this.value)):null,i.utils.wrappedObservable(this)(e)},t.prototype.observedValue=function(e){return arguments.length===0?this.value:(this.value=e,this._onLocaleChange(),this)},t.prototype._onLocaleChange=function(){var e;e=this.read(s.utils.unwrapObservable(this.value)),this.vo(e);if(this.__kb._onChange)return this.__kb._onChange(e)},t}(),i.localizedObservable=function(e,t,n){return new i.LocalizedObservable(e,t,n)},i.Observable=function(){function t(e,t,n){var r,o,a=this;return this.vm=n,t||u(this,"options"),this.vm||(this.vm={}),t.options&&(t=f.defaults(f.clone(t),t.options),delete t.options),this.key=f.isString(t)||s.isObservable(t)?t:t.key,this.key||u(this,"key"),this.args=t.args,this.read=t.read,this.write=t.write,this.vo=s.observable(null),o=i.utils.wrappedObservable(this,s.dependentObservable({read:function(){var e,t,n,r,i,o;t=[s.utils.unwrapObservable(a.key)];if(a.args)if(f.isArray(a.args)){o=a.args;for(r=0,i=o.length;r<i;r++)e=o[r],t.push(s.utils.unwrapObservable(e))}else t.push(s.utils.unwrapObservable(a.args));return a.m&&(n=a.read?a.read.apply(a.vm,t):a.m.get.apply(a.m,t),a.update(n)),s.utils.unwrapObservable(a.vo())},write:function(e){var t,n,r,i,o,u;r={},r[s.utils.unwrapObservable(a.key)]=e,n=a.write?[e]:[r];if(a.args)if(f.isArray(a.args)){u=a.args;for(i=0,o=u.length;i<o;i++)t=u[i],n.push(s.utils.unwrapObservable(t))}else n.push(s.utils.unwrapObservable(a.args));return a.m&&(a.write?a.write.apply(a.vm,n):a.m.set.apply(a.m,n)),a.update(e)},owner:this.vm})),o.__kb_is_o=!0,i.utils.wrappedStore(o,t.store),this.path=i.utils.pathJoin(t.path,this.key),t.factories&&(typeof t.factories=="function"||t.factories.create)?(r=i.utils.wrappedFactory(o,new i.Factory(t.factory)),r.addPathMapping(this.path,t.factories)):i.Factory.useOptionsOrCreate(t,o,this.path),o.valueType=f.bind(this.valueType,this),o.destroy=f.bind(this.destroy,this),i.ModelWatcher.useOptionsOrCreate(t,e,this,{model:f.bind(this.model,this),update:f.bind(this.update,this),key:this.key}),t.localizer&&(o=new t.localizer(o)),t.hasOwnProperty("default")&&(o=i.defaultWrapper(o,t["default"])),o}return t.prototype.destroy=function(){return i.release(this.value),this.value=null,i.utils.wrappedDestroy(this)},t.prototype.model=function(e){if(arguments.length===0||this.m===e)return this.m;if(this.m=e)return this.update()},t.prototype.update=function(e){var t,n;n=this.vo(),this.m&&!arguments.length&&(e=this.m.get(s.utils.unwrapObservable(this.key))),e||(e=null),t=i.utils.valueType(e);if(f.isUndefined(this.value_type)||this.value_type!==t&&t!==i.TYPE_UNKNOWN)return this._updateValueObservable(e);if(this.value_type===i.TYPE_MODEL){if(typeof n.model=="function"){if(n.model()!==e)return n.model(e)}else if(i.utils.wrappedObject(n)!==e)return this._updateValueObservable(e)}else if(this.value_type===i.TYPE_COLLECTION){if(n.collection()!==e)return n.collection(e)}else if(n()!==e)return n(e)},t.prototype.valueType=function(){var e;return e=this.m?this.m.get(this.key):null,this.value_type||this._updateValueObservable(e),this.value_type},t.prototype._updateValueObservable=function(t){var n,r,o,u,a,l,c,h;return u=i.utils.wrappedObservable(this),c=i.utils.wrappedStore(u),r=i.utils.wrappedFactory(u),n=r.creatorForPath(t,this.path),!n&&this.m&&e.RelationalModel&&this.m instanceof e.RelationalModel&&(o=s.utils.unwrapObservable(this.key),l=f.find(this.m.getRelations(),function(e){return e.key===o}),l&&(n=l.collectionKey?i.CollectionObservable:i.ViewModel)),c?h=c.findOrCreateObservable(t,this.path,r,n):n?h=r.createForPath(t,this.path,c,n):h=s.observable(t),s.isObservable(h)?h.__kb_is_co?this.value_type=i.TYPE_COLLECTION:this.value_type=i.TYPE_SIMPLE:(this.value_type=i.TYPE_MODEL,typeof h.model!="function"&&i.utils.wrappedObject(h,t)),a=this.value,this.value=h,a&&(c?c.releaseObservable(a):i.release(a)),this.vo(h)},t}(),i.observable=function(e,t,n){return new i.Observable(e,t,n)},i.TriggeredObservable=function(){function e(e,t){var n,r=this;return this.event_name=t,e||u(this,"model"),this.event_name||u(this,"event_name"),this.vo=s.observable(),n=i.utils.wrappedObservable(this,s.dependentObservable(function(){return r.vo()})),n.destroy=f.bind(this.destroy,this),i.utils.wrappedModelWatcher(this,new i.ModelWatcher(e,this,{model:f.bind(this.model,this),update:f.bind(this.update,this),event_name:this.event_name})),n}return e.prototype.destroy=function(){return i.utils.wrappedDestroy(this)},e.prototype.model=function(e){if(arguments.length===0||this.m===e)return this.m;if(this.m=e)return this.update()},e.prototype.update=function(){if(!this.m)return;return this.vo()!==this.m?this.vo(this.m):this.vo.valueHasMutated()},e}(),i.triggeredObservable=function(e,t){return new i.TriggeredObservable(e,t)},i.ViewModel=function(e){function t(e,n,r){var s,o,u,a,l,c,h;n||(n={}),r||(r={}),t.__super__.constructor.apply(this,arguments),!i.statistics||i.statistics.register(this),n.options&&(n=f.defaults(f.clone(n),n.options)),f.isArray(n)&&(n={keys:n}),this.__kb||(this.__kb={}),this.__kb.vm_keys={},this.__kb.model_keys={},this.__kb.view_model=f.isUndefined(r)?this:r,this.__kb.internals=n.internals,i.Store.useOptionsOrCreate(n,e,this),this.__kb.path=n.path,i.Factory.useOptionsOrCreate(n,this,n.path),l=i.utils.wrappedModelWatcher(this,new i.ModelWatcher(e,this,{model:f.bind(this.model,this)}));if(n.keys)if(f.isArray(n.keys))o=this.__kb.keys=n.keys;else{u={},h=n.keys;for(c in h)a=h[c],u[f.isString(a)?a:a.key?a.key:c]=!0;this.__kb.keys=f.keys(u)}else s=l.model(),s&&s.attributes&&(o=f.keys(s.attributes));this.__kb.internals&&(o=o?f.union(o,this.__kb.internals):this.__kb.internals),n.requires&&f.isArray(n.requires)&&(o=o?f.union(o,n.requires):n.requires),f.isObject(n.keys)&&!f.isArray(n.keys)&&this._mapObservables(e,n.keys),f.isObject(n.requires)&&!f.isArray(n.requires)&&this._mapObservables(e,n.requires),!n.mappings||this._mapObservables(e,n.mappings),!o||this._createObservables(e,o)}return h(t,e),t.prototype.releaseReferences=function(){var e;this.__kb.references_released=!0;if(this.__kb.view_model!==this)for(e in this.__kb.vm_keys)this.__kb.view_model[e]=null;return this.__kb.view_model=null,i.release(this,!0)},t.prototype.__destroy=function(){return this.__kb.references_released||this.releaseReferences(),i.utils.wrappedDestroy(this),t.__super__.__destroy.apply(this,arguments),!i.statistics||i.statistics.unregister(this)},t.prototype.model=function(e){var t,n,r;n=i.utils.wrappedObject(this);if(arguments.length===0||n===e)return n;i.utils.wrappedObject(this,e),r=i.utils.wrappedModelWatcher(this);if(!r)return;r.model(e);if(this.__kb.keys||!e||!e.attributes)return;t=f.difference(f.keys(e.attributes),f.keys(this.__kb.model_keys));if(t)return this._createObservables(e,t)},t.prototype.setToDefault=function(){var e;for(e in this.__kb.vm_keys)typeof this[e].setToDefault=="function"&&this[e].setToDefault();return this},t.prototype._createObservables=function(e,t){var n,r,s,o,u;r={store:i.utils.wrappedStore(this),factory:i.utils.wrappedFactory(this),path:this.__kb.path,model_watcher:i.utils.wrappedModelWatcher(this)};for(o=0,u=t.length;o<u;o++){n=t[o],s=this.__kb.internals&&f.contains(this.__kb.internals,n)?"_"+n:n;if(this[s])continue;this.__kb.vm_keys[s]=!0,this.__kb.model_keys[n]=!0,r.key=n,this[s]=this.__kb.view_model[s]=i.observable(e,r,this)}return this},t.prototype._mapObservables=function(e,t){var n,r,s;r={store:i.utils.wrappedStore(this),factory:i.utils.wrappedFactory(this),path:this.__kb.path,model_watcher:i.utils.wrappedModelWatcher(this)};for(s in t){n=t[s];if(this[s])continue;n=f.isString(n)?{key:n}:f.clone(n),n.key||(n.key=s),this.__kb.vm_keys[s]=!0,this.__kb.model_keys[n.key]=!0,this[s]=this.__kb.view_model[s]=i.observable(e,f.defaults(n,r),this)}return this},t}(i.RefCountable),i.viewModel=function(e,t,n){return new i.ViewModel(e,t,n)},i.observables=function(e,t,n){return o("ko.observables","0.16.0","Please use kb.viewModel instead"),new i.ViewModel(e,t,n)}}).call(this);