// Generated by CoffeeScript 1.3.3
/*
  knockback.js 0.16.0beta2
  (c) 2011, 2012 Kevin Malakoff.
  Knockback.js is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/knockback/blob/master/LICENSE
  Dependencies: Knockout.js, Backbone.js, and Underscore.js.
    Optional dependency: Backbone.ModelRef.js.
*/(function(){var e,t,n,r,i,s=function(e,t){return function(){return e.apply(t,arguments)}},o={}.hasOwnProperty,u=function(e,t){function r(){this.constructor=e}for(var n in t)o.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};if(typeof require!="undefined")try{i=require("lodash")}catch(a){i=require("underscore")}else i=this._;i&&i.hasOwnProperty("_")&&(i=i._),e=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,r=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko,t=n=this.Knockback=this.kb=typeof exports!="undefined"?exports:{},n.VERSION="0.16.0beta2",n.locale_manager=void 0,n.TYPE_UNKNOWN=0,n.TYPE_SIMPLE=1,n.TYPE_MODEL=2,n.TYPE_COLLECTION=3,n.release=function(e,t){var s,o;if(!e)return!1;if(!t&&(r.isObservable(e)||typeof e.release=="function"||typeof e.destroy=="function"))return e.release?(!e.refCount||e.refCount()>0)&&e.release():e.destroy?(!e.hasOwnProperty("__kb")||e.__kb)&&e.destroy():e.dispose&&e.dispose(),!0;if(i.isObject(e)&&typeof e!="function"){for(s in e){o=e[s];if(!o||s==="__kb"||typeof o=="function"&&!r.isObservable(o))continue;n.release(o)&&(e[s]=null)}return!0}return!1},n.legacyWarning=function(e,t,r){var i;return n._legacy_warnings||(n._legacy_warnings={}),(i=n._legacy_warnings)[e]||(i[e]=0),n._legacy_warnings[e]++,console.warn("warning: '"+e+"' has been deprecated (will be removed in Knockback after "+t+"). "+r+".")},n.throwMissing=function(e,t){throw""+e.constructor.name+": "+t+" is missing"},n.throwUnexpected=function(e,t){throw""+e.constructor.name+": "+t+" is unexpected"},n.utils={},n.utils.wrappedDestroy=function(e){var t;if(!e.__kb)return;return e.__kb.model_watcher&&e.__kb.model_watcher.releaseCallbacks(e),t=e.__kb,e.__kb=null,t.observable&&n.utils.wrappedDestroy(t.observable),t.factory=null,t.model_watcher_is_owned&&t.model_watcher.destroy(),t.model_watcher=null,t.store_is_owned&&t.store.destroy(),t.store=null,n.release(t,!0)},n.utils.wrappedByKey=function(e,t,n){if(arguments.length===2)return e&&e.__kb&&e.__kb.hasOwnProperty(t)?e.__kb[t]:void 0;if(!e)throw"Knockback: no owner for wrapping "+t;return e.__kb||(e.__kb={}),e.__kb[t]=n,n},n.utils.wrappedObservable=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"observable"):(n.utils.wrappedByKey(e,"observable",t),t&&n.utils.wrappedByKey(t,"instance",e),t)},n.utils.wrappedModel=function(e,t){var r;return arguments.length===1?(r=n.utils.wrappedByKey(e,"object"),i.isUndefined(r)?e:r):n.utils.wrappedByKey(e,"object",t)},n.utils.wrappedObject=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"object"):n.utils.wrappedByKey(e,"object",t)},n.utils.wrappedStore=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"store"):n.utils.wrappedByKey(e,"store",t)},n.utils.wrappedStoreIsOwned=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"store_is_owned"):n.utils.wrappedByKey(e,"store_is_owned",t)},n.utils.wrappedFactory=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"factory"):n.utils.wrappedByKey(e,"factory",t)},n.utils.wrappedPath=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"path"):n.utils.wrappedByKey(e,"path",t)},n.utils.wrappedModelWatcher=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"model_watcher"):n.utils.wrappedByKey(e,"model_watcher",t)},n.utils.wrappedModelWatcherIsOwned=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"model_watcher_is_owned"):n.utils.wrappedByKey(e,"model_watcher_is_owned",t)},n.utils.setToDefault=function(e){var t,s;if(!e)return;if(r.isObservable(e))typeof e.setToDefault=="function"&&e.setToDefault();else if(i.isObject(e))for(t in e)s=e[t],s&&t!=="__kb"&&n.utils.setToDefault(s);return e},n.utils.release=function(e,t){return n.legacyWarning("kb.utils.release","0.16.0","Please use kb.release instead"),n.release(e,t)},n.utils.valueType=function(t){var r;return t?t instanceof n.ViewModel?n.TYPE_MODEL:!t.__kb||!t.__kb.instance?t instanceof e.Model?n.TYPE_MODEL:t instanceof e.Collection?n.TYPE_COLLECTION:n.TYPE_SIMPLE:(r=t.__kb.instance,r instanceof n.Observable?t.valueType():r instanceof n.CollectionObservable?n.TYPE_COLLECTION:n.TYPE_SIMPLE):n.TYPE_UNKNOWN},n.utils.observableInstanceOf=function(e,t){return e?!e.__kb||!e.__kb.instance?!1:e.__kb.instance instanceof t:!1},n.utils.pathJoin=function(e,t){var n;return e?n=e[e.length-1]!=="."?""+e+".":e:n="",n+=t,n},n.utils.optionsPathJoin=function(e,t){return i.defaults({path:n.utils.pathJoin(e.path,t)},e)},n.RefCountable=function(){function t(){this.__kb_ref_count=1}return t.extend=e.Model.extend,t.prototype.__destroy=function(){},t.prototype.retain=function(){if(this.__kb_ref_count<=0)throw"RefCountable: ref count is corrupt: "+this.__kb_ref_count;return this.__kb_ref_count++,this},t.prototype.release=function(e){if(this.__kb_ref_count<=0)throw"RefCountable: ref count is corrupt: "+this.__kb_ref_count;return e?this.__kb_ref_count=0:this.__kb_ref_count--,this.__kb_ref_count||this.__destroy(),this},t.prototype.refCount=function(){return this.__kb_ref_count},t}(),n.Factory=function(){function t(e){this.parent_factory=e,this.paths={}}return t.useOptionsOrCreate=function(e,t,r){var i;return e.factory&&!e.factories?i=n.utils.wrappedFactory(t,e.factory):i=n.utils.wrappedFactory(t,new n.Factory(e.factory)),e.factories&&i.addPathMappings(e.factories,r),i},t.prototype.hasPath=function(e){return this.paths.hasOwnProperty(e)||this.parent_factory&&this.parent_factory.hasPath(e)},t.prototype.addPathMapping=function(e,t){return this.paths[e]=t},t.prototype.addPathMappings=function(e,t){var r,i;for(i in e)r=e[i],this.paths[n.utils.pathJoin(t,i)]=r;return this},t.prototype.creatorForPath=function(t,r){var i;i=this.paths[r];if(i)return i.view_model?i.view_model:i;if(this.parent_factory){i=this.parent_factory.creatorForPath(t,r);if(i)return i}return t instanceof e.Model?n.ViewModel:t instanceof e.Collection?n.CollectionObservable:null},t.prototype.createForPath=function(e,t,i,s){s||(s=this.creatorForPath(e,t));if(!s)return r.observable(e);if(s.hasOwnProperty("models_only"))return e(s.models_only);if(typeof s=="function")return new s(e,{store:i,factory:this,path:t,creator:s});if(s.create)return s.create(e,{store:i,factory:this,path:t,creator:s});throw"unrecognized creator for "+t},t.createDefault=function(t,i){return t instanceof e.Model?n.viewModel(t,i):t instanceof e.Collection?n.collectionObservable(t,i):r.observable(t)},t}(),n.Store=function(){function t(){this.objects=[],this.observables=[]}return t.useOptionsOrCreate=function(e,t,r){var i;return e.store?(i=n.utils.wrappedStore(r,e.store),e.store.registerObservable(t,r,e)):(i=n.utils.wrappedStore(r,new n.Store),n.utils.wrappedStoreIsOwned(r,!0)),i},t.prototype.destroy=function(){var e,t,r;r=this.observables;for(e in r){t=r[e];if(!t)continue;this.observables[e]=null,t.release?t.release(!0):n.release(t)}return this.objects=null,this.observables=null},t.prototype.registerObservable=function(e,t,i){i==null&&(i={});if(!e||!t)return;if(n.utils.observableInstanceOf(t,n.CollectionObservable)||r.isObservable(t))return;return this.objects.push(e),n.utils.wrappedObject(t,e),this.observables.push(t),typeof t.retain=="function"&&t.retain(),t.__kb||(t.__kb={}),i.creator?t.__kb.creator=i.creator:i.path&&i.factory?t.__kb.creator=i.factory.creatorForPath(e,i.path):t.__kb.creator=null},t.prototype.findOrCreateObservable=function(t,s,o,u){var a,f,l,c,h,p;if(!o)f=u?u(t,{path:s,store:this,creator:u}):n.Factory.createDefault(t,{path:s,store:this});else{u||(u=o.creatorForPath(t,s));if(!u)return r.observable(t);if(u.models_only)return t;if(t&&!(t instanceof e.Collection)){p=this.objects;for(a=c=0,h=p.length;c<h;a=++c){l=p[a],f=this.observables[a];if(!f||!f.__kb)continue;if(l===t&&f.__kb.creator===u)return typeof f.retain=="function"&&f.retain(),f}}f=o.createForPath(t,s,this,u),f||(f=r.observable(null))}return a=i.indexOf(this.observables,f),a<0&&this.registerObservable(t,f,{creator:u}),f},t.prototype.releaseObservable=function(e,t){var r;if(!e)return;if(arguments.length===2&&!t&&!e.release)return;n.release(e);if(e.refCount&&e.refCount()>0)return;n.utils.wrappedObject(e,null),r=i.indexOf(this.observables,e);if(r<0)return;return this.objects||(this.objects[r]=null),this.observables[r]=null},t}(),n.ModelWatcher=function(){function t(e,t,r){this._onModelUnloaded=s(this._onModelUnloaded,this),this._onModelLoaded=s(this._onModelLoaded,this),this.__kb||(this.__kb={}),this.__kb.callbacks={},this.__kb._onModelLoaded=i.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=i.bind(this._onModelUnloaded,this),r&&this.registerCallbacks(t,r),e?this.model(e):n.utils.wrappedObject(this,null)}return t.useOptionsOrCreate=function(e,t,r,i){var s;return e.model_watcher?(e.model_watcher.model()!==t&&e.model_watcher.model_ref!==t&&n.throwUnexpected(this,"model not matching"),s=n.utils.wrappedModelWatcher(r,e.model_watcher)):(s=n.utils.wrappedModelWatcher(r,new n.ModelWatcher(t)),n.utils.wrappedModelWatcherIsOwned(r,!0)),s.registerCallbacks(r,i),s},t.prototype.destroy=function(){return this.model(null),this.__kb.callbacks=null,n.utils.wrappedDestroy(this)},t.prototype.model=function(t){var r,i,s,o,u,a,f,l;u=n.utils.wrappedObject(this);if(arguments.length===0||u===t)return u;this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),e.ModelRef&&t instanceof e.ModelRef?(this.model_ref=t,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),t=this.model_ref.model()):delete this.model_ref,n.utils.wrappedObject(this,t),l=this.__kb.callbacks;for(i in l){r=l[i],u&&u.unbind(i,r.fn),t&&t.bind(i,r.fn),o=r.list;for(a=0,f=o.length;a<f;a++)s=o[a],s.model&&s.model(t)}return t},t.prototype.registerCallbacks=function(t,i){var s,o,u,a,f;t||n.throwMissing(this,"obj"),i||n.throwMissing(this,"options"),f=n.utils.wrappedObject(this),o=i.event_name?i.event_name:"change",s=this.__kb.callbacks[o],s||(a=[],s={list:a,fn:function(e){var t,n,i;for(n=0,i=a.length;n<i;n++){t=a[n];if(!t.update)continue;if(e&&t.key&&e.hasChanged&&!e.hasChanged(r.utils.unwrapObservable(t.key)))continue;t.update()}return null}},this.__kb.callbacks[o]=s,f&&f.bind(o,s.fn)),u={},u.obj=t,i.model&&(u.model=i.model),i.update&&(u.update=i.update),i.key&&(u.key=i.key),s.list.push(u);if(!f)return;return e.RelationalModel&&f instanceof e.RelationalModel&&this._modelBindRelatationalInfo(f,o,u),u.model(f)&&u.model},t.prototype.releaseCallbacks=function(e){var t,r,i,s,o,u,a;if(!this.__kb.callbacks)return;o=n.utils.wrappedObject(this),u=this.__kb.callbacks;for(r in u){t=u[r],a=t.list;for(i in a){s=a[i];if(s.obj===e){t.list.splice(i,1),s.rel_fn&&this._modelUnbindRelatationalInfo(o,r,s),s.model&&s.model(null);return}}}},t.prototype._onModelLoaded=function(t){var r,i,s,o,u,a,f,l;o=e.RelationalModel&&t instanceof e.RelationalModel,n.utils.wrappedObject(this,t),l=this.__kb.callbacks;for(i in l){r=l[i],t.bind(i,r.fn),u=r.list;for(a=0,f=u.length;a<f;a++)s=u[a],o&&this._modelBindRelatationalInfo(t,i,s),s.model&&s.model(t)}return this},t.prototype._onModelUnloaded=function(e){var t,r,i,s,o,u,a;n.utils.wrappedObject(this,null),a=this.__kb.callbacks;for(r in a){t=a[r],e.unbind(r,t.fn),s=t.list;for(o=0,u=s.length;o<u;o++)i=s[o],i.rel_fn&&this._modelUnbindRelatationalInfo(e,r,i),i.model&&i.model(null)}return this},t.prototype._modelBindRelatationalInfo=function(e,t,n){var s,o;if(t==="change"&&n.key&&n.update){s=r.utils.unwrapObservable(n.key),o=i.find(e.getRelations(),function(e){return e.key===s});if(!o)return;n.rel_fn=function(){return n.update()},o.collectionKey?(n.is_collection=!0,e.bind("add:"+n.key,n.rel_fn),e.bind("remove:"+n.key,n.rel_fn)):e.bind("update:"+n.key,n.rel_fn)}return this},t.prototype._modelUnbindRelatationalInfo=function(e,t,n){if(!n.rel_fn)return;return n.is_collection?(e.unbind("add:"+n.key,n.rel_fn),e.unbind("remove:"+n.key,n.rel_fn)):e.unbind("update:"+n.key,n.rel_fn),n.rel_fn=null,this},t}(),n.modelObservable=function(e,t){return new n.ModelWatcher(e,t)},n.CollectionObservable=function(){function e(e,t){var s,o;return t==null&&(t={}),n.statistics&&n.statistics.register("kb.CollectionObservable",this),o=n.utils.wrappedObservable(this,r.observableArray([])),this.in_edit=0,this.__kb||(this.__kb={}),this.__kb._onCollectionReset=i.bind(this._onCollectionReset,this),this.__kb._onCollectionResort=i.bind(this._onCollectionResort,this),this.__kb._onModelAdd=i.bind(this._onModelAdd,this),this.__kb._onModelRemove=i.bind(this._onModelRemove,this),this.__kb._onModelChange=i.bind(this._onModelChange,this),t.options&&(t=i.defaults(i.clone(t),t.options)),n.Store.useOptionsOrCreate(t,e,o),n.utils.wrappedPath(o,t.path),s=n.utils.wrappedFactory(o,new n.Factory(t.factory)),t.factories&&s.addPathMappings(t.factories,t.path),this.models_path=n.utils.pathJoin(t.path,"models"),s.hasPath(this.models_path)||(t.hasOwnProperty("models_only")?t.models_only?(s.addPathMapping(this.models_path,{models_only:t.models_only}),this.models_only=t.models_only):s.addPathMapping(this.models_path,n.ViewModel):t.view_model?s.addPathMapping(this.models_path,t.view_model):t.create?s.addPathMapping(this.models_path,{create:t.create}):s.addPathMapping(this.models_path,n.ViewModel)),this.sort_attribute=t.sort_attribute,this.sorted_index=t.sorted_index,o.destroy=i.bind(this.destroy,this),o.collection=i.bind(this.collection,this),o.viewModelByModel=i.bind(this.viewModelByModel,this),o.sortedIndex=i.bind(this.sortedIndex,this),o.sortAttribute=i.bind(this.sortAttribute,this),o.hasViewModels=i.bind(this.hasViewModels,this),o.bind=i.bind(this.bind,this),o.unbind=i.bind(this.unbind,this),o.trigger=i.bind(this.trigger,this),n.utils.wrappedObject(o,null),e&&this.collection(e,{silent:!0,defer:t.defer}),o.subscribe(i.bind(this._onObservableArrayChange,this)),o}return e.prototype.destroy=function(){var e,t;t=n.utils.wrappedObservable(this),e=n.utils.wrappedObject(t),e&&(this._collectionUnbind(e),this._clear(!0),e=n.utils.wrappedObject(t,null)),n.utils.wrappedDestroy(this);if(n.statistics)return n.statistics.unregister("kb.CollectionObservable",this)},e.prototype.collection=function(e,t){var r,i;r=n.utils.wrappedObservable(this),i=n.utils.wrappedObject(r);if(arguments.length===0)return r(),i;if(e===i)return;return e!=null&&typeof e.retain=="function"&&e.retain(),i&&(this._collectionUnbind(i),typeof i.release=="function"&&i.release()),n.utils.wrappedObject(r,e),e?(this._collectionBind(e),this.sortedIndex(this.sorted_index,this.sort_attribute,t)):this._clear(),e},e.prototype.sortedIndex=function(e,t,r){var s,o=this;return r==null&&(r={}),e?(this.sorted_index=e,this.sort_attribute=t):t?(this.sort_attribute=t,this.sorted_index=this._sortAttributeFn(t)):(this.sort_attribute=null,this.sorted_index=null),s=function(){var e,t;t=n.utils.wrappedObservable(o),e=n.utils.wrappedObject(t);if(e.models.length===0&&t().length===0)return;o._collectionResync(!0);if(!r.silent)return o.trigger("resort",t())},r.defer?i.defer(s):s(),this},e.prototype.sortAttribute=function(e,t,n){return this.sortedIndex(t,e,n)},e.prototype.viewModelByModel=function(e){var t,r;return this.hasViewModels()?(r=n.utils.wrappedObservable(this),t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid",i.find(r(),function(n){return n.__kb.object[t]===e[t]})):null},e.prototype.hasViewModels=function(){return!this.models_only},e.prototype._collectionBind=function(e){var t,n,r,i,s,o,u;e.bind("reset",this.__kb._onCollectionReset),this.sorted_index||e.bind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.bind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.bind(t,this.__kb._onModelRemove);return e.bind("change",this.__kb._onModelChange)},e.prototype._collectionUnbind=function(e){var t,n,r,i,s,o,u;e.unbind("reset",this.__kb._onCollectionReset),this.sorted_index||e.unbind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.unbind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.unbind(t,this.__kb._onModelRemove);return e.unbind("change",this.__kb._onModelChange)},e.prototype._onCollectionReset=function(){if(this.in_edit)return;return this._collectionResync()},e.prototype._onCollectionResort=function(e){var t;return this.sorted_index&&n.throwUnexpected(this,"sorted_index"),i.isArray(e)?(t=n.utils.wrappedObservable(this),this.trigger("resort",t())):this._onModelResort(e)},e.prototype._onModelAdd=function(e){var t,r,i,s;return s=this._createViewModel(e),i=n.utils.wrappedObservable(this),r=n.utils.wrappedObject(i),this.sorted_index?t=this.sorted_index(i(),s):t=r.indexOf(e),this.in_edit++,i.splice(t,0,s),this.in_edit--,this.trigger("add",s,i())},e.prototype._onModelRemove=function(e){var t,r;r=this.hasViewModels()?this.viewModelByModel(e):e;if(!r)return;t=n.utils.wrappedObservable(this),this.in_edit++,t.remove(r),this.in_edit--,this.trigger("remove",r,t);if(this.hasViewModels())return n.utils.wrappedStore(t).releaseObservable(r,n.utils.wrappedStoreIsOwned(t))},e.prototype._onModelChange=function(e){if(this.sorted_index&&(!this.sort_attribute||e.hasChanged(this.sort_attribute)))return this._onModelResort(e)},e.prototype._onModelResort=function(e){var t,r,s,o,u,a;s=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(s),a=this.hasViewModels()?this.viewModelByModel(e):e,o=s.indexOf(a),this.sorted_index?(u=i.clone(s()),u.splice(o,1),r=this.sorted_index(u,a)):r=t.indexOf(e);if(o===r)return;return this.in_edit++,s.splice(o,1),s.splice(r,0,a),this.in_edit--,this.trigger("resort",a,s(),r)},e.prototype._onObservableArrayChange=function(e){var t,r;if(this.in_edit)return;return r=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(r),this.in_edit++,t.reset(i.map(e,function(e){return n.utils.wrappedModel(e)})),this.in_edit--},e.prototype._clear=function(e){var t,r,i,s,o,u,a;r=n.utils.wrappedObservable(this),e||this.trigger("remove",r()),this.in_edit++,e?(t=r(),o=this.hasViewModels()?t.slice(0):null,t.splice(0,t.length)):(o=r.removeAll(),this.hasViewModels()||(o=null)),this.in_edit--;if(!o)return;i=n.utils.wrappedStore(r);for(u=0,a=o.length;u<a;u++)s=o[u],i.releaseObservable(s,n.utils.wrappedStoreIsOwned(r));return this},e.prototype._collectionResync=function(e){var t,r,s,o,u,a,f,l,c,h=this;this._clear(e),o=n.utils.wrappedObservable(this),r=n.utils.wrappedObject(o);if(this.sorted_index){a=[],c=r.models;for(f=0,l=c.length;f<l;f++)s=c[f],u=this._createViewModel(s),t=this.sorted_index(a,u),a.splice(t,0,u)}else a=this.hasViewModels()?i.map(r.models,function(e){return h._createViewModel(e)}):i.clone(r.models);this.in_edit++,o(a),this.in_edit--;if(!e)return this.trigger("add",o())},e.prototype._sortAttributeFn=function(e){return this.hasViewModels()?function(t,r){return i.sortedIndex(t,r,function(t){return n.utils.wrappedModel(t).get(e)})}:function(t,n){return i.sortedIndex(t,n,function(t){return t.get(e)})}},e.prototype._createViewModel=function(e){var t;return t=n.utils.wrappedObservable(this),this.hasViewModels()?n.utils.wrappedStore(t).findOrCreateObservable(e,this.models_path,n.utils.wrappedFactory(t)):e},e}(),u(n.CollectionObservable.prototype,e.Events),n.collectionObservable=function(e,t){return new n.CollectionObservable(e,t)},n.sortedIndexWrapAttr=n.siwa=function(e,t){return function(r,s){return i.sortedIndex(r,s,function(r){return new t(n.utils.wrappedModel(r).get(e))})}},n.DefaultWrapper=function(){function e(e,t){var s,o=this;return this.default_value=t,s=n.utils.wrappedObservable(this,r.dependentObservable({read:function(){var t,n;return n=r.utils.unwrapObservable(e()),t=r.utils.unwrapObservable(o.default_value),n?n:t},write:function(t){return e(t)}})),s.destroy=i.bind(this.destroy,this),s.setToDefault=i.bind(this.setToDefault,this),s}return e.prototype.destroy=function(){var e;return this.default_value&&(typeof (e=this.default_value).dispose=="function"&&e.dispose(),this.default_value=null),n.utils.wrappedDestroy(this)},e.prototype.setToDefault=function(){var e;return e=n.utils.wrappedObservable(this),e(this.default_value)},e}(),n.defaultWrapper=function(e,t){return new n.DefaultWrapper(e,t)},n.toFormattedString=function(e){var t,n,i,s,o,u;o=e.slice(),n=Array.prototype.slice.call(arguments,1);for(i in n){t=n[i],u=r.utils.unwrapObservable(t),u||(u=""),s=e.indexOf("{"+i+"}");while(s>=0)o=o.replace("{"+i+"}",u),s=e.indexOf("{"+i+"}",s+1)}return o},n.parseFormattedString=function(e,t){var n,r,s,o,u,a,f,l,c,h,p,d;h=t.slice(),s=0,a=0,l={};while(h.search("\\{"+s+"\\}")>=0){f=t.indexOf("{"+s+"}");while(f>=0)h=h.replace("{"+s+"}","(.*)"),l[f]=s,a++,f=t.indexOf("{"+s+"}",f+1);s++}n=s,c=new RegExp(h),u=c.exec(e),u&&u.shift();if(!u||u.length!==a)return i.range(n).map(function(){return""});d=i.sortBy(i.keys(l),function(e,t){return parseInt(e,10)}),r={};for(o in d){f=d[o],s=l[f];if(r.hasOwnProperty(s))continue;r[s]=o}p=[],s=0;while(s<n)p.push(u[r[s]]),s++;return p},n.FormattedObservable=function(){function e(e,t){var s,o;return i.isArray(t)?(e=e,o=t):o=Array.prototype.slice.call(arguments,1),s=n.utils.wrappedObservable(this,r.dependentObservable({read:function(){var i,s,u;t=[r.utils.unwrapObservable(e)];for(s=0,u=o.length;s<u;s++)i=o[s],t.push(r.utils.unwrapObservable(i));return n.toFormattedString.apply(null,t)},write:function(t){var i,s,u;s=n.parseFormattedString(t,r.utils.unwrapObservable(e)),u=Math.min(o.length,s.length),i=0;while(i<u)o[i](s[i]),i++;return this}})),s}return e.prototype.destroy=function(){return n.utils.wrappedDestroy(this)},e}(),n.formattedObservable=function(e,t){return new n.FormattedObservable(e,Array.prototype.slice.call(arguments,1))},n.LocalizedObservable=function(){function t(e,t,s){var o,u,a=this;return this.value_holder=e,t==null&&(t={}),this.view_model=s!=null?s:{},this.read||n.throwMissing(this,"read"),n.locale_manager||n.throwMissing(this,"kb.locale_manager"),this.__kb||(this.__kb={}),this.__kb._onLocaleChange=i.bind(this._onLocaleChange,this),this.__kb._onChange=t.onChange,this.value_holder&&(u=r.utils.unwrapObservable(this.value_holder)),n.utils.wrappedByKey(this,"vo",r.observable(u?this.read(u,null):null)),o=n.utils.wrappedObservable(this,r.dependentObservable({read:function(){var e;return a.value_holder&&r.utils.unwrapObservable(a.value_holder),e=n.utils.wrappedByKey(a,"vo"),e(),a.read(r.utils.unwrapObservable(a.value_holder))},write:function(e){var t;a.write||n.throwUnexpected(a,"writing to read-only"),a.write(e,r.utils.unwrapObservable(a.value_holder)),t=n.utils.wrappedByKey(a,"vo"),t(e);if(a.__kb._onChange)return a.__kb._onChange(e)},owner:this.view_model})),o.destroy=i.bind(this.destroy,this),o.observedValue=i.bind(this.observedValue,this),o.resetToCurrent=i.bind(this.resetToCurrent,this),n.locale_manager.bind("change",this.__kb._onLocaleChange),t.hasOwnProperty("default")&&(o=r.defaultWrapper(o,t["default"])),o}return t.extend=e.Model.extend,t.prototype.destroy=function(){return n.locale_manager.unbind("change",this.__kb._onLocaleChange),this.view_model=null,n.utils.wrappedDestroy(this)},t.prototype.resetToCurrent=function(){var e,t;return t=n.utils.wrappedByKey(this,"vo"),t(null),e=this.value_holder?this.read(r.utils.unwrapObservable(this.value_holder)):null,n.utils.wrappedObservable(this)(e)},t.prototype.observedValue=function(e){return arguments.length===0?this.value_holder:(this.value_holder=e,this._onLocaleChange(),this)},t.prototype._onLocaleChange=function(){var e,t;e=this.read(r.utils.unwrapObservable(this.value_holder)),t=n.utils.wrappedByKey(this,"vo"),t(e);if(this.__kb._onChange)return this.__kb._onChange(e)},t}(),n.localizedObservable=function(e,t,r){return new n.LocalizedObservable(e,t,r)},n.Observable=function(){function t(e,t,s){var o,u,a=this;return this.view_model=s!=null?s:{},t||n.throwMissing(this,"options"),t.options&&(t=i.defaults(i.clone(t),t.options),delete t.options),this.key=i.isString(t)||r.isObservable(t)?t:t.key,this.key||n.throwMissing(this,"key"),this.args=t.args,this.read=t.read,this.write=t.write,n.utils.wrappedByKey(this,"vo",r.observable(null)),u=n.utils.wrappedObservable(this,r.dependentObservable({read:function(){var e,t,s,o,f,l,c;t=[r.utils.unwrapObservable(a.key)];if(a.args)if(i.isArray(a.args)){c=a.args;for(f=0,l=c.length;f<l;f++)e=c[f],t.push(r.utils.unwrapObservable(e))}else t.push(r.utils.unwrapObservable(a.args));return u=n.utils.wrappedObservable(a),s=u?n.utils.wrappedObject(u):null,s&&(o=a.read?a.read.apply(a.view_model,t):s.get.apply(s,t),a.update(o)),r.utils.unwrapObservable(n.utils.wrappedByKey(a,"vo")())},write:function(e){var t,s,o,u,f,l,c;u={},u[r.utils.unwrapObservable(a.key)]=e,s=a.write?[e]:[u];if(a.args)if(i.isArray(a.args)){c=a.args;for(f=0,l=c.length;f<l;f++)t=c[f],s.push(r.utils.unwrapObservable(t))}else s.push(r.utils.unwrapObservable(a.args));return o=n.utils.wrappedObject(n.utils.wrappedObservable(a)),o&&(a.write?a.write.apply(a.view_model,s):o.set.apply(o,s)),a.update(e)},owner:this.view_model})),n.utils.wrappedStore(u,t.store),n.utils.wrappedPath(u,n.utils.pathJoin(t.path,this.key)),t.factories&&(typeof t.factories=="function"||t.factories.create)?(o=n.utils.wrappedFactory(u,new n.Factory(t.factory)),o.addPathMapping(n.utils.wrappedPath(u),t.factories)):n.Factory.useOptionsOrCreate(t,u,n.utils.wrappedPath(u)),u.valueType=i.bind(this.valueType,this),u.model=i.bind(this.model,this),u.update=i.bind(this.update,this),u.destroy=i.bind(this.destroy,this),n.ModelWatcher.useOptionsOrCreate(t,e,this,{model:i.bind(this.model,this),update:i.bind(this.update,this),key:this.key}),t.localizer&&(u=new t.localizer(u)),t.hasOwnProperty("default")&&(u=n.defaultWrapper(u,t["default"])),u}return t.prototype.destroy=function(){return n.release(this.value),this.value=null,n.utils.wrappedDestroy(this)},t.prototype.model=function(e){var t,r;r=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(r);if(arguments.length===0||t===e)return t;n.utils.wrappedObject(r,e);if(!e)return;return this.update()},t.prototype.update=function(e){var t,s,o,u;o=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(o),u=n.utils.wrappedByKey(this,"vo")(),t&&!arguments.length&&(e=t.get(r.utils.unwrapObservable(this.key))),e||(e=null),s=n.utils.valueType(e);if(i.isUndefined(this.value_type)||this.value_type!==s&&s!==n.TYPE_UNKNOWN)return this._updateValueObservable(e);if(this.value_type===n.TYPE_MODEL){if(typeof u.model=="function"){if(u.model()!==e)return u.model(e)}else if(n.utils.wrappedObject(u)!==e)return this._updateValueObservable(e)}else if(this.value_type===n.TYPE_COLLECTION){if(u.collection()!==e)return u.collection(e)}else if(u()!==e)return u(e)},t.prototype.valueType=function(){var e,t;return e=n.utils.wrappedObject(n.utils.wrappedObservable(this)),t=e?e.get(this.key):null,this.value_type||this._updateValueObservable(t),this.value_type},t.prototype._updateValueObservable=function(t){var s,o,u,a,f,l,c,h,p,d,v;return f=n.utils.wrappedObservable(this),a=n.utils.wrappedObject(f),p=n.utils.wrappedStore(f),o=n.utils.wrappedFactory(f),l=n.utils.wrappedPath(f),s=o.creatorForPath(t,l),!s&&a&&e.RelationalModel&&a instanceof e.RelationalModel&&(u=r.utils.unwrapObservable(this.key),h=i.find(a.getRelations(),function(e){return e.key===u}),h&&(s=h.collectionKey?n.CollectionObservable:n.ViewModel)),p?d=p.findOrCreateObservable(t,l,o,s):s?d=o.createForPath(t,l,p,s):d=r.observable(t),r.isObservable(d)?n.utils.observableInstanceOf(d,n.CollectionObservable)?this.value_type=n.TYPE_COLLECTION:this.value_type=n.TYPE_SIMPLE:(this.value_type=n.TYPE_MODEL,typeof d.model!="function"&&n.utils.wrappedObject(d,t)),v=n.utils.wrappedByKey(this,"vo"),c=this.value,this.value=d,c&&(p?p.releaseObservable(c):n.release(c)),v(d)},t}(),n.observable=function(e,t,r){return new n.Observable(e,t,r)},n.TriggeredObservable=function(){function e(e,t){var s,o=this;return this.event_name=t,e||n.throwMissing(this,"model"),this.event_name||n.throwMissing(this,"event_name"),n.utils.wrappedByKey(this,"vo",r.observable()),s=n.utils.wrappedObservable(this,r.dependentObservable(function(){return n.utils.wrappedByKey(o,"vo")()})),s.destroy=i.bind(this.destroy,this),n.utils.wrappedModelWatcher(this,new n.ModelWatcher(e,this,{model:i.bind(this.model,this),update:i.bind(this.update,this),event_name:this.event_name})),s}return e.prototype.destroy=function(){return this.options=null,this.view_model=null,n.utils.wrappedDestroy(this)},e.prototype.model=function(e){var t,r;r=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(r);if(arguments.length===0||t===e)return t;n.utils.wrappedObject(r,e);if(!e)return;return this.update()},e.prototype.update=function(){var e,t,r,i;r=n.utils.wrappedObservable(this),i=n.utils.wrappedByKey(this,"vo"),e=i(),t=n.utils.wrappedObject(r);if(!t)return;return e!==t?i(t):i.valueHasMutated()},e}(),n.triggeredObservable=function(e,t){return new n.TriggeredObservable(e,t)},n.ViewModel=function(e){function t(e,r,s){var o,u,a,f,l,c,h;r==null&&(r={}),t.__super__.constructor.apply(this,arguments),n.statistics&&n.statistics.register("kb.ViewModel",this),r.options&&(r=i.defaults(i.clone(r),r.options)),i.isArray(r)&&(r={keys:r}),this.__kb||(this.__kb={}),this.__kb.vm_keys={},this.__kb.model_keys={},this.__kb.view_model=i.isUndefined(s)?this:s,this.__kb.internals=r.internals,n.Store.useOptionsOrCreate(r,e,this),n.utils.wrappedPath(this,r.path),n.Factory.useOptionsOrCreate(r,this,r.path),l=n.utils.wrappedModelWatcher(this,new n.ModelWatcher(e,this,{model:i.bind(this.model,this)}));if(r.keys)if(i.isArray(r.keys))u=this.__kb.keys=r.keys;else{a={},h=r.keys;for(c in h)f=h[c],a[i.isString(f)?f:f.key?f.key:c]=!0;this.__kb.keys=i.keys(a)}else o=l.model(),o&&(u=i.keys(o.attributes));this.__kb.internals&&(u=u?i.union(u,this.__kb.internals):this.__kb.internals),r.requires&&i.isArray(r.requires)&&(u=u?i.union(u,r.requires):r.requires),i.isObject(r.keys)&&!i.isArray(r.keys)&&this._mapObservables(e,r.keys),i.isObject(r.requires)&&!i.isArray(r.requires)&&this._mapObservables(e,r.requires),r.mappings&&this._mapObservables(e,r.mappings),u&&this._createObservables(e,u)}return u(t,e),t.prototype.__destroy=function(){var e;if(this.__kb.view_model!==this)for(e in this.__kb.vm_keys)this.__kb.view_model[e]=null;n.release(this,!0),n.utils.wrappedDestroy(this),t.__super__.__destroy.apply(this,arguments);if(n.statistics)return n.statistics.unregister("kb.ViewModel",this)},t.prototype.model=function(e){var t,r,s;r=n.utils.wrappedObject(this);if(arguments.length===0||r===e)return r;r=n.utils.wrappedObject(this,e);if(!r)return;s=n.utils.wrappedModelWatcher(this);if(!s)return e;s.model(r);if(this.__kb.keys)return;t=i.difference(i.keys(r.attributes),i.keys(this.__kb.model_keys));if(t)return this._createObservables(e,t)},t.prototype.setToDefault=function(){var e;for(e in this.__kb.vm_keys)typeof this[e].setToDefault=="function"&&this[e].setToDefault();return this},t.prototype._createObservables=function(e,t){var r,s,o,u,a;s={store:n.utils.wrappedStore(this),factory:n.utils.wrappedFactory(this),path:n.utils.wrappedPath(this),model_watcher:n.utils.wrappedModelWatcher(this)};for(u=0,a=t.length;u<a;u++){r=t[u],o=this.__kb.internals&&i.contains(this.__kb.internals,r)?"_"+r:r;if(this[o])continue;this.__kb.vm_keys[o]=!0,this.__kb.model_keys[r]=!0,s.key=r,this[o]=this.__kb.view_model[o]=n.observable(e,s,this)}return this},t.prototype._mapObservables=function(e,t){var r,s,o;s={store:n.utils.wrappedStore(this),factory:n.utils.wrappedFactory(this),path:n.utils.wrappedPath(this),model_watcher:n.utils.wrappedModelWatcher(this)};for(o in t){r=t[o];if(this[o])continue;r=i.isString(r)?{key:r}:i.clone(r),r.key||(r.key=o),this.__kb.vm_keys[o]=!0,this.__kb.model_keys[r.key]=!0,this[o]=this.__kb.view_model[o]=n.observable(e,i.defaults(r,s),this)}return this},t}(n.RefCountable),n.viewModel=function(e,t,r){return new n.ViewModel(e,t,r)},n.observables=function(e,t,r){return n.legacyWarning("ko.observables","0.16.0","Please use kb.viewModel instead"),new n.ViewModel(e,t,r)}}).call(this);