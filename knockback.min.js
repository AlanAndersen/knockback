// Generated by CoffeeScript 1.3.3
/*
  knockback.js 0.16.0beta2
  (c) 2011, 2012 Kevin Malakoff.
  Knockback.js is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/knockback/blob/master/LICENSE
  Dependencies: Knockout.js, Backbone.js, and Underscore.js.
    Optional dependency: Backbone.ModelRef.js.
*/(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b=function(e,t){return function(){return e.apply(t,arguments)}},w={}.hasOwnProperty,E=function(e,t){function r(){this.constructor=e}for(var n in t)w.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};o=h=this.Knockback=this.kb=typeof exports!="undefined"?exports:{},h.VERSION="0.16.0beta2";if(typeof require!="undefined")try{y=require("lodash")}catch(S){y=require("underscore")}else y=this._;y&&y.hasOwnProperty("_")&&(y=y._),h._=y,h.Backbone=e=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,h.ko=p=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko,h.TYPE_UNKNOWN=s=0,h.TYPE_SIMPLE=i=1,h.TYPE_ARRAY=t=2,h.TYPE_MODEL=r=3,h.TYPE_COLLECTION=n=4,v=function(e,t){throw""+e.constructor.name+": "+t+" is missing"},m=function(e,t){throw""+e.constructor.name+": "+t+" is unexpected"},d=function(e,t,n){var r;return h._legacy_warnings||(h._legacy_warnings={}),(r=h._legacy_warnings)[e]||(r[e]=0),h._legacy_warnings[e]++,console.warn("warning: '"+e+"' has been deprecated (will be removed in Knockback after "+t+"). "+n+".")},f=Array.prototype.slice,l=Array.prototype.splice,c=function(e){var t;t=y.clone(e);while(e.options)y.defaults(t,e.options),e=e.options;return delete t.options,t},h.renderAndBindTemplate=function(e,t,n){var r;return r=document.createElement("div"),p.renderTemplate(e,t,{},r,"replaceChildren"),r.children.length===1&&(r=r.children[0]),n||h.releaseOnNodeRemove(t,r),r},h.releaseOnNodeRemove=function(e,t){return e||m(this,"missing view model"),t||m(this,"missing node"),p.utils.domNodeDisposal.addDisposeCallback(t,function(){return h.release(e)})},h.applyBindings=function(e,t,n){p.applyBindings(e,t);if(arguments.length===2||!n)return h.releaseOnNodeRemove(e,t)},h.release=function(t,r){var i,s,o,u,a,f,l;if(!t||!y.isObject(t)||t.__kb_destroyed||typeof t=="function"&&!p.isObservable(t)||t instanceof e.Model||t instanceof e.Collection)return;t.__kb_destroyed=!0,!r||r();if(p.isObservable(t)||typeof t.dispose=="function"||typeof t.destroy=="function"||typeof t.release=="function")if(p.isObservable(t)&&y.isArray(i=t())){if(t.__kb_is_co||t.__kb_is_o&&t.valueType()===n)t.destroy?t.destroy():t.dispose&&t.dispose();else if(i.length){a=i.slice(0),i.splice(0,i.length);for(f=0,l=a.length;f<l;f++)u=a[f],h.release(u)}}else t.release?t.release():t.destroy?t.destroy():t.dispose&&t.dispose();else for(s in t)o=t[s],s==="__kb"||h.release(o,function(){return t[s]=null})},h.releaseKeys=function(e){var t,n;for(t in e)n=e[t],t==="__kb"||h.release(n,function(){return e[t]=null})},h.locale_manager=void 0,h.utils={},h.utils.wrappedDestroy=function(e){var t;if(!e.__kb)return;return e.__kb.model_watcher&&e.__kb.model_watcher.releaseCallbacks(e),t=e.__kb,e.__kb=null,t.observable&&(t.observable.destroy=t.observable.release=null,h.utils.wrappedDestroy(t.observable),t.observable=null),t.factory=null,t.model_watcher_is_owned&&t.model_watcher.destroy(),t.model_watcher=null,t.store_is_owned&&t.store.destroy(),t.store=null},g=function(e,t,n){return arguments.length===2?e&&e.__kb&&e.__kb.hasOwnProperty(t)?e.__kb[t]:void 0:(e||m(this,"no obj for wrapping "+t),e.__kb||(e.__kb={}),e.__kb[t]=n,n)},a=function(e,t){return l.call(e,1,0,t),e},h.utils.wrappedModel=function(e,t){return arguments.length===1?(t=g(e,"object"),y.isUndefined(t)?e:t):g(e,"object",t)},h.utils.wrappedObservable=function(e,t){return g.apply(this,a(arguments,"observable"))},h.utils.wrappedObject=function(e,t){return g.apply(this,a(arguments,"object"))},h.utils.wrappedStore=function(e,t){return g.apply(this,a(arguments,"store"))},h.utils.wrappedStoreIsOwned=function(e,t){return g.apply(this,a(arguments,"store_is_owned"))},h.utils.wrappedFactory=function(e,t){return g.apply(this,a(arguments,"factory"))},h.utils.wrappedModelWatcher=function(e,t){return g.apply(this,a(arguments,"model_watcher"))},h.utils.wrappedModelWatcherIsOwned=function(e,t){return g.apply(this,a(arguments,"model_watcher_is_owned"))},h.utils.setToDefault=function(e){var t,n;if(!e)return;if(p.isObservable(e))typeof e.setToDefault=="function"&&e.setToDefault();else if(y.isObject(e))for(t in e)n=e[t],n&&(p.isObservable(n)||typeof n!="function")&&(t[0]!=="_"||t.search("__kb"))&&h.utils.setToDefault(n);return e},h.utils.release=function(e){return d("kb.utils.release","0.16.0","Please use kb.release instead"),h.release(e)},h.utils.valueType=function(o){return o?o.__kb_is_o?o.valueType():o.__kb_is_co||o instanceof e.Collection?n:o instanceof h.ViewModel||o instanceof e.Model?r:y.isArray(o)?t:i:s},h.utils.pathJoin=function(e,t){return(e?e[e.length-1]!=="."?""+e+".":e:"")+t},h.utils.optionsPathJoin=function(e,t){return y.defaults({path:h.utils.pathJoin(e.path,t)},e)},h.utils.inferCreator=function(t,n,r,i,s){var o,u;n&&(o=n.creatorForPath(t,r));if(o)return o;if(i&&e.RelationalModel&&i instanceof e.RelationalModel){s=p.utils.unwrapObservable(s),u=y.find(i.getRelations(),function(e){return e.key===s});if(u)return u.collectionType||y.isArray(u.keyContents)?h.CollectionObservable:h.ViewModel}return t?t instanceof e.Model?h.ViewModel:t instanceof e.Collection?h.CollectionObservable:null:null},h.utils.createDefaultObservable=function(t,n){return t instanceof e.Model?h.viewModel(t,n):t instanceof e.Collection?h.collectionObservable(t,n):y.isArray(t)?p.observableArray(t):p.observable(t)},h.Factory=function(){function e(e){this.parent_factory=e,this.paths={}}return e.useOptionsOrCreate=function(e,t,n){var r;return e.factory&&!e.factories?r=h.utils.wrappedFactory(t,e.factory):r=h.utils.wrappedFactory(t,new h.Factory(e.factory)),e.factories&&r.addPathMappings(e.factories,n),r},e.prototype.hasPath=function(e){return this.paths.hasOwnProperty(e)||this.parent_factory&&this.parent_factory.hasPath(e)},e.prototype.addPathMapping=function(e,t){return this.paths[e]=t},e.prototype.addPathMappings=function(e,t){var n,r;for(r in e)n=e[r],this.paths[h.utils.pathJoin(t,r)]=n;return this},e.prototype.creatorForPath=function(e,t){var n;if(n=this.paths[t])return n.view_model?n.view_model:n;if(this.parent_factory)if(n=this.parent_factory.creatorForPath(e,t))return n;return null},e}(),h.Store=function(){function t(){this.observables=[]}return t.useOptionsOrCreate=function(e,t,n){return e.store?(e.store.registerObservable(t,n,e),h.utils.wrappedStore(n,e.store)):(h.utils.wrappedStoreIsOwned(n,!0),h.utils.wrappedStore(n,new h.Store))},t.prototype.destroy=function(){var e,t,n,r;r=this.observables;for(t=0,n=r.length;t<n;t++)e=r[t],h.release(e.observable);return this.observables=null},t.prototype.registerObservable=function(e,t,n){var r;if(!t)return;if(p.isObservable(t)||t.__kb_is_co)return;return h.utils.wrappedObject(t,e),e||(t.__kb_null=!0),r=n.creator?n.creator:n.path&&n.factory?n.factory.creatorForPath(e,n.path):null,r||m(this,"missing creator"),this.observables.push({obj:e,observable:t,creator:r})},t.prototype.findObservable=function(t,n){var r,i,s,o;if(!t||t instanceof e.Model){o=this.observables;for(i=0,s=o.length;i<s;i++){r=o[i];if(!r.observable)continue;if(r.observable.__kb_destroyed){r.obj=null,r.observable=null;continue}if(!t&&!r.observable.__kb_null||t&&(r.observable.__kb_null||r.obj!==t))continue;if(r.creator===n||r.creator.create&&r.creator.create===n.create)return r.observable}}return null},t.prototype.observableIsRegistered=function(e){var t,n,r,i;i=this.observables;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.observable===e)return!0}return!1},t.prototype.findOrCreateObservable=function(t,n){var r,i;return n.store=this,n.creator||(n.creator=h.utils.inferCreator(t,n.factory,n.path)),!n.creator&&t instanceof e.Model&&(n.creator=kv.ViewModel),r=n.creator,r?r.models_only?t:(r&&(i=this.findObservable(t,r)),i?i:(r.create?i=r.create(t,n):i=new r(t,n),i||(i=p.observable(null)),p.isObservable(i)||this.observableIsRegistered(i)||this.registerObservable(t,i,n),i)):h.utils.createDefaultObservable(t,n)},t}(),u=function(e,t,n){return!h.statistics||h.statistics.addEvent({model:e,event:t,key:n.key,path:n.path})},h.ModelWatcher=function(){function t(e,t,n){this._onModelUnloaded=b(this._onModelUnloaded,this),this._onModelLoaded=b(this._onModelLoaded,this),this.__kb||(this.__kb={}),this.__kb.callbacks={},this.__kb._onModelLoaded=y.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=y.bind(this._onModelUnloaded,this),n&&this.registerCallbacks(t,n),e?this.model(e):this.m=null}return t.useOptionsOrCreate=function(e,t,n,r){return e.model_watcher?(e.model_watcher.model()!==t&&e.model_watcher.model_ref!==t&&m(this,"model not matching"),h.utils.wrappedModelWatcher(n,e.model_watcher).registerCallbacks(n,r)):(h.utils.wrappedModelWatcherIsOwned(n,!0),h.utils.wrappedModelWatcher(n,new h.ModelWatcher(t)).registerCallbacks(n,r))},t.prototype.destroy=function(){return this.model(null),this.__kb.callbacks=null,h.utils.wrappedDestroy(this)},t.prototype.model=function(t){var n,r,i,s,o,u,a,f;if(arguments.length===0||this.m===t)return this.m;this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),e.ModelRef&&t instanceof e.ModelRef?(this.model_ref=t,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),t=this.model_ref.model()):delete this.model_ref,o=this.m,this.m=t,f=this.__kb.callbacks;for(r in f){n=f[r],o&&o.unbind(r,n.fn),t&&t.bind(r,n.fn),s=n.list;for(u=0,a=s.length;u<a;u++)i=s[u],i.model&&i.model(t)}return t},t.prototype.registerCallbacks=function(t,n){var r,i,s,o;return t||v(this,"obj"),n||v(this,"info"),i=n.event_name?n.event_name:"change",r=this.__kb.callbacks[i],r||(o=[],r={list:o,fn:function(e){var t,n,r;for(n=0,r=o.length;n<r;n++){t=o[n];if(t.update&&!t.rel_fn){if(e&&t.key&&e.hasChanged&&!e.hasChanged(p.utils.unwrapObservable(t.key)))continue;!h.statistics||u(e,"event: "+i,t),t.update()}}return null}},this.__kb.callbacks[i]=r,this.m&&this.m.bind(i,r.fn)),s=y.defaults({obj:t},n),r.list.push(s),this.m&&(e.RelationalModel&&this.m instanceof e.RelationalModel&&this._modelBindRelatationalInfo(i,s),s.model(this.m)&&s.model),this},t.prototype.releaseCallbacks=function(e){var t,n,r,i,s,o;if(!this.__kb.callbacks)return;s=this.__kb.callbacks;for(n in s){t=s[n],o=t.list;for(r in o){i=o[r];if(i.obj===e){t.list.splice(r,1),i.rel_fn&&this._modelUnbindRelatationalInfo(n,i),i.model&&i.model(null);return}}}},t.prototype._onModelLoaded=function(t){var n,r,i,s,o,u,a,f;s=e.RelationalModel&&t instanceof e.RelationalModel,this.m=t,f=this.__kb.callbacks;for(r in f){n=f[r],t.bind(r,n.fn),o=n.list;for(u=0,a=o.length;u<a;u++)i=o[u],s&&this._modelBindRelatationalInfo(r,i),i.model&&i.model(t)}return this},t.prototype._onModelUnloaded=function(e){var t,n,r,i,s,o,u;this.m=null,u=this.__kb.callbacks;for(n in u){t=u[n],e.unbind(n,t.fn),i=t.list;for(s=0,o=i.length;s<o;s++)r=i[s],r.rel_fn&&this._modelUnbindRelatationalInfo(n,r),r.model&&r.model(null)}return this},t.prototype._modelBindRelatationalInfo=function(e,t){var n,r;if(e==="change"&&t.key&&t.update){n=p.utils.unwrapObservable(t.key),r=y.find(this.m.getRelations(),function(e){return e.key===n});if(!r)return;t.rel_fn=function(n){return!h.statistics||u(n,"rel_event: "+e,t),t.update()},r.collectionType||y.isArray(r.keyContents)?(t.is_collection=!0,this.m.bind("add:"+t.key,t.rel_fn),this.m.bind("remove:"+t.key,t.rel_fn)):this.m.bind("update:"+t.key,t.rel_fn)}return this},t.prototype._modelUnbindRelatationalInfo=function(e,t){if(!t.rel_fn)return;return t.is_collection?(this.m.unbind("add:"+t.key,t.rel_fn),this.m.unbind("remove:"+t.key,t.rel_fn)):this.m.unbind("update:"+t.key,t.rel_fn),t.rel_fn=null,this},t}(),h.modelObservable=function(e,t){return new h.ModelWatcher(e,t)},h.CollectionObservable=function(){function t(e,t){var n,r,i;return t||(t={}),i=h.utils.wrappedObservable(this,p.observableArray([])),i.__kb_is_co=!0,this.in_edit=0,this.__kb||(this.__kb={}),this.__kb._onCollectionReset=y.bind(this._onCollectionReset,this),this.__kb._onCollectionResort=y.bind(this._onCollectionResort,this),this.__kb._onModelAdd=y.bind(this._onModelAdd,this),this.__kb._onModelRemove=y.bind(this._onModelRemove,this),this.__kb._onModelChange=y.bind(this._onModelChange,this),t=c(t),this.sort_attribute=t.sort_attribute,this.sorted_index=t.sorted_index,n=this.create_options={store:h.Store.useOptionsOrCreate(t,e,i)},this.path=t.path,r=n.factory=h.utils.wrappedFactory(i,new h.Factory(t.factory)),t.factories&&r.addPathMappings(t.factories,t.path),n.path=h.utils.pathJoin(t.path,"models"),n.creator=r.creatorForPath(null,n.path),n.creator?this.models_only=n.creator.models_only:t.hasOwnProperty("models_only")?t.models_only?(r.addPathMapping(n.path,{models_only:t.models_only}),this.models_only=t.models_only):r.addPathMapping(n.path,h.ViewModel):t.view_model?r.addPathMapping(n.path,t.view_model):t.create?r.addPathMapping(n.path,{create:t.create}):r.addPathMapping(n.path,h.ViewModel),i.destroy=y.bind(this.destroy,this),i.shareOptions=y.bind(this.shareOptions,this),i.collection=y.bind(this.collection,this),i.viewModelByModel=y.bind(this.viewModelByModel,this),i.sortedIndex=y.bind(this.sortedIndex,this),i.sortAttribute=y.bind(this.sortAttribute,this),i.hasViewModels=y.bind(this.hasViewModels,this),i.bind=y.bind(this.bind,this),i.unbind=y.bind(this.unbind,this),i.trigger=y.bind(this.trigger,this),h.utils.wrappedObject(i,null),e&&this.collection(e,{silent:!0,defer:t.defer}),i.subscribe(y.bind(this._onObservableArrayChange,this)),!h.statistics||h.statistics.register(this),i}return t.extend=e.Model.extend,t.prototype.destroy=function(){var e,t;return t=h.utils.wrappedObservable(this),e=h.utils.wrappedObject(t),e&&(this._collectionUnbind(e),this._clear(!0),h.utils.wrappedObject(t,null)),this.create_options=null,h.utils.wrappedDestroy(this),!h.statistics||h.statistics.unregister(this)},t.prototype.shareOptions=function(){var e;return e=h.utils.wrappedObservable(this),{store:h.utils.wrappedStore(e),factory:h.utils.wrappedFactory(e)}},t.prototype.collection=function(e,t){var n,r;return n=h.utils.wrappedObservable(this),r=h.utils.wrappedObject(n),arguments.length===0||e===r?(n(),r):(e&&typeof e.retain=="function"&&e.retain(),r&&(this._collectionUnbind(r),typeof r.release=="function"&&r.release()),h.utils.wrappedObject(n,e),e?(this._collectionBind(e),this.sortedIndex(this.sorted_index,this.sort_attribute,t)):this._clear(),e)},t.prototype.sortedIndex=function(e,t,n){var r,i=this;return n||(n={}),e?(this.sorted_index=e,this.sort_attribute=t):t?(this.sort_attribute=t,this.sorted_index=this._sortAttributeFn(t)):(this.sort_attribute=null,this.sorted_index=null),r=function(){var e,t;t=h.utils.wrappedObservable(i),e=h.utils.wrappedObject(t);if(e.models.length===0&&t().length===0)return;i._collectionResync(!0);if(!n.silent)return i.trigger("resort",t())},n.defer?y.defer(r):r(),this},t.prototype.sortAttribute=function(e,t,n){return this.sortedIndex(t,e,n)},t.prototype.viewModelByModel=function(e){var t;return this.models_only?null:(t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid",y.find(h.utils.wrappedObservable(this)(),function(n){return n.__kb.object[t]===e[t]}))},t.prototype.hasViewModels=function(){return!this.models_only},t.prototype._collectionBind=function(e){var t,n,r,i,s,o,u;e.bind("reset",this.__kb._onCollectionReset),this.sorted_index||e.bind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.bind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.bind(t,this.__kb._onModelRemove);return e.bind("change",this.__kb._onModelChange)},t.prototype._collectionUnbind=function(e){var t,n,r,i,s,o,u;e.unbind("reset",this.__kb._onCollectionReset),this.sorted_index||e.unbind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.unbind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.unbind(t,this.__kb._onModelRemove);return e.unbind("change",this.__kb._onModelChange)},t.prototype._onCollectionReset=function(){if(this.in_edit)return;return this._collectionResync()},t.prototype._onCollectionResort=function(e){return!this.sorted_index||m(this,"sorted_index"),y.isArray(e)?this.trigger("resort",h.utils.wrappedObservable(this)()):this._onModelResort(e),this},t.prototype._onModelAdd=function(e){var t,n,r,i;return i=this._createViewModel(e),r=h.utils.wrappedObservable(this),n=h.utils.wrappedObject(r),t=this.sorted_index?this.sorted_index(r(),i):n.indexOf(e),this.in_edit++,r.splice(t,0,i),this.in_edit--,this.trigger("add",i,r())},t.prototype._onModelRemove=function(e){var t,n;n=this.models_only?e:this.viewModelByModel(e);if(!n)return;return t=h.utils.wrappedObservable(this),this.in_edit++,t.remove(n),this.in_edit--,this.trigger("remove",n,t)},t.prototype._onModelChange=function(e){if(this.sorted_index&&(!this.sort_attribute||e.hasChanged(this.sort_attribute)))return this._onModelResort(e)},t.prototype._onModelResort=function(e){var t,n,r,i,s,o;r=h.utils.wrappedObservable(this),t=h.utils.wrappedObject(r),o=this.models_only?e:this.viewModelByModel(e),i=r.indexOf(o),this.sorted_index?(s=y.clone(r()),s.splice(i,1),n=this.sorted_index(s,o)):n=t.indexOf(e);if(i===n)return;return this.in_edit++,r.splice(i,1),r.splice(n,0,o),this.in_edit--,this.trigger("resort",o,r(),n)},t.prototype._onObservableArrayChange=function(e){var t,n;if(this.in_edit)return;return n=h.utils.wrappedObservable(this),t=h.utils.wrappedObject(n),this.in_edit++,t.reset(y.map(e,function(e){return h.utils.wrappedModel(e)})),this.in_edit--},t.prototype._clear=function(e){var t,n;return n=h.utils.wrappedObservable(this),e||this.trigger("remove",n()),e?(t=n(),t.splice(0,t.length)):(this.in_edit++,n.removeAll(),this.in_edit--),this},t.prototype._collectionResync=function(e){var t,n,r,i,s,o,u,a,f,l=this;this._clear(e),i=h.utils.wrappedObservable(this),n=h.utils.wrappedObject(i);if(this.sorted_index){o=[],f=n.models;for(u=0,a=f.length;u<a;u++)r=f[u],s=this._createViewModel(r),t=this.sorted_index(o,s),o.splice(t,0,s)}else o=this.models_only?y.clone(n.models):y.map(n.models,function(e){return l._createViewModel(e)});this.in_edit++,i(o),this.in_edit--;if(!e)return this.trigger("add",i())},t.prototype._sortAttributeFn=function(e){return this.models_only?function(t,n){return y.sortedIndex(t,n,function(t){return t.get(e)})}:function(t,n){return y.sortedIndex(t,n,function(t){return h.utils.wrappedModel(t).get(e)})}},t.prototype._createViewModel=function(e){return this.models_only?e:this.create_options.store.findOrCreateObservable(e,this.create_options)},t}(),E(h.CollectionObservable.prototype,e.Events),h.collectionObservable=function(e,t){return new h.CollectionObservable(e,t)},h.sortedIndexWrapAttr=h.siwa=function(e,t){return function(n,r){return y.sortedIndex(n,r,function(n){return new t(h.utils.wrappedModel(n).get(e))})}},h.DefaultWrapper=function(){function e(e,t){var n,r=this;return this.dv=t,n=h.utils.wrappedObservable(this,p.dependentObservable({read:function(){var t;return(t=p.utils.unwrapObservable(e()))?t:p.utils.unwrapObservable(r.dv)},write:function(t){return e(t)}})),n.destroy=y.bind(this.destroy,this),n.setToDefault=y.bind(this.setToDefault,this),n}return e.prototype.destroy=function(){return h.utils.wrappedDestroy(this)},e.prototype.setToDefault=function(){return h.utils.wrappedObservable(this)(this.dv)},e}(),h.defaultWrapper=function(e,t){return new h.DefaultWrapper(e,t)},h.toFormattedString=function(e){var t,n,r,i,s,o;s=e.slice(),n=f.call(arguments,1);for(r in n){t=n[r],o=p.utils.unwrapObservable(t),o||(o=""),i=e.indexOf("{"+r+"}");while(i>=0)s=s.replace("{"+r+"}",o),i=e.indexOf("{"+r+"}",i+1)}return s},h.parseFormattedString=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p;c=t.slice(),i=0,u=0,f={};while(c.search("\\{"+i+"\\}")>=0){a=t.indexOf("{"+i+"}");while(a>=0)c=c.replace("{"+i+"}","(.*)"),f[a]=i,u++,a=t.indexOf("{"+i+"}",a+1);i++}n=i,l=new RegExp(c),o=l.exec(e),o&&o.shift();if(!o||o.length!==u)return y.range(n).map(function(){return""});p=y.sortBy(y.keys(f),function(e,t){return parseInt(e,10)}),r={};for(s in p){a=p[s],i=f[a];if(r.hasOwnProperty(i))continue;r[i]=s}h=[],i=0;while(i<n)h.push(o[r[i]]),i++;return h},h.FormattedObservable=function(){function e(e,t){var n,r;return y.isArray(t)?(e=e,r=t):r=f.call(arguments,1),n=h.utils.wrappedObservable(this,p.dependentObservable({read:function(){var n,i,s;t=[p.utils.unwrapObservable(e)];for(i=0,s=r.length;i<s;i++)n=r[i],t.push(p.utils.unwrapObservable(n));return h.toFormattedString.apply(null,t)},write:function(t){var n,i,s;i=h.parseFormattedString(t,p.utils.unwrapObservable(e)),s=Math.min(r.length,i.length),n=0;while(n<s)r[n](i[n]),n++;return this}})),n}return e.prototype.destroy=function(){return h.utils.wrappedDestroy(this)},e}(),h.formattedObservable=function(e,t){return new h.FormattedObservable(e,f.call(arguments,1))},h.LocalizedObservable=function(){function t(e,t,n){var r,i=this;return this.value=e,this.vm=n,t||(t={}),this.vm||(this.vm={}),this.read||v(this,"read"),h.locale_manager||v(this,"kb.locale_manager"),this.__kb||(this.__kb={}),this.__kb._onLocaleChange=y.bind(this._onLocaleChange,this),this.__kb._onChange=t.onChange,this.value&&(e=p.utils.unwrapObservable(this.value)),this.vo=p.observable(e?this.read(e,null):null),r=h.utils.wrappedObservable(this,p.dependentObservable({read:function(){return i.value&&p.utils.unwrapObservable(i.value),i.vo(),i.read(p.utils.unwrapObservable(i.value))},write:function(e){i.write||m(i,"writing to read-only"),i.write(e,p.utils.unwrapObservable(i.value)),i.vo(e);if(i.__kb._onChange)return i.__kb._onChange(e)},owner:this.vm})),r.destroy=y.bind(this.destroy,this),r.observedValue=y.bind(this.observedValue,this),r.resetToCurrent=y.bind(this.resetToCurrent,this),h.locale_manager.bind("change",this.__kb._onLocaleChange),t.hasOwnProperty("default")&&(r=p.defaultWrapper(r,t["default"])),r}return t.extend=e.Model.extend,t.prototype.destroy=function(){return h.locale_manager.unbind("change",this.__kb._onLocaleChange),this.vm=null,h.utils.wrappedDestroy(this)},t.prototype.resetToCurrent=function(){var e,t;t=h.utils.wrappedObservable(this),e=this.value?this.read(p.utils.unwrapObservable(this.value)):null;if(t()===e)return;return t(e)},t.prototype.observedValue=function(e){return arguments.length===0?this.value:(this.value=e,this._onLocaleChange(),this)},t.prototype._onLocaleChange=function(){var e;e=this.read(p.utils.unwrapObservable(this.value)),this.vo(e);if(this.__kb._onChange)return this.__kb._onChange(e)},t}(),h.localizedObservable=function(e,t,n){return new h.LocalizedObservable(e,t,n)},h.Observable=function(){function e(e,t,n){var r,i,s,o=this;return this.vm=n,t||v(this,"options"),this.vm||(this.vm={}),y.isString(t)||p.isObservable(t)?r=this.create_options={key:t}:r=this.create_options=c(t),this.key=r.key,delete r.key,this.key||v(this,"key"),!r.args||(this.args=r.args,delete r.args),!r.read||(this.read=r.read,delete r.read),!r.write||(this.write=r.write,delete r.write),i=r.model_watcher,delete r.model_watcher,this.vo=p.observable(null),s=h.utils.wrappedObservable(this,p.dependentObservable({read:function(){var e,t,n,r,i,s;t=[p.utils.unwrapObservable(o.key)];if(o.args)if(y.isArray(o.args)){s=o.args;for(r=0,i=s.length;r<i;r++)e=s[r],t.push(p.utils.unwrapObservable(e))}else t.push(p.utils.unwrapObservable(o.args));return o.m&&(n=o.read?o.read.apply(o.vm,t):o.m.get.apply(o.m,t),o.update(n)),p.utils.unwrapObservable(o.vo())},write:function(e){var t,n,r,i,s,u;r={},r[p.utils.unwrapObservable(o.key)]=e,n=o.write?[e]:[r];if(o.args)if(y.isArray(o.args)){u=o.args;for(i=0,s=u.length;i<s;i++)t=u[i],n.push(p.utils.unwrapObservable(t))}else n.push(p.utils.unwrapObservable(o.args));return o.m&&(o.write?o.write.apply(o.vm,n):o.m.set.apply(o.m,n)),o.update(e)},owner:this.vm})),s.__kb_is_o=!0,r.store=h.utils.wrappedStore(s,r.store),r.path=h.utils.pathJoin(r.path,this.key),r.factories&&(typeof r.factories=="function"||r.factories.create)?(r.factory=h.utils.wrappedFactory(s,new h.Factory(r.factory)),r.factory.addPathMapping(r.path,r.factories)):r.factory=h.Factory.useOptionsOrCreate(r,s,r.path),delete r.factories,s.value=y.bind(this.value,this),s.valueType=y.bind(this.valueType,this),s.destroy=y.bind(this.destroy,this),h.ModelWatcher.useOptionsOrCreate({model_watcher:i},e,this,{model:y.bind(this.model,this),update:y.bind(this.update,this),key:this.key,path:r.path}),this.__kb_value||this.update(),r.localizer&&(s=new r.localizer(s),delete r.localizer),r.hasOwnProperty("default")&&(s=h.defaultWrapper(s,r["default"]),delete r["default"]),s}return e.prototype.destroy=function(){return this.__kb_destroyed=!0,h.release(this.__kb_value),this.__kb_value=null,this.vm=null,this.create_options=null,h.utils.wrappedDestroy(this)},e.prototype.value=function(){return this.__kb_value},e.prototype.valueType=function(){var e;return e=this.m?this.m.get(this.key):null,this.value_type||this._updateValueObservable(e),this.value_type},e.prototype.setToDefault=function(){var e;return(e=this.__kb_value)!=null&&typeof e.setToDefault=="function"&&e.setToDefault(),this},e.prototype.model=function(e){return arguments.length===0||this.m===e?this.m:(this.m=e,this.__kb_destroyed||this.update())},e.prototype.update=function(e){var i,o;this.m&&!arguments.length&&(e=this.m.get(p.utils.unwrapObservable(this.key))),e||(e=null),i=h.utils.valueType(e);if(!this.__kb_value||this.__kb_value.__kb_destroyed||this.__kb_value.__kb_null&&e)this.__kb_value=null,this.value_type=void 0;o=this.__kb_value;if(y.isUndefined(this.value_type)||this.value_type!==i&&i!==s)return this.value_type===n&&i===t?o(e):this._updateValueObservable(e);if(this.value_type===r){if(typeof o.model=="function"){if(o.model()!==e)return o.model(e)}else if(h.utils.wrappedObject(o)!==e)return this._updateValueObservable(e)}else if(this.value_type===n){if(o.collection()!==e)return o.collection(e)}else if(o()!==e)return o(e)},e.prototype._updateValueObservable=function(e){var t,o,u,a;return t=this.create_options,t.creator=h.utils.inferCreator(e,t.factory,t.path,this.m,this.key),this.value_type=s,o=t.creator,u=this.__kb_value,this.__kb_value=null,u&&h.release(u),o?t.store?a=t.store.findOrCreateObservable(e,t):o.models_only?(a=e,this.value_type=i):o.create?a=o.create(e,t):a=new o(e,t):(this.value_type=i,y.isArray(e)?a=p.observableArray(e):a=p.observable(e)),this.value_type===s&&(p.isObservable(a)?a.__kb_is_co?this.value_type=n:this.value_type=i:(this.value_type=r,typeof a.model!="function"&&h.utils.wrappedObject(a,e))),this.__kb_value=a,this.vo(a)},e}(),h.observable=function(e,t,n){return new h.Observable(e,t,n)},h.TriggeredObservable=function(){function e(e,t){var n,r=this;return this.event_name=t,e||v(this,"model"),this.event_name||v(this,"event_name"),this.vo=p.observable(),n=h.utils.wrappedObservable(this,p.dependentObservable(function(){return r.vo()})),n.destroy=y.bind(this.destroy,this),h.utils.wrappedModelWatcher(this,new h.ModelWatcher(e,this,{model:y.bind(this.model,this),update:y.bind(this.update,this),event_name:this.event_name})),n}return e.prototype.destroy=function(){return h.utils.wrappedDestroy(this)},e.prototype.model=function(e){if(arguments.length===0||this.m===e)return this.m;if(this.m=e)return this.update()},e.prototype.update=function(){if(!this.m)return;return this.vo()!==this.m?this.vo(this.m):this.vo.valueHasMutated()},e}(),h.triggeredObservable=function(e,t){return new h.TriggeredObservable(e,t)},h.ViewModel=function(){function t(e,t,n){var r,i,s,o,u,a,f;t||(t={}),n||(n={}),y.isArray(t)?t={keys:t}:t=c(t),this.__kb||(this.__kb={}),this.__kb.vm_keys={},this.__kb.model_keys={},this.__kb.view_model=y.isUndefined(n)?this:n,!t.internals||(this.__kb.internals=t.internals),!t.excludes||(this.__kb.excludes=t.excludes),h.Store.useOptionsOrCreate(t,e,this),this.__kb.path=t.path,h.Factory.useOptionsOrCreate(t,this,t.path),u=h.utils.wrappedModelWatcher(this,new h.ModelWatcher(e,this,{model:y.bind(this.model,this)}));if(t.keys)if(y.isArray(t.keys))i=this.__kb.keys=t.keys;else{s={},f=t.keys;for(a in f)o=f[a],s[y.isString(o)?o:o.key?o.key:a]=!0;this.__kb.keys=y.keys(s)}else r=u.model(),r&&r.attributes&&(i=y.keys(r.attributes));i&&this.__kb.excludes&&(i=y.difference(i,this.__kb.excludes)),this.__kb.internals&&(i=i?y.union(i,this.__kb.internals):this.__kb.internals),t.requires&&y.isArray(t.requires)&&(i=i?y.union(i,t.requires):t.requires),y.isObject(t.keys)&&!y.isArray(t.keys)&&this._mapObservables(e,t.keys),y.isObject(t.requires)&&!y.isArray(t.requires)&&this._mapObservables(e,t.requires),!t.mappings||this._mapObservables(e,t.mappings),!i||this._createObservables(e,i),!h.statistics||h.statistics.register(this)}return t.extend=e.Model.extend,t.prototype.destroy=function(){var e;if(this.__kb.view_model!==this)for(e in this.__kb.vm_keys)this.__kb.view_model[e]=null;return this.__kb.view_model=null,h.releaseKeys(this),h.utils.wrappedDestroy(this),!h.statistics||h.statistics.unregister(this)},t.prototype.shareOptions=function(){return{store:h.utils.wrappedStore(this),factory:h.utils.wrappedFactory(this)}},t.prototype.model=function(e){var t,n,r;n=h.utils.wrappedObject(this);if(arguments.length===0||n===e)return n;if(this.__kb_null){!e||m(this,"model set on shared null");return}h.utils.wrappedObject(this,e),r=h.utils.wrappedModelWatcher(this);if(!r)return;r.model(e);if(this.__kb.keys||!e||!e.attributes)return;t=y.difference(y.keys(e.attributes),y.keys(this.__kb.model_keys));if(t)return this._createObservables(e,t)},t.prototype.setToDefault=function(){var e,t;for(e in this.__kb.vm_keys)(t=this[e])!=null&&typeof t.setToDefault=="function"&&t.setToDefault();return this},t.prototype._createObservables=function(e,t){var n,r,i,s,o;n={store:h.utils.wrappedStore(this),factory:h.utils.wrappedFactory(this),path:this.__kb.path,model_watcher:h.utils.wrappedModelWatcher(this)};for(s=0,o=t.length;s<o;s++){r=t[s],i=this.__kb.internals&&y.contains(this.__kb.internals,r)?"_"+r:r;if(this[i])continue;this.__kb.vm_keys[i]=!0,this.__kb.model_keys[r]=!0,n.key=r,this[i]=this.__kb.view_model[i]=h.observable(e,n,this)}return this},t.prototype._mapObservables=function(e,t){var n,r,i;n={store:h.utils.wrappedStore(this),factory:h.utils.wrappedFactory(this),path:this.__kb.path,model_watcher:h.utils.wrappedModelWatcher(this)};for(i in t){r=t[i];if(this[i])continue;r=y.isString(r)?{key:r}:y.clone(r),r.key||(r.key=i),this.__kb.vm_keys[i]=!0,this.__kb.model_keys[r.key]=!0,this[i]=this.__kb.view_model[i]=h.observable(e,y.defaults(r,n),this)}return this},t}(),h.viewModel=function(e,t,n){return new h.ViewModel(e,t,n)},h.observables=function(e,t,n){return d("ko.observables","0.16.0","Please use kb.viewModel instead"),new h.ViewModel(e,t,n)}}).call(this);