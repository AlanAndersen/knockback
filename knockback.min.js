/*
 knockback.js 0.3.0
 (c) 2011 Kevin Malakoff.
 Knockback.js is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/knockback/blob/master/LICENSE
 Dependencies: Knockout.js, Backbone.js, and Underscore.js.
 Optional dependency: Backbone.ModelRef.js.
*/
if(!this.ko){throw new Error("Knockback: Dependency alert! Knockout.js must be included before this file")}if(!this.Backbone){throw new Error("Knockback: Dependency alert! Backbone.js must be included before this file")}if(!this._||!this._.VERSION){throw new Error("Knockback: Dependency alert! Underscore.js must be included before this file")}this.Knockback||(this.Knockback={});this.kb||(this.kb=this.Knockback);Knockback.VERSION="0.3.0";Knockback.locale_manager;Knockback.wrappedObservable=function(a){if(!a._kb_observable){throw new Error("Knockback: _kb_observable missing from your instance")}return a._kb_observable};Knockback.viewModelDestroyObservables=Knockback.vmDestroy=function(b){var c,d,a;a=[];for(c in b){d=b[c];a.push((function(e,f){if(!f||!(f.__kb_owner||(f instanceof kb.ModelAttributeObservables)||(f instanceof kb.CollectionSync))){return}f.destroy();return b[e]=null})(c,d))}return a};var __bind=function(a,b){return function(){return a.apply(b,arguments)}};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.CollectionSync=(function(){function a(h,i,k){var b,f,e,j,c,g,d;this.collection=h;this.observable_array=i;this.options=k;if(!this.collection){throw new Error("CollectionSync: collection is missing")}if(!this.observable_array){throw new Error("CollectionSync: observable_array is missing")}if(!this.options){throw new Error("CollectionSync: options is missing")}if(!this.options.viewModelCreate){throw new Error("CollectionSync: options.viewModelCreate is missing")}_.bindAll(this,"_onCollectionReset","_onCollectionResort","_onModelAdd","_onModelRemove","_onModelChanged");if(this.collection.retain){this.collection.retain()}this.collection.bind("reset",this._onCollectionReset);if(!this.options.sortedIndex){this.collection.bind("resort",this._onCollectionResort)}g=["new","add"];for(f=0,j=g.length;f<j;f++){b=g[f];this.collection.bind(b,this._onModelAdd)}d=["remove","destroy"];for(e=0,c=d.length;e<c;e++){b=d[e];this.collection.bind(b,this._onModelRemove)}if(this.options.sortedIndex){this.collection.bind("change",this._onModelChanged)}this._onCollectionReset(this.collection)}a.prototype.destroy=function(){var e,g,d,c,b,f,h;this.collection.unbind("reset",this._onCollectionReset);if(!this.options.sortedIndex){this.collection.unbind("resort",this._onCollectionResort)}f=["new","add"];for(g=0,c=f.length;g<c;g++){e=f[g];this.collection.unbind(e,this._onModelAdd)}h=["remove","destroy"];for(d=0,b=h.length;d<b;d++){e=h[d];this.collection.unbind(e,this._onModelRemove)}if(this.options.sortedIndex){this.collection.unbind("change",this._onModelChanged)}if(this.collection.release){this.collection.release()}this.collection=null;this.observable_array;return this.options=null};a.prototype.modelByViewModel=function(b){return _.find(this.observable_array(),function(c){return c===b})};a.prototype.viewModelByModel=function(c){var b;b=c.hasOwnProperty(c.idAttribute)?c.idAttribute:"cid";return _.find(this.observable_array(),function(d){return d.__kb_model[b]===c[b]})};a.prototype.elementByModel=function(c){var b;b=this.viewModelByModel(c);if(b){return b.__kb_element}else{return null}};a.prototype.eachViewModel=function(e){var d,g,c,f,b;f=this.observable_array();b=[];for(g=0,c=f.length;g<c;g++){d=f[g];b.push(e(d))}return b};a.prototype._onCollectionReset=function(){var j,e,k,l,p,r,g,d,c,b,o,s,q,n,m,i,h,f;l=this.observable_array.removeAll();p=__bind(function(t){if(this.options.onViewModelRemove){this.options.onViewModelRemove(t)}return kb.vmDestroy(t)},this);for(g=0,o=l.length;g<o;g++){k=l[g];p(k)}l=[];if(this.options.sortedIndex){e=[];m=this.collection.models;r=__bind(function(u){var t;k=this._viewModelCreate(u);t=this.options.sortedIndex(e,u);e.splice(t,0,u);return l.splice(t,0,k)},this);for(d=0,s=m.length;d<s;d++){j=m[d];r(j)}}else{i=this.collection.models;for(c=0,q=i.length;c<q;c++){j=i[c];l.push(this._viewModelCreate(j))}}this.observable_array(l);if(this.options.onViewModelAdd){h=this.observable_array();f=[];for(b=0,n=h.length;b<n;b++){k=h[b];f.push(this.options.onViewModelAdd(k))}return f}};a.prototype._onCollectionResort=function(f){var d,e,c,b;if(this.options.sortedIndex){throw new Error("CollectionSync: collection sorting unexpected")}if(_.isArray(f)){b=[];for(e=0,c=f.length;e<c;e++){d=f[e];b.push(this._viewModelResort(this.viewModelByModel(d)))}return b}else{return this._viewModelResort(this.viewModelByModel(f))}};a.prototype._onModelAdd=function(d){var b,e,c;c=this._viewModelCreate(d);if(this.options.sortedIndex){e=_.pluck(this.observable_array(),"__kb_model");b=this.options.sortedIndex(e,d)}else{b=this.collection.indexOf(d)}this.observable_array.splice(b,0,c);if(this.options.onViewModelAdd){return this.options.onViewModelAdd(c,this.observable_array())}};a.prototype._onModelRemove=function(c){var b;b=this.viewModelByModel(c);if(!b){throw new Error("CollectionSync: view_model not found for remove")}this.observable_array.remove(b);if(this.options.onViewModelRemove){this.options.onViewModelRemove(b,this.observable_array())}kb.vmDestroy(b);b.__kb_model=null;return b.__kb_element=null};a.prototype._onModelChanged=function(c){var b;if(!this.options.sortedIndex){throw new Error("CollectionSync: change sorting unexpected")}if(this.options.sort_attribute&&!c.hasChanged(this.options.sort_attribute)){return}b=this.viewModelByModel(c);if(!b){throw new Error("CollectionSync: view_model not found for resort")}return this._viewModelResort(b)};a.prototype._viewModelCreate=function(c){var b;b=this.options.viewModelCreate(c);if(b.__kb_model){throw new Error("CollectionSync: _model is reserved")}if(b.__kb_element){throw new Error("CollectionSync: _element is reserved")}b.__kb_model=c;b.afterRender=this._bindAfterRender(b);return b};a.prototype._bindAfterRender=function(b){var c;c=b.afterRender;return b.afterRender=function(d){b.__kb_element=d;if(c){return c.call(b,d)}}};a.prototype._viewModelResort=function(c){var d,b,f,e;f=this.observable_array.indexOf(c);d=c.__kb_model;if(this.options.sortedIndex){e=_.pluck(this.observable_array(),"__kb_model");e.splice(f,1);b=this.options.sortedIndex(e,d)}else{b=this.collection.indexOf(d)}if(f===b){return}this.observable_array.splice(f,1);this.observable_array.splice(b,0,c);if(this.options.onViewModelResort){return this.options.onViewModelResort(c,this.observable_array(),b)}};return a})();Knockback.collectionSync=function(c,a,b){return new Knockback.CollectionSync(c,a,b)};Knockback.viewModelGetModel=Knockback.vmModel=function(a){return a.__kb_model};Knockback.viewModelGetElement=Knockback.vmElement=function(a){return a.__kb_element};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.LocalizedObservable=(function(){function a(d,c,b){this.value=d;this.options=c!=null?c:{};this.view_model=b;if(!this.value){throw new Error("LocalizedObservable: value is missing")}if(!(this.options.read||this.read)){throw new Error("LocalizedObservable: options.read is missing")}if(this.options.read&&this.read){throw new Error("LocalizedObservable: options.read and read class function exist. You need to choose one.")}if(this.options.write&&this.write){throw new Error("LocalizedObservable: options.read and read class function exist. You need to choose one.")}if(!kb.locale_manager){throw new Error("LocalizedObservable: Knockback.locale_manager is not defined")}_.bindAll(this,"destroy","_onGetValue","_onSetValue","getObservedValue","setObservedValue","_onLocaleChange");this._kb_read=this.options.read?this.options.read:this.read;this._kb_write=this.options.write?this.options.write:this.write;if(this.value){this.current_localized_value=this._kb_read.call(this,this.value,this._kb_observable)}if(this.options.onChange){this.options.onChange(this.current_localized_value)}if(this._kb_write){if(!this.view_model){this.view_model={}}if(!_.isFunction(this._kb_write)){throw new Error("LocalizedObservable: options.write is not a function for read_write model attribute")}this._kb_observable=ko.dependentObservable({read:this._onGetValue,write:this._onSetValue,owner:this.view_model})}else{this._kb_observable=ko.dependentObservable(this._onGetValue)}if(_.isUndefined(this._kb_observable.forceRefresh)){throw new Error("Knockback: forceRefresh is missing. Please upgrade to a compatible version of Knockout.js")}kb.locale_manager.bind("change",this._onLocaleChange);this._kb_observable.getObservedValue=this.getObservedValue;this._kb_observable.setObservedValue=this.setObservedValue;this._kb_observable.destroy=this.destroy;this._kb_observable.__kb_owner=this;return kb.wrappedObservable(this)}a.prototype.destroy=function(){kb.locale_manager.unbind("change",this._onLocaleChange);this._kb_observable.dispose();this._kb_observable=null;this.options={};return this.view_model=null};a.prototype.getObservedValue=function(){return this.value};a.prototype.setObservedValue=function(b){this.value=b;return this};a.prototype._getDefault=function(){if(!this.options.hasOwnProperty("default")){return""}if(_.isFunction(this.options["default"])){return this.options["default"]()}else{return this.options["default"]}};a.prototype._onGetValue=function(){return this.current_localized_value};a.prototype._onSetValue=function(b){return this._kb_write.call(this,b,this.value,this._kb_observable)};a.prototype._onLocaleChange=function(){this.current_localized_value=!this.value?this._getDefault():this._kb_read.call(this,this.value,this._kb_observable);this._kb_observable.forceRefresh();if(this.options.onChange){return this.options.onChange(this.current_localized_value)}};return a})();Knockback.localizedObservable=function(c,b,a){return new Knockback.LocalizedObservable(c,b,a)};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.ModelAttributeObservable=(function(){function a(d,c,b){this.model=d;this.bind_info=c;this.view_model=b;if(!this.model){throw new Error("ModelAttributeObservable: value is missing")}if(!this.bind_info){throw new Error("ModelAttributeObservable: bind_info is missing")}if(!this.bind_info.key){throw new Error("ModelAttributeObservable: bind_info.key is missing")}_.bindAll(this,"destroy","_onValueChange","_onGetValue","_onSetValue","_onModelLoaded","_onModelUnloaded");if(Backbone.ModelRef&&(this.model instanceof Backbone.ModelRef)){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this._onModelLoaded);this.model_ref.bind("unloaded",this._onModelUnloaded);this.model=this.model_ref.getModel()}this.in_create=true;if(this.bind_info.write){if(!this.view_model){throw new Error("ModelAttributeObservable: view_model is missing for read_write model attribute")}this._kb_observable=ko.dependentObservable({read:this._onGetValue,write:this._onSetValue,owner:this.view_model})}else{this._kb_observable=ko.dependentObservable(this._onGetValue)}this.in_create=false;if(_.isUndefined(this._kb_observable.forceRefresh)){throw new Error("Knockback: forceRefresh is missing. Please upgrade to a compatible version of Knockout.js")}this._kb_observable.destroy=this.destroy;this._kb_observable.__kb_owner=this;if(!this.model_ref||this.model_ref.isLoaded()){this._onModelLoaded(this.model)}return kb.wrappedObservable(this)}a.prototype.destroy=function(){this._kb_observable.dispose();this._kb_observable=null;if(this.model){this._onModelUnloaded(this.model)}if(this.model_ref){this.model_ref.unbind("loaded",this._onModelLoaded);this.model_ref.unbind("unloaded",this._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.bind_info=null;return this.view_model=null};a.prototype._getDefault=function(){if(!this.bind_info.hasOwnProperty("default")){return}if(_.isFunction(this.bind_info["default"])){return this.bind_info["default"]()}else{return this.bind_info["default"]}};a.prototype._onValueChange=function(){if(this.localizer&&this.localizer.forceRefresh){if(this.model){this.localizer.setObservedValue(this.model.get(this.bind_info.key))}this.localizer.forceRefresh()}return this._kb_observable.forceRefresh()};a.prototype._onGetValue=function(){var b;if(!this.model){return this._getDefault()}if(this.localizer){return this.localizer()}b=this.bind_info.read?this.bind_info.read.apply(this.view_model,[this.model,this.bind_info.key]):this.model.get(this.bind_info.key);if(b){return b}else{return this._getDefault()}};a.prototype._onSetValue=function(c){var b;if(!this.model){return}if(this.localizer){this.localizer(c);return}if(c&&this.bind_info.localizer){this.localizer=this.bind_info.localizer(c)}b={};b[this.bind_info.key]=c;if(_.isFunction(this.bind_info.write)){return this.bind_info.write.apply(this.view_model,[c,this.model,b])}else{return this.model.set(b)}};a.prototype._onModelLoaded=function(b){var c;this.model=b;this.model.bind("change",this._onValueChange);this.model.bind("change:"+this.bind_info.key,this._onValueChange);c=this.bind_info.read?this.bind_info.read.apply(this.view_model,[this.model,this.bind_info.key]):this.model.get(this.bind_info.key);if(c&&this.bind_info.localizer){this.localizer=this.bind_info.localizer(c)}if(!this.in_create){return this._onValueChange()}};a.prototype._onModelUnloaded=function(){if(this.localizer&&this.localizer.destroy){this.localizer.destroy();this.localizer=null}this.model.unbind("change",this._onValueChange);this.model.unbind("change:"+this.bind_info.key,this._onValueChange);return this.model=null};return a})();Knockback.Observable=Knockback.ModelAttributeObservable;Knockback.observable=function(c,b,a){return new Knockback.Observable(c,b,a)};var __bind=function(a,b){return function(){return a.apply(b,arguments)}};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.ModelAttributeObservables=(function(){function a(c,f,b){var d,g,e;this.model=c;this.mappings_info=f;this.view_model=b;if(!this.model){throw new Error("ModelAttributeObservables: model is missing")}if(!this.mappings_info){throw new Error("ModelAttributeObservables: mappings_info is missing")}e=this.mappings_info;for(g in e){d=e[g];this.view_model[g]=kb.observable(this.model,d,this.view_model)}return this}a.prototype.destroy=function(){var b,e,d,c;c=this.mappings_info;d=__bind(function(g,f){if(this.view_model[g]){this.view_model[g].destroy()}return this.view_model[g]=null},this);for(e in c){b=c[e];d(e,b)}this.view_model=null;this.mappings_info=null;return this.model=null};a.prototype.forceRefresh=function(){var c,e,d,b;d=this.mappings_info;b=[];for(e in d){c=d[e];b.push(this.view_model[e].forceRefresh())}return b};return a})();Knockback.Observables=Knockback.ModelAttributeObservables;Knockback.observables=function(b,c,a){return new Knockback.Observables(b,c,a)};