// Generated by CoffeeScript 1.3.3
/*
  knockback.js 0.16.0beta1
  (c) 2011, 2012 Kevin Malakoff.
  Knockback.js is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/knockback/blob/master/LICENSE
  Dependencies: Knockout.js, Backbone.js, and Underscore.js.
    Optional dependency: Backbone.ModelRef.js.
*/(function(){var e,t,n,r,i,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};if(typeof require!="undefined")try{i=require("lodash")}catch(u){i=require("underscore")}else i=this._;i&&i.hasOwnProperty("_")&&(i=i._),e=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,r=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko,t=n=this.Knockback=this.kb=typeof exports!="undefined"?exports:{},n.VERSION="0.16.0beta1",n.locale_manager=void 0,n.TYPE_UNKNOWN=0,n.TYPE_SIMPLE=1,n.TYPE_MODEL=2,n.TYPE_COLLECTION=3,n.Statistics=function(){function e(){this.type_trackers={}}return e.prototype.typeTracker=function(e){var t;return this.type_trackers.hasOwnProperty(e)?this.type_trackers[e]:(t=[],this.type_trackers[e]=t,t)},e.prototype.register=function(e,t){return this.typeTracker(e).push(t)},e.prototype.unregister=function(e,t){var n,r;r=this.typeTracker(e),n=i.indexOf(r,t);if(n<0)throw"failed to unregister type: "+e;return r.splice(n,1)},e.prototype.registeredCount=function(e){return this.typeTracker(e).length},e}(),n.utils={},n.utils.legacyWarning=function(e,t,r){var i;return n._legacy_warnings||(n._legacy_warnings={}),(i=n._legacy_warnings)[e]||(i[e]=0),n._legacy_warnings[e]++,console.warn("warning: '"+e+"' has been deprecated (will be removed in Knockback after "+t+"). "+r+".")},n.utils.wrappedDestroy=function(e){var t;if(!e.__kb)return;t=e.__kb,e.__kb=null,t.model_ref&&n.utils.wrappedModelRef(e,null),t.value_observable&&!t.store&&n.utils.release(t.value_observable),t.observable&&(n.utils.wrappedDestroy(t.observable),t.observable.dispose&&t.observable.dispose());if(t.store_is_owned)return t.store.destroy()},n.utils.wrappedByKey=function(e,t,n){if(arguments.length===2)return e&&e.__kb&&e.__kb.hasOwnProperty(t)?e.__kb[t]:void 0;if(!e)throw"Knockback: no owner for wrapping "+t;return e.__kb||(e.__kb={}),e.__kb[t]=n,n},n.utils.wrappedObservable=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"observable"):(n.utils.wrappedByKey(e,"observable",t),t&&n.utils.wrappedByKey(t,"instance",e),t)},n.utils.wrappedModel=function(e,t){var r;return arguments.length===1?(r=n.utils.wrappedByKey(e,"obj"),i.isUndefined(r)?e:r):n.utils.wrappedByKey(e,"obj",t)},n.utils.wrappedModelRef=function(e,t,r){var i,s;return s=n.utils.wrappedByKey(e,"model_ref"),arguments.length===1?s:t===s?t:(t&&t.retain(),s&&(i=n.utils.wrappedByKey(e,"model_ref_options"),s.unbind("loaded",i.loaded)(i.loaded),s.unbind("unloaded",i.unloaded)(i.unloaded),s.release()),n.utils.wrappedByKey(e,"model_ref",t),t&&(r=n.utils.wrappedByKey(e,"model_ref_options",r?r:{}),r.loaded&&t.bind("loaded",r.loaded),r.unloaded&&t.bind("unloaded",r.unloaded)),t)},n.utils.wrappedObject=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"obj"):n.utils.wrappedByKey(e,"obj",t)},n.utils.wrappedStore=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"store"):n.utils.wrappedByKey(e,"store",t)},n.utils.wrappedStoreIsOwned=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"store_is_owned"):n.utils.wrappedByKey(e,"store_is_owned",t)},n.utils.wrappedFactory=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"factory"):n.utils.wrappedByKey(e,"factory",t)},n.utils.wrappedPath=function(e,t){return arguments.length===1?n.utils.wrappedByKey(e,"path"):n.utils.wrappedByKey(e,"path",t)},n.utils.setToDefault=function(e){var t,s,o;if(!e)return;if(r.isObservable(e))return typeof e.setToDefault=="function"?e.setToDefault():void 0;if(i.isObject(e)){o=[];for(t in e)s=e[t],o.push(s&&t!=="__kb"?n.utils.setToDefault(s):void 0);return o}},n.utils.release=function(e,t){var s,o;if(!e)return!1;if(!t&&(r.isObservable(e)||e instanceof n.Observables||typeof e.release=="function"||typeof e.destroy=="function"))return e.release?e.release():e.destroy?e.destroy():e.dispose&&e.dispose(),!0;if(i.isObject(e)&&typeof e!="function"){for(s in e){o=e[s];if(!o||s==="__kb"||typeof o=="function"&&!r.isObservable(o))continue;n.utils.release(o)&&(e[s]=null)}return!0}return!1},n.utils.valueType=function(e){var t;return e?e instanceof n.ViewModel?n.TYPE_MODEL:!e.__kb||!e.__kb.instance?n.TYPE_SIMPLE:(t=e.__kb.instance,t instanceof n.AttributeObservable?e.valueType():t instanceof n.CollectionObservable?n.TYPE_COLLECTION:n.TYPE_SIMPLE):n.TYPE_UNKNOWN},n.utils.observableInstanceOf=function(e,t){return e?!e.__kb||!e.__kb.instance?!1:e.__kb.instance instanceof t:!1},n.utils.pathJoin=function(e,t){var n;return e?n=e[e.length-1]!=="."?""+e+".":e:n="",n+=t,n},n.utils.optionsPathJoin=function(e,t){return i.defaults({path:n.utils.pathJoin(e.path,t)},e)},n.RefCountable=function(){function t(){this.__kb_ref_count=1}return t.extend=e.Model.extend,t.prototype.__destroy=function(){},t.prototype.retain=function(){if(this.__kb_ref_count<=0)throw"RefCountable: ref_count is corrupt: "+this.__kb_ref_count;return this.__kb_ref_count++,this},t.prototype.release=function(e){if(this.__kb_ref_count<=0)throw"RefCountable: ref_count is corrupt: "+this.__kb_ref_count;return e?this.__kb_ref_count=0:this.__kb_ref_count--,this.__kb_ref_count||this.__destroy(),this},t.prototype.refCount=function(){return this.__kb_ref_count},t}(),n.Factory=function(){function t(e){this.parent_factory=e,this.paths={}}return t.prototype.hasPath=function(e){return this.paths.hasOwnProperty(e)||this.parent_factory&&this.parent_factory.hasPath(e)},t.prototype.addPathMapping=function(e,t){return this.paths[e]=t},t.prototype.addPathMappings=function(e){var t,n,r;r=[];for(n in e)t=e[n],r.push(this.paths[n]=t);return r},t.prototype.creatorForPath=function(t,r){var i;i=this.paths[r];if(i)return i.view_model?i.view_model:i;if(this.parent_factory){i=this.parent_factory.creatorForPath(t,r);if(i)return i}return t instanceof e.Model?n.ViewModel:t instanceof e.Collection?n.CollectionObservable:null},t.prototype.createForPath=function(e,t,i,s){s||(s=this.creatorForPath(e,t));if(!s)return r.observable(e);if(s.hasOwnProperty("models_only"))return e(s.models_only);if(typeof s=="function")return new s(e,{store:i,factory:this,path:t,creator:s});if(s.create)return s.create(e,{store:i,factory:this,path:t,creator:s});throw"unrecognized creator for "+t},t.createDefault=function(t,i){return t instanceof e.Model?n.viewModel(t,i):t instanceof e.Collection?n.collectionObservable(t,i):r.observable(t)},t}(),n.Store=function(){function t(){this.objects=[],this.observables=[]}return t.registerOrCreateStoreFromOptions=function(e,t,r){return r.store?(n.utils.wrappedStore(t,r.store),r.store.registerObservable(e,t,r)):(n.utils.wrappedStore(t,new n.Store),n.utils.wrappedStoreIsOwned(t,!0))},t.prototype.destroy=function(){var e,t,r,i;this.objects=null,r=this.observables;for(e in r){t=r[e];if(!n.utils.observableInstanceOf(t,n.CollectionObservable))continue;this.observables[e]=null,t.release(!0)}i=this.observables;for(e in i){t=i[e];if(!t)continue;this.observables[e]=null,t&&t.release?t.release(!0):n.utils.release(t)}return this.observables=null},t.prototype.registerObservable=function(e,t,r){r==null&&(r={});if(!e)return;this.objects.push(e),n.utils.wrappedObject(t,e),this.observables.push(t),typeof t.retain=="function"&&t.retain();if(r.creator)return t.__kb.creator=r.creator;if(r.path&&r.factory)return t.__kb.creator=r.factory.creatorForPath(e,r.path)},t.prototype.findOrCreateObservable=function(t,n,s){var o,u,a,f,l,c,h;o=s.creatorForPath(t,n);if(!o)return r.observable(t);if(o.models_only)return t;if(!(t instanceof e.Collection)){h=this.objects;for(u=l=0,c=h.length;l<c;u=++l){f=h[u],a=this.observables[u];if(f===t&&a.__kb.creator===o)return typeof a.retain=="function"&&a.retain(),a}}a=s.createForPath(t,n,this,o);if(!a)throw"Factory counldn't create observable for "+n;return u=i.indexOf(this.observables,a),u<0&&this.registerObservable(t,a,{creator:o}),a},t.prototype.releaseObservable=function(e,t){var r;if(!e)return;r=i.indexOf(this.observables,e);if(r>=0){if(arguments.length===2&&!t&&!e.release)return;n.utils.release(e);if(e.refCount&&e.refCount()>0)return;return n.utils.wrappedObject(e,null),this.observables[r]!==e&&(r=i.indexOf(this.observables,e)),this.objects[r]=null,this.observables[r]=null}return},t}(),n.CollectionObservable=function(e){function t(e,s){var o,u;s==null&&(s={});if(!e)throw"CollectionObservable: collection is missing";return t.__super__.constructor.apply(this,arguments),n.statistics&&n.statistics.register("kb.CollectionObservable",this),u=n.utils.wrappedObservable(this,r.observableArray([])),this.in_edit=0,this.__kb||(this.__kb={}),this.__kb._onCollectionReset=i.bind(this._onCollectionReset,this),this.__kb._onCollectionResort=i.bind(this._onCollectionResort,this),this.__kb._onModelAdd=i.bind(this._onModelAdd,this),this.__kb._onModelRemove=i.bind(this._onModelRemove,this),this.__kb._onModelChange=i.bind(this._onModelChange,this),n.Store.registerOrCreateStoreFromOptions(e,u,s),o=n.utils.wrappedFactory(u,new n.Factory(s.factory)),s.mappings&&o.addPathMappings(s.mappings),n.utils.wrappedPath(u,s.path),this.models_path=n.utils.pathJoin(s.path,"models"),o.hasPath(this.models_path)||(s.hasOwnProperty("models_only")?s.models_only?(o.addPathMapping(this.models_path,{models_only:s.models_only}),this.models_only=s.models_only):o.addPathMapping(this.models_path,n.ViewModel):s.view_model?o.addPathMapping(this.models_path,s.view_model):s.create?o.addPathMapping(this.models_path,{create:s.create}):o.addPathMapping(this.models_path,n.ViewModel)),this.sort_attribute=s.sort_attribute,this.sorted_index=s.sorted_index,u.retain=i.bind(this.retain,this),u.refCount=i.bind(this.refCount,this),u.release=i.bind(this.release,this),u.collection=i.bind(this.collection,this),u.viewModelByModel=i.bind(this.viewModelByModel,this),u.sortedIndex=i.bind(this.sortedIndex,this),u.sortAttribute=i.bind(this.sortAttribute,this),u.hasViewModels=i.bind(this.hasViewModels,this),u.bind=i.bind(this.bind,this),u.unbind=i.bind(this.unbind,this),u.trigger=i.bind(this.trigger,this),n.utils.wrappedObject(u,null),this.collection(e,{silent:!0,defer:s.defer}),u.subscribe(i.bind(this._onObservableArrayChange,this)),u}return o(t,e),t.prototype.__destroy=function(){this.collection(null),n.utils.wrappedDestroy(this),t.__super__.__destroy.apply(this,arguments);if(n.statistics)return n.statistics.unregister("kb.CollectionObservable",this)},t.prototype.retain=function(){return t.__super__.retain.apply(this,arguments),n.utils.wrappedObservable(this)},t.prototype.release=function(){var e;return e=n.utils.wrappedObservable(this),t.__super__.release.apply(this,arguments),e},t.prototype.collection=function(e,t){var r,i;r=n.utils.wrappedObservable(this),i=n.utils.wrappedObject(r);if(arguments.length===0)return r(),i;if(e===i)return;return i&&(this._clear(),this._collectionUnbind(i),typeof i.release=="function"&&i.release()),n.utils.wrappedObject(r,e),e&&(typeof e.retain=="function"&&e.retain(),this._collectionBind(e),this.sortedIndex(this.sorted_index,this.sort_attribute,t)),e},t.prototype.sortedIndex=function(e,t,r){var s,o=this;return r==null&&(r={}),e?(this.sorted_index=e,this.sort_attribute=t):t?(this.sort_attribute=t,this.sorted_index=this._sortAttributeFn(t)):(this.sort_attribute=null,this.sorted_index=null),s=function(){var e,t;t=n.utils.wrappedObservable(o),e=n.utils.wrappedObject(t);if(e.models.length===0&&t().length===0)return;o._collectionResync(!0);if(!r.silent)return o.trigger("resort",t())},r.defer?i.defer(s):s(),this},t.prototype.sortAttribute=function(e,t,n){return this.sortedIndex(t,e,n)},t.prototype.viewModelByModel=function(e){var t,r;return this.hasViewModels()?(r=n.utils.wrappedObservable(this),t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid",i.find(r(),function(n){return n.__kb.obj[t]===e[t]})):null},t.prototype.hasViewModels=function(){return!this.models_only},t.prototype._collectionBind=function(e){var t,n,r,i,s,o,u;if(!e)return;e.bind("reset",this.__kb._onCollectionReset),this.sorted_index||e.bind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.bind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.bind(t,this.__kb._onModelRemove);return e.bind("change",this.__kb._onModelChange)},t.prototype._collectionUnbind=function(e){var t,n,r,i,s,o,u;if(!e)return;e.unbind("reset",this.__kb._onCollectionReset),this.sorted_index||e.unbind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.unbind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.unbind(t,this.__kb._onModelRemove);return e.unbind("change",this.__kb._onModelChange)},t.prototype._onCollectionReset=function(){if(this.in_edit)return;return this._collectionResync()},t.prototype._onCollectionResort=function(e){var t;if(this.sorted_index)throw"CollectionObservable: collection sorted_index unexpected";return i.isArray(e)?(t=n.utils.wrappedObservable(this),this.trigger("resort",t())):this._onModelResort(e)},t.prototype._onModelAdd=function(e){var t,r,i,s;return i=this._createModelObervable(e),s=n.utils.wrappedObservable(this),r=n.utils.wrappedObject(s),this.sorted_index?t=this.sorted_index(s(),i):t=r.indexOf(e),this.in_edit++,s.splice(t,0,i),this.in_edit--,this.trigger("add",i,s())},t.prototype._onModelRemove=function(e){var t,r;t=this.hasViewModels()?this.viewModelByModel(e):e;if(!t)return;r=n.utils.wrappedObservable(this),this.in_edit++,r.remove(t),this.in_edit--,this.trigger("remove",t,r);if(this.hasViewModels())return n.utils.wrappedStore(r).releaseObservable(t,n.utils.wrappedStoreIsOwned(r))},t.prototype._onModelChange=function(e){if(this.sorted_index&&(!this.sort_attribute||e.hasChanged(this.sort_attribute)))return this._onModelResort(e)},t.prototype._onModelResort=function(e){var t,r,s,o,u,a;o=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(o),r=this.hasViewModels()?this.viewModelByModel(e):e,u=o.indexOf(r),this.sorted_index?(a=i.clone(o()),a.splice(u,1),s=this.sorted_index(a,r)):s=t.indexOf(e);if(u===s)return;return this.in_edit++,o.splice(u,1),o.splice(s,0,r),this.in_edit--,this.trigger("resort",r,o(),s)},t.prototype._onObservableArrayChange=function(e){var t,r;if(this.in_edit)return;return r=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(r),this.in_edit++,t.reset(i.map(e,function(e){return n.utils.wrappedModel(e)})),this.in_edit--},t.prototype._clear=function(e){var t,r,i,s,o,u,a;i=n.utils.wrappedObservable(this),e||this.trigger("remove",i()),this.in_edit++,r=i.removeAll(),this.in_edit--,s=n.utils.wrappedStore(i);if(this.hasViewModels()){a=[];for(o=0,u=r.length;o<u;o++)t=r[o],a.push(s.releaseObservable(t,n.utils.wrappedStoreIsOwned(i)));return a}},t.prototype._collectionResync=function(e){var t,r,s,o,u,a,f,l,c,h=this;this._clear(e),a=n.utils.wrappedObservable(this),r=n.utils.wrappedObject(a);if(this.sorted_index){u=[],c=r.models;for(f=0,l=c.length;f<l;f++)s=c[f],o=this._createModelObervable(s),t=this.sorted_index(u,o),u.splice(t,0,o)}else u=this.hasViewModels()?i.map(r.models,function(e){return h._createModelObervable(e)}):i.clone(r.models);this.in_edit++,a(u),this.in_edit--;if(!e)return this.trigger("add",a())},t.prototype._sortAttributeFn=function(e){return this.hasViewModels()?function(t,r){return i.sortedIndex(t,r,function(t){return n.utils.wrappedModel(t).get(e)})}:function(t,n){return i.sortedIndex(t,n,function(t){return t.get(e)})}},t.prototype._createModelObervable=function(e){var t;return t=n.utils.wrappedObservable(this),this.hasViewModels()?n.utils.wrappedStore(t).findOrCreateObservable(e,this.models_path,n.utils.wrappedFactory(t)):e},t}(n.RefCountable),o(n.CollectionObservable.prototype,e.Events),n.collectionObservable=function(e,t){return new n.CollectionObservable(e,t)},n.sortedIndexWrapAttr=n.siwa=function(e,t){return function(r,s){return i.sortedIndex(r,s,function(r){return new t(n.utils.wrappedModel(r).get(e))})}},n.DefaultWrapper=function(){function e(e,t){var s,o=this;return this.default_value=t,s=n.utils.wrappedObservable(this,r.dependentObservable({read:function(){var t,n;return n=r.utils.unwrapObservable(e()),t=r.utils.unwrapObservable(o.default_value),n?n:t},write:function(t){return e(t)}})),s.destroy=i.bind(this.destroy,this),s.setToDefault=i.bind(this.setToDefault,this),s}return e.prototype.destroy=function(){var e;return this.default_value&&(typeof (e=this.default_value).dispose=="function"&&e.dispose(),this.default_value=null),n.utils.wrappedDestroy(this)},e.prototype.setToDefault=function(){var e;return e=n.utils.wrappedObservable(this),e(this.default_value)},e}(),n.defaultWrapper=function(e,t){return new n.DefaultWrapper(e,t)},n.toFormattedString=function(e){var t,n,i,s,o,u;o=e.slice(),n=Array.prototype.slice.call(arguments,1);for(i in n){t=n[i],u=r.utils.unwrapObservable(t),u||(u=""),s=e.indexOf("{"+i+"}");while(s>=0)o=o.replace("{"+i+"}",u),s=e.indexOf("{"+i+"}",s+1)}return o},n.parseFormattedString=function(e,t){var n,r,s,o,u,a,f,l,c,h,p,d,v,m;h=t.slice(),s=0,a=0,l={};while(h.search("\\{"+s+"\\}")>=0){f=t.indexOf("{"+s+"}");while(f>=0)h=h.replace("{"+s+"}","(.*)"),l[f]=s,a++,f=t.indexOf("{"+s+"}",f+1);s++}n=s,c=new RegExp(h),u=c.exec(e),u&&u.shift();if(!u||u.length!==a)return i.map(function(){m=[];for(var e=1;1<=n?e<=n:e>=n;1<=n?e++:e--)m.push(e);return m}.apply(this),function(){return""});d=i.sortBy(i.keys(l),function(e,t){return parseInt(e,10)}),r={};for(o in d){f=d[o],s=l[f];if(r.hasOwnProperty(s))continue;r[s]=o}p=[],s=0;while(s<n)p.push(u[r[s]]),s++;return p},n.FormattedObservable=function(){function e(e,t){var s,o;return i.isArray(t)?(e=e,o=t):o=Array.prototype.slice.call(arguments,1),s=n.utils.wrappedObservable(this,r.dependentObservable({read:function(){var i,s,u;t=[r.utils.unwrapObservable(e)];for(s=0,u=o.length;s<u;s++)i=o[s],t.push(r.utils.unwrapObservable(i));return n.toFormattedString.apply(null,t)},write:function(t){var i,s,u,a;s=n.parseFormattedString(t,r.utils.unwrapObservable(e)),u=Math.min(o.length,s.length),i=0,a=[];while(i<u)o[i](s[i]),a.push(i++);return a}})),s}return e.prototype.destroy=function(){return n.utils.wrappedDestroy(this)},e}(),n.formattedObservable=function(e,t){return new n.FormattedObservable(e,Array.prototype.slice.call(arguments,1))},n.LocalizedObservable=function(){function t(e,t,s){var o,u;this.value_holder=e,t==null&&(t={}),this.view_model=s!=null?s:{};if(!this.read)throw"LocalizedObservable: options.read is missing";if(!n.locale_manager)throw"LocalizedObservable: kb.locale_manager is not defined";this.__kb||(this.__kb={}),this.__kb._onLocaleChange=i.bind(this._onLocaleChange,this),this.__kb._onChange=t.onChange,this.value_holder&&(u=r.utils.unwrapObservable(this.value_holder)),n.utils.wrappedByKey(this,"vo",r.observable(u?this.read(u,null):null));if(this.write&&typeof this.write!="function")throw"LocalizedObservable: options.write is not a function for read_write model attribute";return o=n.utils.wrappedObservable(this,r.dependentObservable({read:i.bind(this._onGetValue,this),write:this.write?i.bind(this._onSetValue,this):function(){throw"kb.LocalizedObservable: value is read only"},owner:this.view_model})),o.destroy=i.bind(this.destroy,this),o.observedValue=i.bind(this.observedValue,this),o.resetToCurrent=i.bind(this.resetToCurrent,this),n.locale_manager.bind("change",this.__kb._onLocaleChange),t.hasOwnProperty("default")&&(o=r.defaultWrapper(o,t["default"])),o}return t.extend=e.Model.extend,t.prototype.destroy=function(){return n.locale_manager.unbind("change",this.__kb._onLocaleChange),this.view_model=null,n.utils.wrappedDestroy(this)},t.prototype.resetToCurrent=function(){var e,t,i;return i=n.utils.wrappedByKey(this,"vo"),i(null),t=n.utils.wrappedObservable(this),e=this.value_holder&&t?this.read(r.utils.unwrapObservable(this.value_holder)):null,this._onSetValue(e)},t.prototype.observedValue=function(e){return arguments.length===0?this.value_holder:(this.value_holder=e,this._onLocaleChange(),this)},t.prototype._onGetValue=function(){var e;return this.value_holder&&r.utils.unwrapObservable(this.value_holder),e=n.utils.wrappedByKey(this,"vo"),e(),this.read(r.utils.unwrapObservable(this.value_holder))},t.prototype._onSetValue=function(e){var t;this.write(e,r.utils.unwrapObservable(this.value_holder)),t=n.utils.wrappedByKey(this,"vo"),t(e);if(this.__kb._onChange)return this.__kb._onChange(e)},t.prototype._onLocaleChange=function(){var e,t;e=this.read(r.utils.unwrapObservable(this.value_holder)),t=n.utils.wrappedByKey(this,"vo"),t(e);if(this.__kb._onChange)return this.__kb._onChange.onChange(e)},t}(),n.localizedObservable=function(e,t,r){return new n.LocalizedObservable(e,t,r)},n.Observable=function(){function t(t,s,o){var u,a,f;this.view_model=o!=null?o:{};if(!t)throw"Observable: model is missing";if(!s)throw"Observable: mapping_info is missing";this.__kb||(this.__kb={}),this.__kb._onModelChange=i.bind(this._onModelChange,this),this.__kb._onModelLoaded=i.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=i.bind(this._onModelUnloaded,this),this.key=i.isString(s)||r.isObservable(s)?s:s.key;if(!this.key)throw"Observable: key is missing";this.args=s.args,this.read=s.read,this.write=s.write,f=n.utils.wrappedByKey(this,"vo",r.observable()),a=n.utils.wrappedObservable(this,r.dependentObservable({read:i.bind(this._onGetValue,this),write:i.bind(this._onSetValue,this),owner:this.view_model})),e.ModelRef&&t instanceof e.ModelRef?(n.utils.wrappedModelRef(a,t,{loaded:this.__kb._onModelLoaded,unloaded:this.__kb._onModelUnloaded}),u=t,t=u.model()):n.utils.wrappedObject(a,t),a.destroy=i.bind(this.destroy,this);if(!u||u.isLoaded())t.bind("change",this.__kb._onModelChange),f.notifySubscribers(f());return s.localizer&&(a=new s.localizer(a)),s.hasOwnProperty("default")&&(a=n.defaultWrapper(a,s["default"])),a}return t.prototype.destroy=function(){return this._modelUnbind(n.utils.wrappedObject(n.utils.wrappedObservable(this))),this.key=null,this.args=null,this.read=null,this.write=null,this.view_model=null,n.utils.wrappedDestroy(this)},t.prototype._onGetValue=function(){var e,t,s,o,u,a,f,l;u=n.utils.wrappedByKey(this,"vo"),u(),t=[r.utils.unwrapObservable(this.key)],o=n.utils.wrappedObservable(this);if(!o)return null;s=n.utils.wrappedObject(o);if(!s)return null;if(!i.isUndefined(this.args))if(i.isArray(this.args)){l=this.args;for(a=0,f=l.length;a<f;a++)e=l[a],t.push(r.utils.unwrapObservable(e))}else t.push(r.utils.unwrapObservable(this.args));return this.read?this.read.apply(this.view_model,t):s.get.apply(s,t)},t.prototype._onSetValue=function(e){var t,s,o,u,a,f,l,c;o=n.utils.wrappedObject(n.utils.wrappedObservable(this));if(o){u={},u[r.utils.unwrapObservable(this.key)]=e,s=this.write?[e]:[u];if(!i.isUndefined(this.args))if(i.isArray(this.args)){c=this.args;for(f=0,l=c.length;f<l;f++)t=c[f],s.push(r.utils.unwrapObservable(t))}else s.push(r.utils.unwrapObservable(this.args));this.write?this.write.apply(this.view_model,s):o.set.apply(o,s)}return a=n.utils.wrappedByKey(this,"vo"),a(e)},t.prototype._modelBind=function(t){if(!t)return;t.bind("change",this.__kb._onModelChange);if(e.RelationalModel&&t instanceof e.RelationalModel)return t.bind("add",this.__kb._onModelChange),t.bind("remove",this.__kb._onModelChange),t.bind("update",this.__kb._onModelChange)},t.prototype._modelUnbind=function(t){if(!t)return;t.unbind("change",this.__kb._onModelChange);if(e.RelationalModel&&t instanceof e.RelationalModel)return t.unbind("add",this.__kb._onModelChange),t.unbind("remove",this.__kb._onModelChange),t.unbind("update",this.__kb._onModelChange)},t.prototype._onModelLoaded=function(e){var t;return n.utils.wrappedObject(n.utils.wrappedObservable(this),e),this._modelBind(e),t=n.utils.wrappedByKey(this,"vo"),t(this._onGetValue())},t.prototype._onModelUnloaded=function(e){return this.__kb.localizer&&this.__kb.localizer.destroy&&(this.__kb.localizer.destroy(),this.__kb.localizer=null),this._modelUnbind(e),n.utils.wrappedObject(n.utils.wrappedObservable(this),null)},t.prototype._onModelChange=function(){var e,t;e=n.utils.wrappedObject(n.utils.wrappedObservable(this));if(e&&e.hasChanged&&!e.hasChanged(r.utils.unwrapObservable(this.key)))return;return t=n.utils.wrappedByKey(this,"vo"),t(this._onGetValue())},t}(),n.observable=function(e,t,r){return new n.Observable(e,t,r)},n.Observables=function(){function e(e,t,r,s){var o,u,a,f,l,c,h,p;if(!e)throw"Observables: model is missing";if(!t||!i.isObject(t)&&!i.isArray(t))throw"Observables: mappings_info is missing";this.__kb||(this.__kb={});if(i.isArray(t)){this.__kb.mappings_info={};for(l=0,c=t.length;l<c;l++)u=t[l],this.__kb.mappings_info[u]={}}else this.__kb.mappings_info=t;this.__kb.view_model=i.isUndefined(r)?this:r;if(!i.isUndefined(s)){h=this.__kb.mappings_info;for(f in h)a=h[f],o=i.isString(a),o&&(a={key:a}),a.hasOwnProperty("key")||(a.key=f),this[f]=this.__kb.view_model[f]=n.observable(e,a,this.__kb.view_model)}else{p=this.__kb.mappings_info;for(f in p)a=p[f],a.hasOwnProperty("key")||(a.key=f),this[f]=this.__kb.view_model[f]=n.observable(e,a,this.__kb.view_model)}}return e.prototype.destroy=function(){var e,t,r;r=this.__kb.mappings_info;for(t in r)e=r[t],this.__kb.view_model[t]&&this.__kb.view_model[t].destroy(),this.__kb.view_model[t]=null,this[t]=null;return n.utils.wrappedDestroy(this)},e.prototype.setToDefault=function(){var e,t,n,r;n=this.__kb.mappings_info,r=[];for(t in n)e=n[t],r.push(this.__kb.view_model[t].setToDefault());return r},e}(),n.observables=function(e,t,r,i){return new n.Observables(e,t,r,i)},n.TriggeredObservable=function(){function t(t,s){var o,u;this.event_name=s;if(!t)throw"Observable: model is missing";if(!this.event_name)throw"Observable: event_name is missing";return this.__kb||(this.__kb={}),this.__kb._onValueChange=i.bind(this._onValueChange,this),this.__kb._onModelLoaded=i.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=i.bind(this._onModelUnloaded,this),n.utils.wrappedByKey(this,"vo",r.observable()),u=n.utils.wrappedObservable(this,r.dependentObservable(i.bind(this._onGetValue,this))),e.ModelRef&&t instanceof e.ModelRef?(n.utils.wrappedModelRef(u,t,{loaded:this.__kb._onModelLoaded,unloaded:this.__kb._onModelUnloaded}),o=t,t=o.model()):n.utils.wrappedObject(u,t),u.destroy=i.bind(this.destroy,this),(!o||o.isLoaded())&&this._onModelLoaded(t),u}return t.prototype.destroy=function(){var e;return e=n.utils.wrappedObject(n.utils.wrappedObservable(this)),e&&this._onModelUnloaded(e),this.options=null,this.view_model=null,n.utils.wrappedDestroy(this)},t.prototype._onGetValue=function(){return n.utils.wrappedByKey(this,"vo")()},t.prototype._onModelLoaded=function(e){return n.utils.wrappedObject(n.utils.wrappedObservable(this),e),e.bind(this.event_name,this.__kb._onValueChange),this._onValueChange()},t.prototype._onModelUnloaded=function(e){var t;return t=n.utils.wrappedObservable(this),e.unbind(this.event_name,this.__kb._onValueChange),n.utils.wrappedObject(t,null)},t.prototype._onValueChange=function(){var e,t,r,i;return r=n.utils.wrappedObservable(this),i=n.utils.wrappedByKey(this,"vo"),e=i(),t=n.utils.wrappedObject(r),e!==t?i(t):i.valueHasMutated()},t}(),n.triggeredObservable=function(e,t){return new n.TriggeredObservable(e,t)},n.AttributeObservable=function(){function t(e,t,s){var o;return s==null&&(s={}),n.utils.wrappedByKey(this,"vo",r.observable()),o=n.utils.wrappedObservable(this,r.dependentObservable({read:i.bind(this.read,this),write:i.bind(this.write,this)})),n.utils.wrappedObject(o,e),n.utils.wrappedStore(o,s.store),n.utils.wrappedFactory(o,s.factory),n.utils.wrappedPath(o,n.utils.pathJoin(s.path,t)),this.key=t,o.valueType=i.bind(this.valueType,this),o.destroy=i.bind(this.destroy,this),o.model=i.bind(this.model,this),o.update=i.bind(this.update,this),this.update(),o}return t.prototype.destroy=function(){return n.utils.wrappedDestroy(this)},t.prototype.read=function(){return r.utils.unwrapObservable(n.utils.wrappedByKey(this,"vo"))},t.prototype.write=function(e){var t,r,i;return r=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(r),t&&t.get(this.key)!==e&&(i={},i[this.key]=e,t.set(i)),this.update(e)},t.prototype.model=function(e){var t,r;r=n.utils.wrappedObservable(this),t=n.utils.wrappedObject(r);if(arguments.length===0)return t;if(t===e)return;return n.utils.wrappedObject(r,e),this.update()},t.prototype.update=function(t){var r,i,s,o;i=n.utils.wrappedObservable(this),r=n.utils.wrappedObject(i),r&&!arguments.length&&(t=r.get(this.key)),o=n.utils.wrappedByKey(this,"vo");if(!o){this._createValueObservable(t);return}s=this.valueType();if(s===n.TYPE_MODEL){if(t&&!t instanceof e.Model)return this._createValueObservable(t);if(o.model()!==t)return o.model(t)}else if(s===n.TYPE_COLLECTION){if(t&&!t instanceof e.Collection)return this._createValueObservable(t);if(o.collection()!==t)return o.collection(t)}else{if(t&&(t instanceof e.Model||t instanceof e.Collection))return this._createValueObservable(t);if(o()!==t)return o(t)}},t.prototype.valueType=function(){var e;return e=n.utils.wrappedByKey(this,"vo"),e||(e=this._createValueObservable(new_value)),r.isObservable(e)?n.utils.observableInstanceOf(e,n.CollectionObservable)?n.TYPE_COLLECTION:n.TYPE_SIMPLE:n.TYPE_MODEL},t.prototype._createValueObservable=function(e){var t,i,s,o;return t=n.utils.wrappedObservable(this),s=n.utils.wrappedStore(t),i=n.utils.wrappedByKey(this,"vo"),o=n.utils.wrappedByKey(this,"vo",s.findOrCreateObservable(e,n.utils.wrappedPath(t),n.utils.wrappedFactory(t))),i.notifySubscribers(r.utils.unwrapObservable(o)),s.releaseObservable(i),o},t}(),n.attributeObservable=function(e,t,r){return new n.AttributeObservable(e,t,r)},n.ViewModel=function(t){function r(t,s){var o,u,a,f,l,c;s==null&&(s={}),r.__super__.constructor.apply(this,arguments),n.statistics&&n.statistics.register("kb.ViewModel",this),n.Store.registerOrCreateStoreFromOptions(t,this,s),o=n.utils.wrappedFactory(this,new n.Factory(s.factory)),n.utils.wrappedPath(this,s.path),s.mappings&&o.addPathMappings(s.mappings),this.__kb._onModelChange=i.bind(this._onModelChange,this),this.__kb._onModelLoaded=i.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=i.bind(this._onModelUnloaded,this),this.__kb.internals=s.internals,this.__kb.requires=s.requires,e.ModelRef&&t instanceof e.ModelRef?(n.utils.wrappedModelRef(this,t,{loaded:this.__kb._onModelLoaded,unloaded:this.__kb._onModelUnloaded}),f=t,t=f.model()):n.utils.wrappedObject(this,t),t&&this._onModelLoaded(t);if(!this.__kb.internals&&!this.__kb.requires)return this;a=i.union(this.__kb.internals?this.__kb.internals:[],this.__kb.requires?this.__kb.requires:[]);if(!f||f.isLoaded())a=i.difference(a,i.keys(t.attributes));for(l=0,c=a.length;l<c;l++)u=a[l],this._updateAttributeObservable(t,u)}return o(r,t),r.prototype.__destroy=function(){this._modelUnbind(n.utils.wrappedObject(this)),n.utils.release(this,!0),n.utils.wrappedDestroy(this),r.__super__.__destroy.apply(this,arguments);if(n.statistics)return n.statistics.unregister("kb.ViewModel",this)},r.prototype.model=function(e){var t;t=n.utils.wrappedObject(this);if(arguments.length===0)return t;if(e===t)return;t&&this._onModelUnloaded(t);if(e)return this._onModelLoaded(e)},r.prototype._modelBind=function(t){if(!t)return;t.bind("change",this.__kb._onModelChange);if(e.RelationalModel&&t instanceof e.RelationalModel)return t.bind("add",this.__kb._onModelChange),t.bind("remove",this.__kb._onModelChange),t.bind("update",this.__kb._onModelChange)},r.prototype._modelUnbind=function(t){if(!t)return;t.unbind("change",this.__kb._onModelChange);if(e.RelationalModel&&t instanceof e.RelationalModel)return t.unbind("add",this.__kb._onModelChange),t.unbind("remove",this.__kb._onModelChange),t.unbind("update",this.__kb._onModelChange)},r.prototype._onModelLoaded=function(e){var t,r;n.utils.wrappedObject(this,e),this._modelBind(e),r=[];for(t in e.attributes)r.push(this._updateAttributeObservable(e,t));return r},r.prototype._onModelUnloaded=function(e){var t,r;this._modelUnbind(e),n.utils.wrappedObject(this,null),r=[];for(t in e.attributes)r.push(this._updateAttributeObservable(null,t));return r},r.prototype._onModelChange=function(){var e,t,r,i;t=n.utils.wrappedObject(this);if(t._changed){r=[];for(e in t.attributes)r.push(t.hasChanged(e)?this._updateAttributeObservable(t,e):void 0);return r}if(t.changed){i=[];for(e in t.changed)i.push(this._updateAttributeObservable(t,e));return i}},r.prototype._updateAttributeObservable=function(
e,t){var r,s;s=this.__kb.internals&&i.contains(this.__kb.internals,t)?"_"+t:t,r=this[s];if(r){if(!n.utils.observableInstanceOf(r,n.AttributeObservable))return;return r.model()!==e?r.model(e):r.update()}return this[s]=n.attributeObservable(e,t,{store:n.utils.wrappedStore(this),factory:n.utils.wrappedFactory(this),path:n.utils.wrappedPath(this)})},r}(n.RefCountable),n.viewModel=function(e,t){return new n.ViewModel(e,t)}}).call(this);