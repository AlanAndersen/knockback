// Generated by CoffeeScript 1.3.1
/*
 knockback.js 0.15.0
 (c) 2011 Kevin Malakoff.
 Knockback.js is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/knockback/blob/master/LICENSE
 Dependencies: Knockout.js, Backbone.js, and Underscore.js.
 Optional dependency: Backbone.ModelRef.js.
*/
var Backbone,Knockback,fn,kb,key,ko,_,_ref;if(typeof exports!=="undefined"){Knockback=kb=exports}else{this.Knockback=this.kb={}}Knockback.VERSION="0.15.0";_=!this._&&(typeof require!=="undefined")?require("underscore"):this._;Backbone=!this.Backbone&&(typeof require!=="undefined")?require("backbone"):this.Backbone;ko=!this.ko&&(typeof require!=="undefined")?require("knockout"):this.ko;Knockback.locale_manager;Knockback.stats={collection_observables:0,view_models:0};Knockback.stats_on=false;Knockback.utils={};Knockback.utils.legacyWarning=function(a,d,c){var b;kb._legacy_warnings||(kb._legacy_warnings={});(b=kb._legacy_warnings)[a]||(b[a]=0);kb._legacy_warnings[a]++;return console.warn("Legacy warning! '"+a+"' has been deprecated (will be removed in Knockback "+d+"). "+c+".")};Knockback.utils.wrappedObservable=function(a,b){if(arguments.length===1){if(!(a&&a.__kb&&a.__kb.observable)){throw new Error("Knockback: instance is not wrapping an observable")}return a.__kb.observable}if(!a){throw new Error("Knockback: no instance for wrapping a observable")}a.__kb||(a.__kb={});if(a.__kb.observable&&a.__kb.observable.__kb){a.__kb.observable.__kb.instance=null}a.__kb.observable=b;if(b){b.__kb||(b.__kb={});b.__kb.instance=a}return b};Knockback.utils.observableInstanceOf=function(b,a){if(!b){return false}if(!(b.__kb&&b.__kb.instance)){return false}return b.__kb.instance instanceof a};Knockback.utils.wrappedModel=function(a,b){if(arguments.length===1){if(a&&a.__kb&&a.__kb.hasOwnProperty("model")){return a.__kb.model}else{return a}}if(!a){throw new Error("Knockback: no instance for wrapping a model")}a.__kb||(a.__kb={});a.__kb.model=b;return b};Knockback.viewModelGetModel=Knockback.vmModel=function(a){kb.utils.legacyWarning("kb.vmModel","0.16.0","Please use kb.utils.wrappedModel instead");return kb.utils.wrappedModel(a)};Knockback.utils.setToDefault=function(d){var b,c,a;if(!d){return}if(ko.isObservable(d)){return typeof d.setToDefault==="function"?d.setToDefault():void 0}else{if(_.isObject(d)){a=[];for(b in d){c=d[b];a.push(c&&(b!=="__kb")?kb.utils.setToDefault(c):void 0)}return a}}};Knockback.vmSetToDefault=function(a){kb.utils.legacyWarning("kb.vmSetToDefault","0.16.0","Please use kb.utils.release instead");return kb.utils.setToDefault(a)};Knockback.utils.release=function(c){var a,b;if(ko.isObservable(c)||(c instanceof kb.Observables)||(c instanceof kb.ViewModel_RCBase)){if(c.release){c.release()}else{if(c.destroy){c.destroy()}else{if(c.dispose){c.dispose()}else{return false}}}return true}else{if(_.isObject(c)&&!(typeof c==="function")){for(a in c){b=c[a];if(!b||(a==="__kb")){continue}if(kb.utils.release(b)){c[a]=null}}return true}}};Knockback.vmRelease=function(a){kb.utils.legacyWarning("kb.vmRelease","0.16.0","Please use kb.utils.release instead");return kb.utils.release(a)};Knockback.vmReleaseObservable=function(a){kb.utils.legacyWarning("kb.vmReleaseObservable","0.16.0","Please use kb.utils.release instead");return kb.utils.release(a)};_ref=Knockback.utils;for(key in _ref){fn=_ref[key];Knockback[key]=function(){kb.utils.legacyWarning("kb."+key,"0.16.0","Please use kb.utils."+key+" instead");return kb.utils[key].apply(null,arguments)}}var __hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};Knockback.CollectionObservable=(function(b){__extends(a,b);a.name="CollectionObservable";function a(e,c){var d;if(c==null){c={}}if(!e){throw new Error("CollectionObservable: collection is missing")}a.__super__.constructor.apply(this,arguments);if(Knockback.stats_on){kb.stats.collection_observables++}if(ko.isObservable(c)&&c.hasOwnProperty("indexOf")){kb.utils.legacyWarning("kb.collectionObservable with an external ko.observableArray","0.16.0","Please use the kb.collectionObservable directly instead of passing a ko.observableArray");d=kb.utils.wrappedObservable(this,c);c=arguments[2]||{}}else{d=kb.utils.wrappedObservable(this,ko.observableArray([]))}kb.Store.resolveFromOptions(c,kb.utils.wrappedObservable(this));if(c.__kb_store){this.__kb.store=c.__kb_store}else{this.__kb.store=new kb.Store();this.__kb.store_is_owned=true}if(c.hasOwnProperty("view_model")){this.view_model_create_fn=c.view_model;this.view_model_create_with_new=true}else{if(c.hasOwnProperty("view_model_constructor")){kb.utils.legacyWarning("kb.collectionObservable option view_model_constructor","0.16.0","Please use view_model option instead");this.view_model_create_fn=c.view_model_constructor;this.view_model_create_with_new=true}else{if(c.hasOwnProperty("view_model_create")){this.view_model_create_fn=c.view_model_create}else{if(c.hasOwnProperty("create")){this.view_model_create_fn=c.create}}}}this.sort_attribute=c.sort_attribute;this.sorted_index=c.sorted_index;this.__kb._onCollectionReset=_.bind(this._onCollectionReset,this);this.__kb._onCollectionResort=_.bind(this._onCollectionResort,this);this.__kb._onModelAdd=_.bind(this._onModelAdd,this);this.__kb._onModelRemove=_.bind(this._onModelRemove,this);this.__kb._onModelChange=_.bind(this._onModelChange,this);d.retain=_.bind(this.retain,this);d.refCount=_.bind(this.refCount,this);d.release=_.bind(this.release,this);d.collection=_.bind(this.collection,this);d.viewModelByModel=_.bind(this.viewModelByModel,this);d.sortedIndex=_.bind(this.sortedIndex,this);d.sortAttribute=_.bind(this.sortAttribute,this);d.hasViewModels=_.bind(this.hasViewModels,this);d.bind=_.bind(this.bind,this);d.unbind=_.bind(this.unbind,this);d.trigger=_.bind(this.trigger,this);this.collection(e,{silent:true,defer:c.defer});return d}a.prototype.__destroy=function(){this.collection(null);kb.utils.wrappedObservable(this).destroyAll();kb.utils.wrappedObservable(this,null);this.view_model_create_fn=null;if(this.__kb.store_is_owned){this.__kb.store.destroy()}this.__kb.store=null;this.__kb.co=null;a.__super__.__destroy.apply(this,arguments);if(Knockback.stats_on){return kb.stats.collection_observables--}};a.prototype.retain=function(){a.__super__.retain.apply(this,arguments);return kb.utils.wrappedObservable(this)};a.prototype.release=function(){var c;c=kb.utils.wrappedObservable(this);a.__super__.release.apply(this,arguments);return c};a.prototype.collection=function(c,d){var g,e,f;g=kb.utils.wrappedObservable(this);if(arguments.length===0){g();return this.__kb.collection}if(c===this.__kb.collection){return}if(this.__kb.collection){this._clear();this._collectionUnbind(this.__kb.collection);if(typeof(e=this.__kb.collection).release==="function"){e.release()}this.__kb.collection=null}this.__kb.collection=c;if(this.__kb.collection){if(typeof(f=this.__kb.collection).retain==="function"){f.retain()}this._collectionBind(this.__kb.collection);return this.sortedIndex(this.sorted_index,this.sort_attribute,d)}};a.prototype.sortedIndex=function(g,c,d){var e,f=this;if(d==null){d={}}if(g){this.sorted_index=g;this.sort_attribute=c}else{if(c){this.sort_attribute=c;this.sorted_index=this._sortAttributeFn(c)}else{this.sort_attribute=null;this.sorted_index=null}}e=function(){var h;h=kb.utils.wrappedObservable(f);if((f.__kb.collection.models.length===0)&&(h().length===0)){return}f._collectionResync(true);if(!d.silent){return f.trigger("resort",h())}};if(d.defer){_.defer(e)}else{e()}return this};a.prototype.sortAttribute=function(d,e,c){return this.sortedIndex(e,d,c)};a.prototype.viewModelByModel=function(d){var c,e;if(!this.hasViewModels()){return null}e=kb.utils.wrappedObservable(this);c=d.hasOwnProperty(d.idAttribute)?d.idAttribute:"cid";return _.find(e(),function(f){return f.__kb.model[c]===d[c]})};a.prototype.hasViewModels=function(){return !!this.view_model_create_fn};a.prototype._collectionBind=function(j){var g,i,f,e,d,h,c;if(!j){return}j.bind("reset",this.__kb._onCollectionReset);if(!this.sorted_index){j.bind("resort",this.__kb._onCollectionResort)}h=["new","add"];for(i=0,e=h.length;i<e;i++){g=h[i];j.bind(g,this.__kb._onModelAdd)}c=["remove","destroy"];for(f=0,d=c.length;f<d;f++){g=c[f];j.bind(g,this.__kb._onModelRemove)}return j.bind("change",this.__kb._onModelChange)};a.prototype._collectionUnbind=function(j){var g,i,f,e,d,h,c;if(!j){return}j.unbind("reset",this.__kb._onCollectionReset);if(!this.sorted_index){j.unbind("resort",this.__kb._onCollectionResort)}h=["new","add"];for(i=0,e=h.length;i<e;i++){g=h[i];j.unbind(g,this.__kb._onModelAdd)}c=["remove","destroy"];for(f=0,d=c.length;f<d;f++){g=c[f];j.unbind(g,this.__kb._onModelRemove)}return j.unbind("change",this.__kb._onModelChange)};a.prototype._onCollectionReset=function(){return this._collectionResync()};a.prototype._onCollectionResort=function(d){var c;if(this.sorted_index){throw new Error("CollectionObservable: collection sorted_index unexpected")}if(_.isArray(d)){c=kb.utils.wrappedObservable(this);return this.trigger("resort",c())}else{return this._onModelResort(d)}};a.prototype._onModelAdd=function(d){var c,f,e;e=this.hasViewModels()?this._createTarget(d):d;f=kb.utils.wrappedObservable(this);if(this.sorted_index){c=this.sorted_index(f(),e)}else{c=this.__kb.collection.indexOf(d)}f.splice(c,0,e);return this.trigger("add",e,f())};a.prototype._onModelRemove=function(c){var e,d;d=this.hasViewModels()?this.viewModelByModel(c):c;if(!d){return}e=kb.utils.wrappedObservable(this);e.remove(d);this.trigger("remove",d,e);if(!this.hasViewModels()){return}kb.utils.release(d);return kb.utils.wrappedModel(d,null)};a.prototype._onModelChange=function(c){if(this.sorted_index&&(!this.sort_attribute||c.hasChanged(this.sort_attribute))){this._onModelResort(c)}return kb.utils.wrappedObservable(this).valueHasMutated()};a.prototype._onModelResort=function(d){var c,g,f,h,e;g=kb.utils.wrappedObservable(this);e=this.hasViewModels()?this.viewModelByModel(d):d;f=g.indexOf(e);if(this.sorted_index){h=_.clone(g());h.splice(f,1);c=this.sorted_index(h,e)}else{c=this.__kb.collection.indexOf(d)}if(f===c){return}g.splice(f,1);g.splice(c,0,e);return this.trigger("resort",e,g(),c)};a.prototype._clear=function(g){var i,e,f,h,d,c;i=kb.utils.wrappedObservable(this);if(!g){this.trigger("remove",i())}e=i.removeAll();if(!this.hasViewModels()){return}c=[];for(h=0,d=e.length;h<d;h++){f=e[h];c.push(kb.utils.release(f))}return c};a.prototype._collectionResync=function(k){var d,g,c,j,i,e,l,f,h=this;this._clear(k);c=kb.utils.wrappedObservable(this);if(this.sorted_index){i=[];f=this.__kb.collection.models;for(e=0,l=f.length;e<l;e++){g=f[e];j=this._createTarget(g);d=this.sorted_index(i,j);i.splice(d,0,j)}}else{i=this.hasViewModels()?_.map(this.__kb.collection.models,function(m){return h._createTarget(m)}):_.clone(this.__kb.collection.models)}c(i);if(!k){return this.trigger("add",c())}};a.prototype._sortAttributeFn=function(c){if(this.hasViewModels()){return function(e,d){return _.sortedIndex(e,d,function(f){return kb.utils.wrappedModel(f).get(c)})}}else{return function(e,d){return _.sortedIndex(e,d,function(f){return f.get(c)})}}};a.prototype._createTarget=function(c){var d=this;if(!this.view_model_create_fn){return c}return this.__kb.store.resolve(c,function(){var f,e;f=d.__kb.store.addResolverToOptions({},c);e=d.view_model_create_with_new?new d.view_model_create_fn(c,f):d.view_model_create_fn(c,f);kb.utils.wrappedModel(e,c);return e})};return a})(kb.RefCountable);__extends(Knockback.CollectionObservable.prototype,Backbone.Events);Knockback.collectionObservable=function(c,b,a){return new Knockback.CollectionObservable(c,b,a)};Knockback.sortedIndexWrapAttr=Knockback.siwa=function(a,b){return function(d,c){return _.sortedIndex(d,c,function(e){return new b(kb.utils.wrappedModel(e).get(a))})}};Knockback.defaultWrapper=function(a,c){var b;b=ko.dependentObservable({read:function(){var d,e;e=ko.utils.unwrapObservable(a());d=ko.utils.unwrapObservable(c);if(e){return e}else{return d}},write:function(d){return a(d)}});b.setToDefault=function(){return b(c)};return b};Knockback.toFormattedString=function(g){var b,e,d,c,a,f;a=g.slice();e=Array.prototype.slice.call(arguments,1);for(d in e){b=e[d];f=ko.utils.unwrapObservable(b);if(!f){f=""}c=g.indexOf("{"+d+"}");while(c>=0){a=a.replace("{"+d+"}",f);c=g.indexOf("{"+d+"}",c+1)}}return a};Knockback.parseFormattedString=function(h,m){var i,a,j,k,g,p,o,f,l,b,e,n,d,c;b=m.slice();j=0;p=0;f={};while(b.search("\\{"+j+"\\}")>=0){o=m.indexOf("{"+j+"}");while(o>=0){b=b.replace("{"+j+"}","(.*)");f[o]=j;p++;o=m.indexOf("{"+j+"}",o+1)}j++}i=j;l=new RegExp(b);g=l.exec(h);if(g){g.shift()}if(!g||(g.length!==p)){return _.map((function(){c=[];for(var q=1;1<=i?q<=i:q>=i;1<=i?q++:q--){c.push(q)}return c}).apply(this),function(){return""})}n=_.sortBy(_.keys(f),function(q,r){return parseInt(q,10)});a={};for(k in n){o=n[k];j=f[o];if(a.hasOwnProperty(j)){continue}a[j]=k}e=[];j=0;while(j<i){e.push(g[a[j]]);j++}return e};Knockback.formattedObservable=function(d,c){var b,a;b=Array.prototype.slice.call(arguments,1);a=ko.dependentObservable({read:function(){var e,g,f;c=[ko.utils.unwrapObservable(d)];for(g=0,f=b.length;g<f;g++){e=b[g];c.push(ko.utils.unwrapObservable(e))}return kb.toFormattedString.apply(null,c)},write:function(h){var f,g,i,e;g=kb.parseFormattedString(h,ko.utils.unwrapObservable(d));i=Math.min(b.length,g.length);f=0;e=[];while(f<i){b[f](g[f]);e.push(f++)}return e}});return a};Knockback.LocalizedObservable=(function(){a.name="LocalizedObservable";a.extend=Backbone.Model.extend;function a(d,c,b){var e;this.value=d;this.options=c!=null?c:{};this.view_model=b!=null?b:{};if(!(this.options.read||this.read)){throw new Error("LocalizedObservable: options.read is missing")}if(this.options.read&&this.read){throw new Error("LocalizedObservable: options.read and read class function exist. You need to choose one.")}if(this.options.write&&this.write){throw new Error("LocalizedObservable: options.write and write class function exist. You need to choose one.")}if(!kb.locale_manager){throw new Error("LocalizedObservable: Knockback.locale_manager is not defined")}this.__kb={};this.__kb._onLocaleChange=_.bind(this._onLocaleChange,this);if(this.value){d=ko.utils.unwrapObservable(this.value)}this.__kb.value_observable=ko.observable(!d?this._getDefaultValue():this.read.call(this,d,null));if(this.write&&!(typeof this.write==="function")){throw new Error("LocalizedObservable: options.write is not a function for read_write model attribute")}e=kb.utils.wrappedObservable(this,ko.dependentObservable({read:_.bind(this._onGetValue,this),write:this.write?_.bind(this._onSetValue,this):(function(){throw new Error("Knockback.LocalizedObservable: value is read only")}),owner:this.view_model}));e.destroy=_.bind(this.destroy,this);e.observedValue=_.bind(this.observedValue,this);e.setToDefault=_.bind(this.setToDefault,this);e.resetToCurrent=_.bind(this.resetToCurrent,this);kb.locale_manager.bind("change",this.__kb._onLocaleChange);return e}a.prototype.destroy=function(){kb.locale_manager.unbind("change",this.__kb._onLocaleChange);this.__kb.value_observable=null;kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);this.options={};this.view_model=null;return this.__kb=null};a.prototype.setToDefault=function(){var c,b;if(!this["default"]){return}b=this._getDefaultValue();c=this.__kb.value_observable();if(c!==b){return this._onSetValue(b)}else{return this.__kb.value_observable.valueHasMutated()}};a.prototype.resetToCurrent=function(){this.__kb.value_observable(null);return this._onSetValue(this._getCurrentValue())};a.prototype.observedValue=function(b){if(arguments.length===0){return this.value}this.value=b;this._onLocaleChange();return this};a.prototype._getDefaultValue=function(){if(!this["default"]){return""}if(typeof this["default"]==="function"){return this["default"]()}else{return this["default"]}};a.prototype._getCurrentValue=function(){var b;b=kb.utils.wrappedObservable(this);if(!(this.value&&b)){return this._getDefaultValue()}return this.read.call(this,ko.utils.unwrapObservable(this.value))};a.prototype._onGetValue=function(){if(this.value){ko.utils.unwrapObservable(this.value)}return this.__kb.value_observable()};a.prototype._onSetValue=function(b){this.write.call(this,b,ko.utils.unwrapObservable(this.value));b=this.read.call(this,ko.utils.unwrapObservable(this.value));this.__kb.value_observable(b);if(this.options.onChange){return this.options.onChange(b)}};a.prototype._onLocaleChange=function(){var b;b=this.read.call(this,ko.utils.unwrapObservable(this.value));this.__kb.value_observable(b);if(this.options.onChange){return this.options.onChange(b)}};return a})();Knockback.localizedObservable=function(c,b,a){return new Knockback.LocalizedObservable(c,b,a)};Knockback.Observable=(function(){a.name="Observable";function a(d,c,b){var e,f=this;this.model=d;this.options=c;this.view_model=b!=null?b:{};if(!this.model){throw new Error("Observable: model is missing")}if(!this.options){throw new Error("Observable: options is missing")}if(_.isString(this.options)||ko.isObservable(this.options)){this.options={key:this.options}}if(!this.options.key){throw new Error("Observable: options.key is missing")}this.__kb={};this.__kb._onModelChange=_.bind(this._onModelChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);if(this.options.hasOwnProperty("write")&&_.isBoolean(this.options.write)){this.options=_.clone(this.options);this.options.read_only=!this.options.write}if(Backbone.ModelRef&&(this.model instanceof Backbone.ModelRef)){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this.__kb._onModelLoaded);this.model_ref.bind("unloaded",this.__kb._onModelUnloaded);this.model=this.model_ref.getModel()}this.__kb.value_observable=ko.observable();if(this.options.localizer){this.__kb.localizer=new this.options.localizer(this._getCurrentValue())}e=kb.utils.wrappedObservable(this,ko.dependentObservable({read:_.bind(this._onGetValue,this),write:this.options.read_only?(function(){throw new Error("Knockback.Observable: "+f.options.key+" is read only")}):_.bind(this._onSetValue,this),owner:this.view_model}));e.destroy=_.bind(this.destroy,this);e.setToDefault=_.bind(this.setToDefault,this);if(!this.model_ref||this.model_ref.isLoaded()){this.model.bind("change",this.__kb._onModelChange)}return e}a.prototype.destroy=function(){this.__kb.value_observable=null;kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);if(this.model){this.__kb._onModelUnloaded(this.model)}if(this.model_ref){this.model_ref.unbind("loaded",this.__kb._onModelLoaded);this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.options=null;this.view_model=null;return this.__kb=null};a.prototype.setToDefault=function(){var b;b=this._getDefaultValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(b);b=this.__kb.localizer()}return this.__kb.value_observable(b)};a.prototype._getDefaultValue=function(){if(!this.options.hasOwnProperty("default")){return""}if(typeof this.options["default"]==="function"){return this.options["default"]()}else{return this.options["default"]}};a.prototype._getCurrentValue=function(){var b,d,e,g,c,f;if(!this.model){return this._getDefaultValue()}e=ko.utils.unwrapObservable(this.options.key);d=[e];if(!_.isUndefined(this.options.args)){if(_.isArray(this.options.args)){f=this.options.args;for(g=0,c=f.length;g<c;g++){b=f[g];d.push(ko.utils.unwrapObservable(b))}}else{d.push(ko.utils.unwrapObservable(this.options.args))}}if(this.options.read){return this.options.read.apply(this.view_model,d)}else{return this.model.get.apply(this.model,d)}};a.prototype._onGetValue=function(){var b,f,e,c,d;this.__kb.value_observable();ko.utils.unwrapObservable(this.options.key);if(!_.isUndefined(this.options.args)){if(_.isArray(this.options.args)){d=this.options.args;for(e=0,c=d.length;e<c;e++){b=d[e];ko.utils.unwrapObservable(b)}}else{ko.utils.unwrapObservable(this.options.args)}}f=this._getCurrentValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(f);f=this.__kb.localizer()}return f};a.prototype._onSetValue=function(h){var b,e,d,g,c,f;if(this.__kb.localizer){this.__kb.localizer(h);h=this.__kb.localizer.observedValue()}if(this.model){d={};d[ko.utils.unwrapObservable(this.options.key)]=h;e=typeof this.options.write==="function"?[h]:[d];if(!_.isUndefined(this.options.args)){if(_.isArray(this.options.args)){f=this.options.args;for(g=0,c=f.length;g<c;g++){b=f[g];e.push(ko.utils.unwrapObservable(b))}}else{e.push(ko.utils.unwrapObservable(this.options.args))}}if(typeof this.options.write==="function"){this.options.write.apply(this.view_model,e)}else{this.model.set.apply(this.model,e)}}if(this.__kb.localizer){return this.__kb.value_observable(this.__kb.localizer())}else{return this.__kb.value_observable(h)}};a.prototype._modelBind=function(b){if(!b){return}b.bind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&(b instanceof Backbone.RelationalModel)){b.bind("add",this.__kb._onModelChange);b.bind("remove",this.__kb._onModelChange);return b.bind("update",this.__kb._onModelChange)}};a.prototype._modelUnbind=function(b){if(!b){return}b.unbind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&(b instanceof Backbone.RelationalModel)){b.unbind("add",this.__kb._onModelChange);b.unbind("remove",this.__kb._onModelChange);return b.unbind("update",this.__kb._onModelChange)}};a.prototype._onModelLoaded=function(b){this.model=b;this._modelBind(b);return this._updateValue()};a.prototype._onModelUnloaded=function(b){if(this.__kb.localizer&&this.__kb.localizer.destroy){this.__kb.localizer.destroy();this.__kb.localizer=null}this._modelUnbind(b);return this.model=null};a.prototype._onModelChange=function(){if((this.model&&this.model.hasChanged)&&!this.model.hasChanged(ko.utils.unwrapObservable(this.options.key))){return}return this._updateValue()};a.prototype._updateValue=function(){var b;b=this._getCurrentValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(b);b=this.__kb.localizer()}return this.__kb.value_observable(b)};return a})();Knockback.observable=function(c,b,a){return new Knockback.Observable(c,b,a)};Knockback.Observables=(function(){a.name="Observables";function a(e,f,k,j){var g,h,c,i,d,b;this.model=e;this.mappings_info=f;this.view_model=k;if(!this.model){throw new Error("Observables: model is missing")}if(!this.mappings_info){throw new Error("Observables: mappings_info is missing")}if(j&&j.hasOwnProperty("write")){j.read_only=!j.write}if(!!j&&((_.isBoolean(j)&&!j)||!j.read_only)){c=_.isBoolean(j)?j:j.read_only;d=this.mappings_info;for(i in d){h=d[i];g=_.isString(h);if(g||!h.hasOwnProperty("read_only")||!h.hasOwnProperty("write")){h=g?{key:h,read_only:c}:_.extend({read_only:c},h)}this[i]=this.view_model[i]=kb.observable(this.model,h,this.view_model)}}else{b=this.mappings_info;for(i in b){h=b[i];this[i]=this.view_model[i]=kb.observable(this.model,h,this.view_model)}}}a.prototype.destroy=function(){var b,d,c;c=this.mappings_info;for(d in c){b=c[d];if(this.view_model[d]){this.view_model[d].destroy()}this.view_model[d]=null;this[d]=null}this.view_model=null;this.mappings_info=null;return this.model=null};a.prototype.setToDefault=function(){var c,e,d,b;d=this.mappings_info;b=[];for(e in d){c=d[e];b.push(this.view_model[e].setToDefault())}return b};return a})();Knockback.observables=function(c,d,a,b){return new Knockback.Observables(c,d,a,b)};Knockback.TriggeredObservable=(function(){a.name="TriggeredObservable";function a(b,d){var c;this.model=b;this.event_name=d;if(!this.model){throw new Error("Observable: model is missing")}if(!this.event_name){throw new Error("Observable: event_name is missing")}this.__kb={};this.__kb._onValueChange=_.bind(this._onValueChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);if(Backbone.ModelRef&&(this.model instanceof Backbone.ModelRef)){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this.__kb._onModelLoaded);this.model_ref.bind("unloaded",this.__kb._onModelUnloaded);this.model=this.model_ref.getModel()}this.__kb.value_observable=ko.observable();c=kb.utils.wrappedObservable(this,ko.dependentObservable(_.bind(this._onGetValue,this)));c.destroy=_.bind(this.destroy,this);if(!this.model_ref||this.model_ref.isLoaded()){this._onModelLoaded(this.model)}return c}a.prototype.destroy=function(){kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);this.__kb.value_observable=null;if(this.model){this._onModelUnloaded(this.model)}if(this.model_ref){this.model_ref.unbind("loaded",this.__kb._onModelLoaded);this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.options=null;this.view_model=null;return this.__kb=null};a.prototype._onGetValue=function(){return this.__kb.value_observable()};a.prototype._onModelLoaded=function(b){this.model=b;this.model.bind(this.event_name,this.__kb._onValueChange);return this._onValueChange()};a.prototype._onModelUnloaded=function(){if(this.__kb.localizer&&this.__kb.localizer.destroy){this.__kb.localizer.destroy();this.__kb.localizer=null}this.model.unbind(this.event_name,this.__kb._onValueChange);return this.model=null};a.prototype._onValueChange=function(){var b;b=this.__kb.value_observable();if(b!==this.model){return this.__kb.value_observable(this.model)}else{return this.__kb.value_observable.valueHasMutated()}};return a})();Knockback.triggeredObservable=function(a,b){return new Knockback.TriggeredObservable(a,b)};var __hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};Knockback.ViewModel_RCBase=(function(b){__extends(a,b);a.name="ViewModel_RCBase";function a(){return a.__super__.constructor.apply(this,arguments)}a.prototype.__destroy=function(){var d,e,c;c=[];for(d in this){e=this[d];if(!e||(d==="__kb")){continue}if(kb.utils.release(e)){c.push(this[d]=null)}else{c.push(void 0)}}return c};return a})(Knockback.RefCountable);Knockback.ViewModel=(function(b){__extends(a,b);a.name="ViewModel";function a(e,d){var g,f,h,c;if(d==null){d={}}a.__super__.constructor.apply(this,arguments);if(Knockback.stats_on){kb.stats.view_models++}kb.Store.resolveFromOptions(d,this);if(d.__kb_store){this.__kb.store=d.__kb_store}else{this.__kb.store=new kb.Store();this.__kb.store_is_owned=true}this.__kb._onModelChange=_.bind(this._onModelChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);this.__kb.internals=d.internals;this.__kb.requires=d.requires;this.__kb.children=d.children;this.__kb.create=d.create;this.__kb.read_only=d.read_only;kb.utils.wrappedModel(this,e);if(Backbone.ModelRef&&(e instanceof Backbone.ModelRef)){this.__kb.model_ref=e;this.__kb.model_ref.retain();kb.utils.wrappedModel(this,this.__kb.model_ref.getModel());this.__kb.model_ref.bind("loaded",this.__kb._onModelLoaded);this.__kb.model_ref.bind("unloaded",this.__kb._onModelUnloaded)}if(this.__kb.model){this._onModelLoaded(this.__kb.model)}if(!this.__kb.internals&&!this.__kb.requires){return this}f=_.union((this.__kb.internals?this.__kb.internals:[]),(this.__kb.requires?this.__kb.requires:[]));if(!this.__kb.model_ref||this.__kb.model_ref.isLoaded()){f=_.difference(f,_.keys(this.__kb.model.attributes))}for(h=0,c=f.length;h<c;h++){g=f[h];this._updateAttributeConnector(this.__kb.model,g)}}a.prototype.__destroy=function(){var c;c=this.__kb.model;kb.utils.wrappedModel(this,null);this._modelUnbind(c);if(this.__kb.store_is_owned){this.__kb.store.destroy()}this.__kb.store=null;a.__super__.__destroy.apply(this,arguments);if(Knockback.stats_on){return kb.stats.view_models--}};a.prototype.model=function(c){var d;d=kb.utils.wrappedModel(this);if(arguments.length===0){return d}if(c===d){return}if(d){this._onModelUnloaded(d)}if(c){return this._onModelLoaded(c)}};a.prototype._modelBind=function(c){if(!c){return}c.bind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&(c instanceof Backbone.RelationalModel)){c.bind("add",this.__kb._onModelChange);c.bind("remove",this.__kb._onModelChange);return c.bind("update",this.__kb._onModelChange)}};a.prototype._modelUnbind=function(c){if(!c){return}c.unbind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&(c instanceof Backbone.RelationalModel)){c.unbind("add",this.__kb._onModelChange);c.unbind("remove",this.__kb._onModelChange);return c.unbind("update",this.__kb._onModelChange)}};a.prototype._onModelLoaded=function(d){var e,c;kb.utils.wrappedModel(this,d);this._modelBind(d);c=[];for(e in this.__kb.model.attributes){c.push(this._updateAttributeConnector(this.__kb.model,e))}return c};a.prototype._onModelUnloaded=function(d){var e,c;this._modelUnbind(d);kb.utils.wrappedModel(this,null);c=[];for(e in d.attributes){c.push(this._updateAttributeConnector(null,e))}return c};a.prototype._onModelChange=function(){var e,c,d;if(this.__kb.model._changed){c=[];for(e in this.__kb.model.attributes){c.push(this.__kb.model.hasChanged(e)?this._updateAttributeConnector(this.__kb.model,e):void 0)}return c}else{if(this.__kb.model.changed){d=[];for(e in this.__kb.model.changed){d.push(this._updateAttributeConnector(this.__kb.model,e))}return d}}};a.prototype._updateAttributeConnector=function(c,e){var d;d=this.__kb.internals&&_.contains(this.__kb.internals,e)?"_"+e:e;return this[d]=kb.AttributeConnector.createOrUpdate(this[d],c,e,this._createOptions(e))};a.prototype._createOptions=function(d){var c;if(this.__kb.children){if(this.__kb.children.hasOwnProperty(d)){c=this.__kb.children[d];if(typeof c==="function"){c={view_model:c}}return _.defaults(c,{read_only:this.__kb.read_only,__kb_store:this.__kb.store})}else{if(this.__kb.children.hasOwnProperty("create")){return{create:this.__kb.children.create,read_only:this.__kb.read_only,__kb_store:this.__kb.store}}}}else{if(this.__kb.create){return{create:this.__kb.create,read_only:this.__kb.read_only,__kb_store:this.__kb.store}}}return{read_only:this.__kb.read_only,__kb_store:this.__kb.store}};return a})(Knockback.ViewModel_RCBase);Knockback.viewModel=function(b,a){return new Knockback.ViewModel(b,a)};