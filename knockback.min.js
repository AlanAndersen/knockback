// Generated by CoffeeScript 1.3.3
/*
  knockback.js 0.15.3
  (c) 2011 Kevin Malakoff.
  Knockback.js is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/knockback/blob/master/LICENSE
  Dependencies: Knockout.js, Backbone.js, and Underscore.js.
    Optional dependency: Backbone.ModelRef.js.
*/(function(){var a,b,c,d,e,f={}.hasOwnProperty,g=function(a,b){function d(){this.constructor=a}for(var c in b)f.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};b=c=this.Knockback=this.kb=typeof exports!="undefined"?exports:{},c.VERSION="0.15.3",e=!this._&&typeof require!="undefined"?require("underscore"):this._,a=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,d=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko,c.locale_manager=void 0,c.stats={collection_observables:0,view_models:0},c.stats_on=!1,c.utils={},c.utils.legacyWarning=function(a,b,d){var e;return c._legacy_warnings||(c._legacy_warnings={}),(e=c._legacy_warnings)[a]||(e[a]=0),c._legacy_warnings[a]++,console.warn("warning: '"+a+"' has been deprecated (will be removed in Knockback "+b+"). "+d+".")},c.utils.wrappedObservable=function(a,b){if(arguments.length===1){if(!(a&&a.__kb&&a.__kb.observable))throw"Knockback: instance is not wrapping an observable";return a.__kb.observable}if(!a)throw"Knockback: no instance for wrapping a observable";return a.__kb||(a.__kb={}),a.__kb.observable&&a.__kb.observable.__kb&&(a.__kb.observable.__kb.instance=null),a.__kb.observable=b,b&&(b.__kb||(b.__kb={}),b.__kb.instance=a),b},c.wrappedObservable=function(a){return c.utils.legacyWarning("kb.wrappedObservable","0.16.0","Please use kb.utils.wrappedObservable instead"),c.utils.wrappedObservable(a)},c.utils.observableInstanceOf=function(a,b){return a?!a.__kb||!a.__kb.instance?!1:a.__kb.instance instanceof b:!1},c.utils.wrappedModel=function(a,b){if(arguments.length===1)return a&&a.__kb&&a.__kb.hasOwnProperty("model")?a.__kb.model:a;if(!a)throw"Knockback: no view_model for wrapping a model";return a.__kb||(a.__kb={}),a.__kb.model=b,b},c.viewModelGetModel=c.vmModel=function(a){return c.utils.legacyWarning("kb.vmModel","0.16.0","Please use kb.utils.wrappedModel instead"),c.utils.wrappedModel(a)},c.utils.setToDefault=function(a){var b,f,g;if(!a)return;if(d.isObservable(a))return typeof a.setToDefault=="function"?a.setToDefault():void 0;if(e.isObject(a)){g=[];for(b in a)f=a[b],g.push(f&&b!=="__kb"?c.utils.setToDefault(f):void 0);return g}},c.vmSetToDefault=function(a){return c.utils.legacyWarning("kb.vmSetToDefault","0.16.0","Please use kb.utils.release instead"),c.utils.setToDefault(a)},c.utils.release=function(a,b){var f,g;if(!a)return!1;if(!b&&(d.isObservable(a)||a instanceof c.Observables||typeof a.release=="function"||typeof a.destroy=="function"))return a.release?a.release():a.destroy?a.destroy():a.dispose&&a.dispose(),!0;if(e.isObject(a)&&typeof a!="function"){for(f in a){g=a[f];if(!g||f==="__kb")continue;c.utils.release(g)&&(a[f]=null)}return!0}return!1},c.vmRelease=function(a){return c.utils.legacyWarning("kb.vmRelease","0.16.0","Please use kb.utils.release instead"),c.utils.release(a)},c.utils.optionsCreateClear=function(a){return delete a.create,delete a.children,delete a.view_model,delete a.view_model_create},c.utils.optionsCreateOverride=function(a,b){return c.utils.optionsCreateClear(a),e.extend(a,b)},c.RefCountable=function(){function b(){this.__kb||(this.__kb={}),this.__kb.ref_count=1}return b.extend=a.Model.extend,b.prototype.__destroy=function(){},b.prototype.retain=function(){if(this.__kb.ref_count<=0)throw"RefCountable: ref_count is corrupt: "+this.__kb.ref_count;return this.__kb.ref_count++,this},b.prototype.release=function(){if(this.__kb.ref_count<=0)throw"RefCountable: ref_count is corrupt: "+this.__kb.ref_count;return this.__kb.ref_count--,this.__kb.ref_count||this.__destroy(),this},b.prototype.refCount=function(){return this.__kb.ref_count},b}(),c.Store=function(){function a(){this.keys=[],this.values=[]}return a.prototype.destroy=function(){var a,b,d,e;this.keys=null,d=this.values;for(a in d){b=d[a];if(!c.utils.observableInstanceOf(b,c.CollectionObservable))continue;this.values[a]=null;while(b.refCount()>0)b.release()}e=this.values;for(a in e){b=e[a];if(!b)continue;this.values[a]=null;if(b instanceof c.RefCountable)while(b.refCount()>0)b.release();else c.utils.release(b)}return this.values=null},a.prototype.registerValue=function(a,b){var d;return b instanceof c.RefCountable&&b.retain(),d=e.indexOf(this.keys,a),d>=0?this.values[d]=b:(this.keys.push(a),this.values.push(b)),b},a.prototype.resolveValue=function(a,b,d){var f,g;f=e.indexOf(this.keys,a);if(f>=0){if(this.values[f]){if(!(this.values[f]instanceof c.RefCountable&&this.values[f].refCount()<=0))return this.values[f]instanceof c.RefCountable?this.values[f].retain():this.values[f];this.values[f]=null}}else f=this.keys.length,this.keys.push(a),this.values.push(void 0);return g=b.apply(null,Array.prototype.slice.call(arguments,2)),this.keys[f]!==a?this.registerValue(a,g):this.values[f]||(g instanceof c.RefCountable&&g.retain(),this.values[f]=g),g},a.prototype.releaseValue=function(a){var b;if(a instanceof c.RefCountable){a.release();if(a.refCount()>0)return;b=e.indexOf(this.values,a);if(b>=0)return this.values[b]=0;return}return},a.prototype.addResolverToOptions=function(a,b){return e.extend(a,{store:this,store_key:b})},a.resolveFromOptions=function(a,b){if(!a.store||!a.store_key)return;return a.store.registerValue(a.store_key,b)},a}(),c.CollectionObservable=function(a){function b(a,f){var g,h,i=this;f==null&&(f={});if(!a)throw"CollectionObservable: collection is missing";b.__super__.constructor.apply(this,arguments),c.stats_on&&c.stats.collection_observables++,d.isObservable(f)&&f.hasOwnProperty("indexOf")?(c.utils.legacyWarning("kb.collectionObservable with an external ko.observableArray","0.16.0","Please use the kb.collectionObservable directly instead of passing a ko.observableArray"),h=c.utils.wrappedObservable(this,f),f=arguments[2]||{},g=!0):h=c.utils.wrappedObservable(this,d.observableArray([])),f.store_skip_resolve||c.Store.resolveFromOptions(f,c.utils.wrappedObservable(this)),f.store?this.__kb.store=f.store:(this.__kb.store=new c.Store,this.__kb.store_is_owned=!0);if(f.hasOwnProperty("view_model")){if(!f.view_model)throw"kb.CollectionObservable: options.view_model is empty";this.view_model_create_fn=f.view_model,this.view_model_create_with_new=!0}else if(f.hasOwnProperty("view_model_constructor")){if(!f.view_model_constructor)throw"kb.CollectionObservable: options.view_model_constructor is empty";c.utils.legacyWarning("kb.collectionObservable option view_model_constructor","0.16.0","Please use view_model option instead"),this.view_model_create_fn=f.view_model_constructor,this.view_model_create_with_new=!0}else if(f.hasOwnProperty("view_model_create")){if(!f.view_model_create)throw"kb.CollectionObservable: options.view_model_create is empty";this.view_model_create_fn=f.view_model_create}else if(f.hasOwnProperty("create")){if(!f.create)throw"kb.CollectionObservable: options.create is empty";this.view_model_create_fn=f.create}return this.sort_attribute=f.sort_attribute,this.sorted_index=f.sorted_index,this.__kb._onCollectionReset=e.bind(this._onCollectionReset,this),this.__kb._onCollectionResort=e.bind(this._onCollectionResort,this),this.__kb._onModelAdd=e.bind(this._onModelAdd,this),this.__kb._onModelRemove=e.bind(this._onModelRemove,this),this.__kb._onModelChange=e.bind(this._onModelChange,this),g&&a&&a.bind("change",function(){return c.utils.wrappedObservable(i).valueHasMutated()}),h.retain=e.bind(this.retain,this),h.refCount=e.bind(this.refCount,this),h.release=e.bind(this.release,this),h.collection=e.bind(this.collection,this),h.viewModelByModel=e.bind(this.viewModelByModel,this),h.sortedIndex=e.bind(this.sortedIndex,this),h.sortAttribute=e.bind(this.sortAttribute,this),h.hasViewModels=e.bind(this.hasViewModels,this),h.bind=e.bind(this.bind,this),h.unbind=e.bind(this.unbind,this),h.trigger=e.bind(this.trigger,this),this.collection(a,{silent:!0,defer:f.defer}),h}return g(b,a),b.prototype.__destroy=function(){this.collection(null),this.hasViewModels()&&this.__kb.store_is_owned&&(this.__kb.store.destroy(),this.__kb.store=null),this.view_model_create_fn=null,this.__kb.collection=null,c.utils.wrappedObservable(this,null),b.__super__.__destroy.apply(this,arguments);if(c.stats_on)return c.stats.collection_observables--},b.prototype.retain=function(){return b.__super__.retain.apply(this,arguments),c.utils.wrappedObservable(this)},b.prototype.release=function(){var a;return a=c.utils.wrappedObservable(this),b.__super__.release.apply(this,arguments),a},b.prototype.collection=function(a,b){var d,e,f;d=c.utils.wrappedObservable(this);if(arguments.length===0)return d(),this.__kb.collection;if(a===this.__kb.collection)return;this.__kb.collection&&(this._clear(),this._collectionUnbind(this.__kb.collection),typeof (e=this.__kb.collection).release=="function"&&e.release(),this.__kb.collection=null),this.__kb.collection=a;if(this.__kb.collection)return typeof (f=this.__kb.collection).retain=="function"&&f.retain(),this._collectionBind(this.__kb.collection),this.sortedIndex(this.sorted_index,this.sort_attribute,b)},b.prototype.sortedIndex=function(a,b,d){var f,g=this;return d==null&&(d={}),a?(this.sorted_index=a,this.sort_attribute=b):b?(this.sort_attribute=b,this.sorted_index=this._sortAttributeFn(b)):(this.sort_attribute=null,this.sorted_index=null),f=function(){var a;a=c.utils.wrappedObservable(g);if(g.__kb.collection.models.length===0&&a().length===0)return;g._collectionResync(!0);if(!d.silent)return g.trigger("resort",a())},d.defer?e.defer(f):f(),this},b.prototype.sortAttribute=function(a,b,c){return this.sortedIndex(b,a,c)},b.prototype.viewModelByModel=function(a){var b,d;return this.hasViewModels()?(d=c.utils.wrappedObservable(this),b=a.hasOwnProperty(a.idAttribute)?a.idAttribute:"cid",e.find(d(),function(c){return c.__kb.model[b]===a[b]})):null},b.prototype.hasViewModels=function(){return!!this.view_model_create_fn},b.prototype._collectionBind=function(a){var b,c,d,e,f,g,h;if(!a)return;a.bind("reset",this.__kb._onCollectionReset),this.sorted_index||a.bind("resort",this.__kb._onCollectionResort),g=["new","add"];for(c=0,e=g.length;c<e;c++)b=g[c],a.bind(b,this.__kb._onModelAdd);h=["remove","destroy"];for(d=0,f=h.length;d<f;d++)b=h[d],a.bind(b,this.__kb._onModelRemove);return a.bind("change",this.__kb._onModelChange)},b.prototype._collectionUnbind=function(a){var b,c,d,e,f,g,h;if(!a)return;a.unbind("reset",this.__kb._onCollectionReset),this.sorted_index||a.unbind("resort",this.__kb._onCollectionResort),g=["new","add"];for(c=0,e=g.length;c<e;c++)b=g[c],a.unbind(b,this.__kb._onModelAdd);h=["remove","destroy"];for(d=0,f=h.length;d<f;d++)b=h[d],a.unbind(b,this.__kb._onModelRemove);return a.unbind("change",this.__kb._onModelChange)},b.prototype._onCollectionReset=function(){return this._collectionResync()},b.prototype._onCollectionResort=function(a){var b;if(this.sorted_index)throw"CollectionObservable: collection sorted_index unexpected";return e.isArray(a)?(b=c.utils.wrappedObservable(this),this.trigger("resort",b())):this._onModelResort(a)},b.prototype._onModelAdd=function(a){var b,d,e;return e=this.hasViewModels()?this._createTarget(a):a,d=c.utils.wrappedObservable(this),this.sorted_index?b=this.sorted_index(d(),e):b=this.__kb.collection.indexOf(a),d.splice(b,0,e),this.trigger("add",e,d())},b.prototype._onModelRemove=function(a){var b,d;d=this.hasViewModels()?this.viewModelByModel(a):a;if(!d)return;b=c.utils.wrappedObservable(this),b.remove(d),this.trigger("remove",d,b);if(this.hasViewModels())return this.__kb.store.releaseValue(d)},b.prototype._onModelChange=function(a){if(this.sorted_index&&(!this.sort_attribute||a.hasChanged(this.sort_attribute)))return this._onModelResort(a)},b.prototype._onModelResort=function(a){var b,d,f,g,h;d=c.utils.wrappedObservable(this),h=this.hasViewModels()?this.viewModelByModel(a):a,f=d.indexOf(h),this.sorted_index?(g=e.clone(d()),g.splice(f,1),b=this.sorted_index(g,h)):b=this.__kb.collection.indexOf(a);if(f===b)return;return d.splice(f,1),d.splice(b,0,h),this.trigger("resort",h,d(),b)},b.prototype._clear=function(a){var b,d,e,f,g,h;b=c.utils.wrappedObservable(this),a||this.trigger("remove",b()),e=b.removeAll();if(this.hasViewModels()){h=[];for(f=0,g=e.length;f<g;f++)d=e[f],h.push(this.__kb.store.releaseValue(d));return h}},b.prototype._collectionResync=function(a){var b,d,f,g,h,i,j,k,l=this;this._clear(a),f=c.utils.wrappedObservable(this);if(this.sorted_index){h=[],k=this.__kb.collection.models;for(i=0,j=k.length;i<j;i++)d=k[i],g=this._createTarget(d),b=this.sorted_index(h,g),h.splice(b,0,g)}else h=this.hasViewModels()?e.map(this.__kb.collection.models,function(a){return l._createTarget(a)}):e.clone(this.__kb.collection.models);f(h);if(!a)return this.trigger("add",f())},b.prototype._sortAttributeFn=function(a){return this.hasViewModels()?function(b,d){return e.sortedIndex(b,d,function(b){return c.utils.wrappedModel(b).get(a)})}:function(b,c){return e.sortedIndex(b,c,function(b){return b.get(a)})}},b.prototype._createTarget=function(a){var b,d=this;return b=function(){var b,e,f;return e=d.__kb.store.addResolverToOptions({},a),b=c.utils.wrappedObservable(d),f=d.view_model_create_with_new?new d.view_model_create_fn(a,e,b):d.view_model_create_fn(a,e,b),c.utils.wrappedModel(f,a),f},this.hasViewModels()?this.__kb.store.resolveValue(a,b):a},b}(c.RefCountable),g(c.CollectionObservable.prototype,a.Events),c.collectionObservable=function(a,b,d){return new c.CollectionObservable(a,b,d)},c.sortedIndexWrapAttr=c.siwa=function(a,b){return function(d,f){return e.sortedIndex(d,f,function(d){return new b(c.utils.wrappedModel(d).get(a))})}},c.DefaultWrapper=function(){function a(a,b){var f,g=this;return this.default_value_observable=b,this.__kb={},f=c.utils.wrappedObservable(this,d.dependentObservable({read:function(){var b,c;return c=d.utils.unwrapObservable(a()),b=d.utils.unwrapObservable(g.default_value_observable),c?c:b},write:function(b){return a(b)}})),f.destroy=e.bind(this.destroy,this),f.setToDefault=e.bind(this.setToDefault,this),f}return a.prototype.destroy=function(){return c.utils.wrappedObservable(this,null),this.default_value=null},a.prototype.setToDefault=function(){var a;return a=c.utils.wrappedObservable(this),a(this.default_value_observable)},a}(),c.defaultWrapper=function(a,b){return new c.DefaultWrapper(a,b)},c.toFormattedString=function(a){var b,c,e,f,g,h;g=a.slice(),c=Array.prototype.slice.call(arguments,1);for(e in c){b=c[e],h=d.utils.unwrapObservable(b),h||(h=""),f=a.indexOf("{"+e+"}");while(f>=0)g=g.replace("{"+e+"}",h),f=a.indexOf("{"+e+"}",f+1)}return g},c.parseFormattedString=function(a,b){var c,d,f,g,h,i,j,k,l,m,n,o,p,q;m=b.slice(),f=0,i=0,k={};while(m.search("\\{"+f+"\\}")>=0){j=b.indexOf("{"+f+"}");while(j>=0)m=m.replace("{"+f+"}","(.*)"),k[j]=f,i++,j=b.indexOf("{"+f+"}",j+1);f++}c=f,l=new RegExp(m),h=l.exec(a),h&&h.shift();if(!h||h.length!==i)return e.map(function(){q=[];for(var a=1;1<=c?a<=c:a>=c;1<=c?a++:a--)q.push(a);return q}.apply(this),function(){return""});o=e.sortBy(e.keys(k),function(a,b){return parseInt(a,10)}),d={};for(g in o){j=o[g],f=k[j];if(d.hasOwnProperty(f))continue;d[f]=g}n=[],f=0;while(f<c)n.push(h[d[f]]),f++;return n},c.FormattedObservable=function(){function a(a,b){var f,g;return this.__kb={},e.isArray(b)?(a=a,g=b):g=Array.prototype.slice.call(arguments,1),f=c.utils.wrappedObservable(this,d.dependentObservable({read:function(){var e,f,h;b=[d.utils.unwrapObservable(a)];for(f=0,h=g.length;f<h;f++)e=g[f],b.push(d.utils.unwrapObservable(e));return c.toFormattedString.apply(null,b)},write:function(b){var e,f,h,i;f=c.parseFormattedString(b,d.utils.unwrapObservable(a)),h=Math.min(g.length,f.length),e=0,i=[];while(e<h)g[e](f[e]),i.push(e++);return i}})),f}return a.prototype.destroy=function(){return c.utils.wrappedObservable(this,null)},a}(),c.formattedObservable=function(a,b){return new c.FormattedObservable(a,Array.prototype.slice.call(arguments,1))},c.LocalizedObservable=function(){function b(a,b,f){var g;this.value=a,this.options=b!=null?b:{},this.view_model=f!=null?f:{};if(!this.options.read&&!this.read)throw"LocalizedObservable: options.read is missing";if(this.options.read&&this.read)throw"LocalizedObservable: options.read and read class function exist. You need to choose one.";if(this.options.write&&this.write)throw"LocalizedObservable: options.write and write class function exist. You need to choose one.";if(!c.locale_manager)throw"LocalizedObservable: kb.locale_manager is not defined";this.__kb={},this.__kb._onLocaleChange=e.bind(this._onLocaleChange,this),this.value&&(a=d.utils.unwrapObservable(this.value)),this.__kb.value_observable=d.observable(a?this.read.call(this,a,null):this._getDefaultValue());if(this.write&&typeof this.write!="function")throw"LocalizedObservable: options.write is not a function for read_write model attribute";return g=c.utils.wrappedObservable(this,d.dependentObservable({read:e.bind(this._onGetValue,this),write:this.write?e.bind(this._onSetValue,this):function(){throw"kb.LocalizedObservable: value is read only"},owner:this.view_model})),g.destroy=e.bind(this.destroy,this),g.observedValue=e.bind(this.observedValue,this),g.setToDefault=e.bind(this.setToDefault,this),g.resetToCurrent=e.bind(this.resetToCurrent,this),c.locale_manager.bind("change",this.__kb._onLocaleChange),g}return b.extend=a.Model.extend,b.prototype.destroy=function(){return c.locale_manager.unbind("change",this.__kb._onLocaleChange),this.__kb.value_observable=null,c.utils.wrappedObservable(this).dispose(),c.utils.wrappedObservable(this,null),this.options={},this.view_model=null,this.__kb=null},b.prototype.setToDefault=function(){var a,b;if(!this["default"])return;return b=this._getDefaultValue(),a=this.__kb.value_observable(),a!==b?this._onSetValue(b):this.__kb.value_observable.valueHasMutated()},b.prototype.resetToCurrent=function(){return this.__kb.value_observable(null),this._onSetValue(this._getCurrentValue())},b.prototype.observedValue=function(a){return arguments.length===0?this.value:(this.value=a,this._onLocaleChange(),this)},b.prototype._getDefaultValue=function(){return this["default"]?typeof this["default"]=="function"?this["default"]():this["default"]:""},b.prototype._getCurrentValue=function(){var a;return a=c.utils.wrappedObservable(this),!this.value||!a?this._getDefaultValue():this.read.call(this,d.utils.unwrapObservable(this.value))},b.prototype._onGetValue=function(){return this.value&&d.utils.unwrapObservable(this.value),this.__kb.value_observable()},b.prototype._onSetValue=function(a){this.write.call(this,a,d.utils.unwrapObservable(this.value)),a=this.read.call(this,d.utils.unwrapObservable(this.value)),this.__kb.value_observable(a);if(this.options.onChange)return this.options.onChange(a)},b.prototype._onLocaleChange=function(){var a;a=this.read.call(this,d.utils.unwrapObservable(this.value)),this.__kb.value_observable(a);if(this.options.onChange)return this.options.onChange(a)},b}(),c.localizedObservable=function(a,b,d){return new c.LocalizedObservable(a,b,d)},c.Observable=function(){function b(b,f,g){var h,i=this;this.model=b,this.mapping_info=f,this.view_model=g!=null?g:{};if(!this.model)throw"Observable: model is missing";if(!this.mapping_info)throw"Observable: mapping_info is missing";if(e.isString(this.mapping_info)||d.isObservable(this.mapping_info))this.mapping_info={key:this.mapping_info};if(!this.mapping_info.key)throw"Observable: mapping_info.key is missing";return this.__kb={},this.__kb._onModelChange=e.bind(this._onModelChange,this),this.__kb._onModelLoaded=e.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=e.bind(this._onModelUnloaded,this),this.mapping_info.hasOwnProperty("write")&&e.isBoolean(this.mapping_info.write)&&(this.mapping_info=e.clone(this.mapping_info),this.mapping_info.read_only=!this.mapping_info.write),a.ModelRef&&this.model instanceof a.ModelRef&&(this.model_ref=this.model,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),this.model=this.model_ref.getModel()),this.__kb.value_observable=d.observable(),this.mapping_info.localizer&&(this.__kb.localizer=new this.mapping_info.localizer(this._getCurrentValue())),h=c.utils.wrappedObservable(this,d.dependentObservable({read:e.bind(this._onGetValue,this),write:this.mapping_info.read_only?function(){throw"kb.Observable: "+i.mapping_info.key+" is read only"}:e.bind(this._onSetValue,this),owner:this.view_model})),h.destroy=e.bind(this.destroy,this),h.setToDefault=e.bind(this.setToDefault,this),(!this.model_ref||this.model_ref.isLoaded())&&this.model.bind("change",this.__kb._onModelChange),h}return b.prototype.destroy=function(){return this.__kb.value_observable=null,c.utils.wrappedObservable(this).dispose(),c.utils.wrappedObservable(this,null),this.model&&this.__kb._onModelUnloaded(this.model),this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),this.mapping_info=null,this.view_model=null,this.__kb=null},b.prototype.setToDefault=function(){var a;return a=this._getDefaultValue(),this.__kb.localizer&&(this.__kb.localizer.observedValue(a),a=this.__kb.localizer()),this.__kb.value_observable(a)},b.prototype._getDefaultValue=function(){return this.mapping_info.hasOwnProperty("default")?typeof this.mapping_info["default"]=="function"?this.mapping_info["default"]():this.mapping_info["default"]:""},b.prototype._getCurrentValue=function(){var a,b,c,f,g,h;if(!this.model)return this._getDefaultValue();c=d.utils.unwrapObservable(this.mapping_info.key),b=[c];if(!e.isUndefined(this.mapping_info.args))if(e.isArray(this.mapping_info.args)){h=this.mapping_info.args;for(f=0,g=h.length;f<g;f++)a=h[f],b.push(d.utils.unwrapObservable(a))}else b.push(d.utils.unwrapObservable(this.mapping_info.args));return this.mapping_info.read?this.mapping_info.read.apply(this.view_model,b):this.model.get.apply(this.model,b)},b.prototype._onGetValue=function(){var a,b,c,f,g;this.__kb.value_observable(),d.utils.unwrapObservable(this.mapping_info.key);if(!e.isUndefined(this.mapping_info.args))if(e.isArray(this.mapping_info.args)){g=this.mapping_info.args;for(c=0,f=g.length;c<f;c++)a=g[c],d.utils.unwrapObservable(a)}else d.utils.unwrapObservable(this.mapping_info.args);return b=this._getCurrentValue(),this.__kb.localizer&&(this.__kb.localizer.observedValue(b),b=this.__kb.localizer()),b},b.prototype._onSetValue=function(a){var b,c,f,g,h,i;this.__kb.localizer&&(this.__kb.localizer(a),a=this.__kb.localizer.observedValue());if(this.model){f={},f[d.utils.unwrapObservable(this.mapping_info.key)]=a,c=typeof this.mapping_info.write=="function"?[a]:[f];if(!e.isUndefined(this.mapping_info.args))if(e.isArray(this.mapping_info.args)){i=this.mapping_info.args;for(g=0,h=i.length;g<h;g++)b=i[g],c.push(d.utils.unwrapObservable(b))}else c.push(d.utils.unwrapObservable(this.mapping_info.args));typeof this.mapping_info.write=="function"?this.mapping_info.write.apply(this.view_model,c):this.model.set.apply(this.model,c)}return this.__kb.localizer?this.__kb.value_observable(this.__kb.localizer()):this.__kb.value_observable(a)},b.prototype._modelBind=function(b){if(!b)return;b.bind("change",this.__kb._onModelChange);if(a.RelationalModel&&b instanceof a.RelationalModel)return b.bind("add",this.__kb._onModelChange),b.bind("remove",this.__kb._onModelChange),b.bind("update",this.__kb._onModelChange)},b.prototype._modelUnbind=function(b){if(!b)return;b.unbind("change",this.__kb._onModelChange);if(a.RelationalModel&&b instanceof a.RelationalModel)return b.unbind("add",this.__kb._onModelChange),b.unbind("remove",this.__kb._onModelChange),b.unbind("update",this.__kb._onModelChange)},b.prototype._onModelLoaded=function(a){return this.model=a,this._modelBind(a),this._updateValue()},b.prototype._onModelUnloaded=function(a){return this.__kb.localizer&&this.__kb.localizer.destroy&&(this.__kb.localizer.destroy(),this.__kb.localizer=null),this._modelUnbind(a),this.model=null},b.prototype._onModelChange=function(){if(this.model&&this.model.hasChanged&&!this.model.hasChanged(d.utils.unwrapObservable(this.mapping_info.key)))return;return this._updateValue()},b.prototype._updateValue=function(){var a;return a=this._getCurrentValue(),this.__kb.localizer&&(this.__kb.localizer.observedValue(a),a=this.__kb.localizer()),this.__kb.value_observable(a)},b}(),c.observable=function(a,b,d){return new c.Observable(a,b,d)},c.Observables=function(){function a(a,b,d,f){var g,h,i,j,k,l,m,n,o;if(!a)throw"Observables: model is missing";if(!b||!e.isObject(b)&&!e.isArray(b))throw"Observables: mappings_info is missing";this.__kb||(this.__kb={}),this.__kb.model=a;if(e.isArray(b)){this.__kb.mappings_info={};for(l=0,m=b.length;l<m;l++)h=b[l],this.__kb.mappings_info[h]={}}else this.__kb.mappings_info=b;this.__kb.view_model=e.isUndefined(d)?this:d,!e.isUndefined(f)&&f.hasOwnProperty("write")&&(c.utils.legacyWarning("kb.Observables option.write","0.16.0","Now default is writable so only supply read_only as required"),f.read_only=!f.write,delete f.write);if(!e.isUndefined(f)){k=e.isBoolean(f)?f:f.read_only,n=this.__kb.mappings_info;for(j in n)i=n[j],g=e.isString(i),g?i=e.isUndefined(k)?{key:i}:{key:i,read_only:k}:!e.isUndefined(k)&&!i.hasOwnProperty("read_only")&&!i.hasOwnProperty("write")&&(i.read_only=k),i.hasOwnProperty("key")||(i.key=j),this[j]=this.__kb.view_model[j]=c.observable(this.__kb.model,i,this.__kb.view_model)}else{o=this.__kb.mappings_info;for(j in o)i=o[j],i.hasOwnProperty("write")&&c.utils.legacyWarning("kb.Observables option.write","0.16.0","Now default is writable so only supply read_only as required"),i.hasOwnProperty("key")||(i.key=j),this[j]=this.__kb.view_model[j]=c.observable(this.__kb.model,i,this.__kb.view_model)}}return a.prototype.destroy=function(){var a,b,c;c=this.__kb.mappings_info;for(b in c)a=c[b],this.__kb.view_model[b]&&this.__kb.view_model[b].destroy(),this.__kb.view_model[b]=null,this[b]=null;return this.__kb.view_model=null,this.__kb.mappings_info=null,this.__kb.model=null},a.prototype.setToDefault=function(){var a,b,c,d;c=this.__kb.mappings_info,d=[];for(b in c)a=c[b],d.push(this.__kb.view_model[b].setToDefault());return d},a}(),c.observables=function(a,b,d,e){return new c.Observables(a,b,d,e)},c.TriggeredObservable=function(){function b(b,f){var g;this.model=b,this.event_name=f;if(!this.model)throw"Observable: model is missing";if(!this.event_name)throw"Observable: event_name is missing";return this.__kb={},this.__kb._onValueChange=e.bind(this._onValueChange,this),this.__kb._onModelLoaded=e.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=e.bind(this._onModelUnloaded,this),a.ModelRef&&this.model instanceof a.ModelRef&&(this.model_ref=this.model,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),this.model=this.model_ref.getModel()),this.__kb.value_observable=d.observable(),g=c.utils.wrappedObservable(this,d.dependentObservable(e.bind(this._onGetValue,this))),g.destroy=e.bind(this.destroy,this),(!this.model_ref||this.model_ref.isLoaded())&&this._onModelLoaded(this.model),g}return b.prototype.destroy=function(){return c.utils.wrappedObservable(this).dispose(),c.utils.wrappedObservable(this,null),this.__kb.value_observable=null,this.model&&this._onModelUnloaded(this.model),this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),this.options=null,this.view_model=null,this.__kb=null},b.prototype._onGetValue=function(){return this.__kb.value_observable()},b.prototype._onModelLoaded=function(a){return this.model=a,this.model.bind(this.event_name,this.__kb._onValueChange),this._onValueChange()},b.prototype._onModelUnloaded=function(){return this.__kb.localizer&&this.__kb.localizer.destroy&&(this.__kb.localizer.destroy(),this.__kb.localizer=null),this.model.unbind(this.event_name,this.__kb._onValueChange),this.model=null},b.prototype._onValueChange=function(){var a;return a=this.__kb.value_observable(),a!==this.model?this.__kb.value_observable(this.model):this.__kb.value_observable.valueHasMutated()},b}(),c.triggeredObservable=function(a,b){return new c.TriggeredObservable(a,b)},c.AttributeConnector=function(){function b(a,b,f){var g;return this.key=b,this.options=f!=null?f:{},c.utils.wrappedModel(this,a),this.options=e.clone(this.options),this.__kb.value_observable=d.observable(),g=c.utils.wrappedObservable(this,d.dependentObservable({read:e.bind(this.read,this),write:e.bind(this.write,this)})),g.destroy=e.bind(this.destroy,this),g.model=e.bind(this.model,this),g.update=e.bind(this.update,this),this.__kb.initializing=!0,this.update(),this.__kb.initializing=!1,g}return b.prototype.destroy=function(){return this.__kb.value_observable=null,c.utils.wrappedObservable(this).dispose(),c.utils.wrappedObservable(this,null)},b.prototype.read=function(){return this.__kb.value_observable()},b.prototype.write=function(a){var b,d;b=c.utils.wrappedModel(this);if(!b)return;if(!this.options.read_only)return d={},d[this.key]=a,b.set(d);if(!this.__kb.initializing)throw"Cannot write a value to a dependentObservable unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters."},b.prototype.model=function(a){var b;b=c.utils.wrappedModel(this);if(arguments.length===0)return b;if(b===a)return;return c.utils.wrappedModel(this,a),this.update()},b.inferType=function(b,c){var d,f;return f=b.get(c),f?f instanceof a.Collection?"collection":f instanceof a.Model||a.ModelRef&&f instanceof a.ModelRef?"model":"simple":a.RelationalModel&&b instanceof a.RelationalModel?(d=e.find(b.getRelations(),function(a){return a.key===c}),d?d.collectionKey?"collection":"model":"simple"):"simple"},b.createByType=function(a,b,d,f){var g;switch(a){case"collection":return g=f?e.clone(f):{},f.view_model||f.view_model_create||f.children||f.create||(g.view_model=c.ViewModel),f.store&&f.store.addResolverToOptions(g,b.get(d)),c.collectionAttributeConnector(b,d,g);case"model":return g=f?e.clone(f):{},g.options||(g.options={}),f.view_model||f.view_model_create||f.children||f.create||(g.view_model=c.ViewModel),f.store&&f.store.addResolverToOptions(g.options,b.get(d)),c.viewModelAttributeConnector(b,d,g);default:return c.simpleAttributeConnector(b,d,f)}},b.createOrUpdate=function(a,b,d,e){var f,g;if(a)return c.utils.observableInstanceOf(a,c.AttributeConnector)&&(a.model()!==b?a.model(b):a.update()),a;if(!b)return c.simpleAttributeConnector(b,d,e);if(e.hasOwnProperty("create")){if(!e.create)throw"kb.AttributeConnector: options.create is empty";return e.create(b,d,e.options||{})}g=b.get(d);if(e.hasOwnProperty("view_model")){if(!e.view_model)throw"kb.AttributeConnector: options.view_model is empty";return new e.view_model(g,e.options||{})}if(e.hasOwnProperty("view_model_create")){if(!e.view_model_create)throw"kb.AttributeConnector: options.view_model_create is empty";return e.view_model_create(g,e.options||{})}if(e.hasOwnProperty("children")){if(!e.children)throw"kb.AttributeConnector: options.children is empty";return typeof e.children=="function"?f={view_model:e.children}:f=e.children||{},c.collectionAttributeConnector(b,d,f)}return this.createByType(this.inferType(b,d),b,d,e)},b}(),c.SimpleAttributeConnector=function(a){function b(){return b.__super__.constructor.apply(this,arguments),c.utils.wrappedObservable(this)}return g(b,a),b.prototype.destroy=function(){return this.current_value=null,b.__super__.destroy.apply(this,arguments)},b.prototype.update=function(){var a,b,d;b=c.utils.wrappedModel(this);if(!b)return;d=b.get(this.key),a=this.__kb.value_observable();if(!e.isEqual(a,d))return this.__kb.value_observable(d)},b.prototype.write=function(a){var d;d=c.utils.wrappedModel(this);if(!d){this.__kb.value_observable(a);return}return b.__super__.write.apply(this,arguments)},b}(c.AttributeConnector),c.simpleAttributeConnector=function(a,b,d){return new c.SimpleAttributeConnector(a,b,d)},c.CollectionAttributeConnector=function(a){function b(){return b.__super__.constructor.apply(this,arguments),c.utils.wrappedObservable(this)}return g(b,a),b.prototype.destroy=function(){var a;return a=this.__kb.value_observable(),a&&typeof a.refCount=="function"&&a.refCount()>0&&a.release(),b.__super__.destroy.apply(this,arguments)},b.prototype.update=function(){var a,b,d,e=this;b=c.utils.wrappedModel(this
);if(!b)return;d=b.get(this.key),a=this.__kb.value_observable();if(!a)return this.options.store?this.__kb.value_observable(this.options.store.resolveValue(d,function(){return c.collectionObservable(d,e.options)})):this.__kb.value_observable(c.collectionObservable(d,this.options));if(a.collection()!==d)return a.collection(d),this.__kb.value_observable.valueHasMutated()},b.prototype.read=function(){var a;return a=this.__kb.value_observable(),a?a():void 0},b}(c.AttributeConnector),c.collectionAttributeConnector=function(a,b,d){return new c.CollectionAttributeConnector(a,b,d)},c.ViewModelAttributeConnector=function(a){function b(){return b.__super__.constructor.apply(this,arguments),c.utils.wrappedObservable(this)}return g(b,a),b.prototype.destroy=function(){var a;return a=this.__kb.value_observable(),a&&typeof a.refCount=="function"&&a.refCount()>0&&a.release(),b.__super__.destroy.apply(this,arguments)},b.prototype.update=function(){var a,b,d,f,g=this;b=c.utils.wrappedModel(this);if(!b)return;d=b.get(this.key),a=this.__kb.value_observable();if(!a)return f=this.options.options?e.clone(this.options.options):{},f.store?this.__kb.value_observable(f.store.resolveValue(d,function(){return g.options.view_model?new g.options.view_model(d,f):g.options.view_model_create(d,f)})):this.__kb.value_observable(this.options.view_model?new this.options.view_model(d,f):this.options.view_model_create(d,f));if(!a.model||typeof a.model!="function")throw"kb.viewModelAttributeConnector: unknown how to model a view model";if(a.model()!==d)return a.model(d),this.__kb.value_observable.valueHasMutated()},b}(c.AttributeConnector),c.viewModelAttributeConnector=function(a,b,d){return new c.ViewModelAttributeConnector(a,b,d)},c.ViewModel=function(b){function d(b,f){var g,h,i,j;f==null&&(f={}),d.__super__.constructor.apply(this,arguments),c.stats_on&&c.stats.view_models++,f.store_skip_resolve||c.Store.resolveFromOptions(f,this),f.store?this.__kb.store=f.store:(this.__kb.store=new c.Store,this.__kb.store_is_owned=!0),this.__kb._onModelChange=e.bind(this._onModelChange,this),this.__kb._onModelLoaded=e.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=e.bind(this._onModelUnloaded,this),this.__kb.internals=f.internals,this.__kb.requires=f.requires,this.__kb.children=f.children,this.__kb.create=f.create,this.__kb.read_only=f.read_only,c.utils.wrappedModel(this,b),a.ModelRef&&b instanceof a.ModelRef&&(this.__kb.model_ref=b,this.__kb.model_ref.retain(),c.utils.wrappedModel(this,this.__kb.model_ref.getModel()),this.__kb.model_ref.bind("loaded",this.__kb._onModelLoaded),this.__kb.model_ref.bind("unloaded",this.__kb._onModelUnloaded)),this.__kb.model&&this._onModelLoaded(this.__kb.model);if(!this.__kb.internals&&!this.__kb.requires)return this;h=e.union(this.__kb.internals?this.__kb.internals:[],this.__kb.requires?this.__kb.requires:[]);if(!this.__kb.model_ref||this.__kb.model_ref.isLoaded())h=e.difference(h,e.keys(this.__kb.model.attributes));for(i=0,j=h.length;i<j;i++)g=h[i],this._updateAttributeConnector(this.__kb.model,g)}return g(d,b),d.prototype.__destroy=function(){var a;a=this.__kb.model,c.utils.wrappedModel(this,null),this._modelUnbind(a),this.__kb.store_is_owned&&this.__kb.store.destroy(),this.__kb.store=null,c.utils.release(this,!0),d.__super__.__destroy.apply(this,arguments);if(c.stats_on)return c.stats.view_models--},d.prototype.model=function(a){var b;b=c.utils.wrappedModel(this);if(arguments.length===0)return b;if(a===b)return;b&&this._onModelUnloaded(b);if(a)return this._onModelLoaded(a)},d.prototype._modelBind=function(b){if(!b)return;b.bind("change",this.__kb._onModelChange);if(a.RelationalModel&&b instanceof a.RelationalModel)return b.bind("add",this.__kb._onModelChange),b.bind("remove",this.__kb._onModelChange),b.bind("update",this.__kb._onModelChange)},d.prototype._modelUnbind=function(b){if(!b)return;b.unbind("change",this.__kb._onModelChange);if(a.RelationalModel&&b instanceof a.RelationalModel)return b.unbind("add",this.__kb._onModelChange),b.unbind("remove",this.__kb._onModelChange),b.unbind("update",this.__kb._onModelChange)},d.prototype._onModelLoaded=function(a){var b,d;c.utils.wrappedModel(this,a),this._modelBind(a),d=[];for(b in this.__kb.model.attributes)d.push(this._updateAttributeConnector(this.__kb.model,b));return d},d.prototype._onModelUnloaded=function(a){var b,d;this._modelUnbind(a),c.utils.wrappedModel(this,null),d=[];for(b in a.attributes)d.push(this._updateAttributeConnector(null,b));return d},d.prototype._onModelChange=function(){var a,b,c;if(this.__kb.model._changed){b=[];for(a in this.__kb.model.attributes)b.push(this.__kb.model.hasChanged(a)?this._updateAttributeConnector(this.__kb.model,a):void 0);return b}if(this.__kb.model.changed){c=[];for(a in this.__kb.model.changed)c.push(this._updateAttributeConnector(this.__kb.model,a));return c}},d.prototype._updateAttributeConnector=function(a,b){var d;return d=this.__kb.internals&&e.contains(this.__kb.internals,b)?"_"+b:b,this[d]=c.AttributeConnector.createOrUpdate(this[d],a,b,this._createOptions(b))},d.prototype._createOptions=function(a){var b;if(this.__kb.children){if(this.__kb.children.hasOwnProperty(a))return b=this.__kb.children[a],typeof b=="function"&&(b={view_model:b}),b.options={read_only:this.__kb.read_only,store:this.__kb.store},b;if(this.__kb.children.hasOwnProperty("create"))return{create:this.__kb.children.create,options:{read_only:this.__kb.read_only,store:this.__kb.store}}}else if(this.__kb.create)return{create:this.__kb.create,options:{read_only:this.__kb.read_only,store:this.__kb.store}};return{read_only:this.__kb.read_only,store:this.__kb.store}},d}(c.RefCountable),c.viewModel=function(a,b){return new c.ViewModel(a,b)}}).call(this);