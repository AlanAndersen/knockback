/*
 knockback.js 0.8.0
 (c) 2011 Kevin Malakoff.
 Knockback.js is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/knockback/blob/master/LICENSE
 Dependencies: Knockout.js, Backbone.js, and Underscore.js.
 Optional dependency: Backbone.ModelRef.js.
*/
if(!this.ko){throw new Error("Knockback: Dependency alert! Knockout.js must be included before this file")}if(!this.Backbone){throw new Error("Knockback: Dependency alert! Backbone.js must be included before this file")}if(!this._||!this._.VERSION){throw new Error("Knockback: Dependency alert! Underscore.js must be included before this file")}this.Knockback||(this.Knockback={});this.kb||(this.kb=this.Knockback);Knockback.VERSION="0.8.0";Knockback.locale_manager;Knockback.wrappedObservable=function(a){if(!a._kb_observable){throw new Error("Knockback: _kb_observable missing from your instance")}return a._kb_observable};Knockback.viewModelDestroyObservables=Knockback.vmDestroy=function(b){var c,d,a;a=[];for(c in b){d=b[c];a.push((function(e,f){if(!f||!((ko.isObservable(f)&&f.destroy)||(f instanceof kb.Observables))){return}f.destroy();return b[e]=null})(c,d))}return a};var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp=Object.prototype.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.CollectionObservable=(function(){function a(h,i,k){var b,f,e,j,c,g,d;this.observable_array=i;this.options=k;if(!h){throw new Error("CollectionObservable: collection is missing")}if(!this.observable_array){throw new Error("CollectionObservable: observable_array is missing")}if(!this.options){throw new Error("CollectionObservable: options is missing")}if(!this.options.viewModelCreate){throw new Error("CollectionObservable: options.viewModelCreate is missing")}_.bindAll(this,"destroy","collection","sorting","viewModelByModel","eachViewModel","bind","unbind","trigger");_.bindAll(this,"_onGetValue","_onCollectionReset","_onCollectionResort","_onModelAdd","_onModelRemove","_onModelChanged");this._kb_collection=h;if(this._kb_collection.retain){this._kb_collection.retain()}this._kb_collection.bind("reset",this._onCollectionReset);if(!this.options.sortedIndex){this._kb_collection.bind("resort",this._onCollectionResort)}g=["new","add"];for(f=0,j=g.length;f<j;f++){b=g[f];this._kb_collection.bind(b,this._onModelAdd)}d=["remove","destroy"];for(e=0,c=d.length;e<c;e++){b=d[e];this._kb_collection.bind(b,this._onModelRemove)}this._kb_collection.bind("change",this._onModelChanged);this._kb_value_observable=ko.observableArray([]);this._kb_observable=ko.dependentObservable(this._onGetValue);this._kb_observable.destroy=this.destroy;this._kb_observable.collection=this.collection;this._kb_observable.viewModelByModel=this.viewModelByModel;this._kb_observable.eachViewModel=this.eachViewModel;this._kb_observable.sorting=this.sorting;this._kb_observable.bind=this.bind;this._kb_observable.unbind=this.unbind;this._kb_observable.trigger=this.trigger;this._onCollectionReset(this._kb_collection);return kb.wrappedObservable(this)}a.prototype.destroy=function(){var e,g,d,c,b,f,h;this._kb_collection.unbind("reset",this._onCollectionReset);if(!this.options.sortedIndex){this._kb_collection.unbind("resort",this._onCollectionResort)}f=["new","add"];for(g=0,c=f.length;g<c;g++){e=f[g];this._kb_collection.unbind(e,this._onModelAdd)}h=["remove","destroy"];for(d=0,b=h.length;d<b;d++){e=h[d];this._kb_collection.unbind(e,this._onModelRemove)}this._kb_collection.unbind("change",this._onModelChanged);if(this._kb_collection.release){this._kb_collection.release()}this._kb_collection=null;this._kb_value_observable=null;this._kb_observable.dispose();this._kb_observable=null;this.observable_array=null;return this.options=null};a.prototype.collection=function(){this._kb_value_observable();return this._kb_collection};a.prototype.sorting=function(c,b){if(arguments.length===0){return{sortedIndex:this.options.sortedIndex,sort_attribute:this.options.sort_attribute}}this.options.sort_attribute=b;this.options.sortedIndex=c;return this._onCollectionReset()};a.prototype.viewModelByModel=function(c){var b;b=c.hasOwnProperty(c.idAttribute)?c.idAttribute:"cid";return _.find(this.observable_array(),function(d){return d.__kb_model[b]===c[b]})};a.prototype.eachViewModel=function(e){var d,g,c,f,b;f=this.observable_array();b=[];for(g=0,c=f.length;g<c;g++){d=f[g];b.push(e(d))}return b};a.prototype._onGetValue=function(){return this._kb_value_observable()};a.prototype._onCollectionReset=function(){var l,d,n,e,i,j,h,g,m,c,b,k,f;this.trigger("remove",this.observable_array());e=this.observable_array.removeAll();for(j=0,m=e.length;j<m;j++){n=e[j];kb.vmDestroy(n)}this._kb_value_observable.removeAll();e=[];if(this.options.sortedIndex){d=[];k=this._kb_collection.models;i=__bind(function(p){var o;n=this._viewModelCreate(p);o=this.options.sortedIndex(d,p);d.splice(o,0,p);return e.splice(o,0,n)},this);for(h=0,c=k.length;h<c;h++){l=k[h];i(l)}}else{f=this._kb_collection.models;for(g=0,b=f.length;g<b;g++){l=f[g];e.push(this._viewModelCreate(l))}d=_.clone(this._kb_collection.models)}this.observable_array(e);this._kb_value_observable(d);return this.trigger("add",this.observable_array())};a.prototype._onCollectionResort=function(e){var c,d,b;if(this.options.sortedIndex){throw new Error("CollectionObservable: collection sorting unexpected")}if(_.isArray(e)){for(d=0,b=e.length;d<b;d++){c=e[d];this._viewModelResort(this.viewModelByModel(c))}}else{this._viewModelResort(this.viewModelByModel(e))}return this.trigger("resort",this.observable_array())};a.prototype._onModelAdd=function(d){var b,e,c;c=this._viewModelCreate(d);if(this.options.sortedIndex){e=_.pluck(this.observable_array(),"__kb_model");b=this.options.sortedIndex(e,d)}else{b=this._kb_collection.indexOf(d)}this.observable_array.splice(b,0,c);this._kb_value_observable.splice(b,0,d);return this.trigger("add",c,this.observable_array())};a.prototype._onModelRemove=function(c){var b;b=this.viewModelByModel(c);if(!b){return}this.observable_array.remove(b);this._kb_value_observable.remove(c);this.trigger("remove",b,this.observable_array());kb.vmDestroy(b);return b.__kb_model=null};a.prototype._onModelChanged=function(c){var b;if(this.options.sortedIndex&&(!this.options.sort_attribute||c.hasChanged(this.options.sort_attribute))){b=this.viewModelByModel(c);if(!b){throw new Error("CollectionObservable: view_model not found for resort")}this._viewModelResort(b)}return this._kb_value_observable.valueHasMutated()};a.prototype._viewModelCreate=function(c){var b;b=this.options.viewModelCreate(c);if(b.__kb_model){throw new Error("CollectionObservable: __kb_model is reserved")}b.__kb_model=c;return b};a.prototype._viewModelResort=function(c){var d,b,f,e;f=this.observable_array.indexOf(c);d=c.__kb_model;if(this.options.sortedIndex){e=_.pluck(this.observable_array(),"__kb_model");e.splice(f,1);b=this.options.sortedIndex(e,d)}else{b=this._kb_collection.indexOf(d)}if(f===b){return}this.observable_array.splice(f,1);this.observable_array.splice(b,0,c);this._kb_value_observable.splice(f,1);this._kb_value_observable.splice(b,0,d);return this.trigger("resort",c,this.observable_array(),b)};return a})();__extends(Knockback.CollectionObservable.prototype,Backbone.Events);Knockback.collectionObservable=function(c,a,b){return new Knockback.CollectionObservable(c,a,b)};Knockback.viewModelGetModel=Knockback.vmModel=function(a){return a.__kb_model};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.LocalizedObservable=(function(){function a(d,c,b){this.value=d;this.options=c!=null?c:{};this.view_model=b;if(!(this.options.read||this.read)){throw new Error("LocalizedObservable: options.read is missing")}if(this.options.read&&this.read){throw new Error("LocalizedObservable: options.read and read class function exist. You need to choose one.")}if(this.options.write&&this.write){throw new Error("LocalizedObservable: options.write and write class function exist. You need to choose one.")}if(!kb.locale_manager){throw new Error("LocalizedObservable: Knockback.locale_manager is not defined")}_.bindAll(this,"destroy","setToDefault","resetToCurrent","getObservedValue","setObservedValue","_onGetValue","_onSetValue","_onLocaleChange");this._kb_read=this.options.read?this.options.read:this.read;this._kb_write=this.options.write?this.options.write:this.write;this._kb_default=this.options["default"]?this.options["default"]:this["default"];this._kb_value_observable=ko.observable();if(this._kb_write){if(!this.view_model){this.view_model={}}if(!_.isFunction(this._kb_write)){throw new Error("LocalizedObservable: options.write is not a function for read_write model attribute")}this._kb_observable=ko.dependentObservable({read:this._onGetValue,write:this._onSetValue,owner:this.view_model})}else{this._kb_observable=ko.dependentObservable(this._onGetValue)}this._kb_observable.destroy=this.destroy;this._kb_observable.getObservedValue=this.getObservedValue;this._kb_observable.setObservedValue=this.setObservedValue;this._kb_observable.setToDefault=this.setToDefault;this._kb_observable.resetToCurrent=this.resetToCurrent;kb.locale_manager.bind("change",this._onLocaleChange);this._onLocaleChange();return kb.wrappedObservable(this)}a.prototype.destroy=function(){kb.locale_manager.unbind("change",this._onLocaleChange);this._kb_value_observable=null;this._kb_observable.dispose();this._kb_observable=null;this.options={};return this.view_model=null};a.prototype.setToDefault=function(){var c,b;c=this._kb_value_observable();b=this._getDefaultValue();if(c!==b){return this._onSetValue(b)}else{return this._kb_value_observable.valueHasMutated()}};a.prototype.resetToCurrent=function(){this._kb_value_observable(null);return this._onSetValue(this._getCurrentValue())};a.prototype.getObservedValue=function(){return this.value};a.prototype.setObservedValue=function(b){this.value=b;this._onLocaleChange();return this};a.prototype._getDefaultValue=function(){if(!this._kb_default){return""}if(_.isFunction(this._kb_default)){return this._kb_default()}else{return this._kb_default}};a.prototype._getCurrentValue=function(){if(!(this.value&&this._kb_observable)){return this._getDefaultValue()}return this._kb_read.call(this,this.value,this._kb_observable)};a.prototype._onGetValue=function(){return this._kb_value_observable()};a.prototype._onSetValue=function(b){this._kb_write.call(this,b,this.value,this._kb_observable);b=this._kb_read.call(this,this.value,this._kb_observable);this._kb_value_observable(b);if(this.options.onChange){return this.options.onChange(b)}};a.prototype._onLocaleChange=function(){var b;b=this._kb_read.call(this,this.value,this._kb_observable);this._kb_value_observable(b);if(this.options.onChange){return this.options.onChange(b)}};return a})();Knockback.localizedObservable=function(c,b,a){return new Knockback.LocalizedObservable(c,b,a)};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.Observable=(function(){function a(d,c,b){this.model=d;this.options=c;this.view_model=b;if(!this.model){throw new Error("Observable: model is missing")}if(!this.options){throw new Error("Observable: options is missing")}if(!this.options.key){throw new Error("Observable: options.key is missing")}_.bindAll(this,"destroy","setToDefault","_onGetValue","_onSetValue","_onValueChange","_onModelLoaded","_onModelUnloaded");if(Backbone.ModelRef&&(this.model instanceof Backbone.ModelRef)){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this._onModelLoaded);this.model_ref.bind("unloaded",this._onModelUnloaded);this.model=this.model_ref.getModel()}this._kb_value_observable=ko.observable();if(this.options.localizer){this._kb_localizer=this.options.localizer(this._getCurrentValue())}if(this.options.write){if(!this.view_model){throw new Error("Observable: view_model is missing for read_write model attribute")}this._kb_observable=ko.dependentObservable({read:this._onGetValue,write:this._onSetValue,owner:this.view_model})}else{this._kb_observable=ko.dependentObservable(this._onGetValue)}this._kb_observable.destroy=this.destroy;this._kb_observable.setToDefault=this.setToDefault;if(!this.model_ref||this.model_ref.isLoaded()){this._onModelLoaded(this.model)}return kb.wrappedObservable(this)}a.prototype.destroy=function(){this._kb_value_observable=null;this._kb_observable.dispose();this._kb_observable=null;if(this.model){this._onModelUnloaded(this.model)}if(this.model_ref){this.model_ref.unbind("loaded",this._onModelLoaded);this.model_ref.unbind("unloaded",this._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.options=null;return this.view_model=null};a.prototype.setToDefault=function(){var b;b=this._getDefaultValue();if(this._kb_localizer){this._kb_localizer.setObservedValue(b);b=this._kb_localizer()}return this._kb_value_observable(b)};a.prototype._getDefaultValue=function(){if(!this.options.hasOwnProperty("default")){return""}if(_.isFunction(this.options["default"])){return this.options["default"]()}else{return this.options["default"]}};a.prototype._getCurrentValue=function(){if(!this.model){return this._getDefaultValue()}if(this.options.read){return this.options.read.apply(this.view_model,[this.model,this.options.key])}else{return this.model.get(this.options.key)}};a.prototype._onGetValue=function(){var b;b=this._kb_value_observable();if(!this.model){return this._getDefaultValue()}if(this._kb_localizer){return this._kb_localizer()}else{return b}};a.prototype._onSetValue=function(c){var b;if(this._kb_localizer){this._kb_localizer(c);c=this._kb_localizer.getObservedValue()}if(this.model){b={};b[this.options.key]=c;if(_.isFunction(this.options.write)){this.options.write.apply(this.view_model,[c,this.model,b])}else{this.model.set(b)}}if(this._kb_localizer){return this._kb_value_observable(this._kb_localizer())}else{return this._kb_value_observable(c)}};a.prototype._onModelLoaded=function(b){this.model=b;this.model.bind("change",this._onValueChange);this.model.bind("change:"+this.options.key,this._onValueChange);return this._onValueChange()};a.prototype._onModelUnloaded=function(){if(this._kb_localizer&&this._kb_localizer.destroy){this._kb_localizer.destroy();this._kb_localizer=null}this.model.unbind("change",this._onValueChange);this.model.unbind("change:"+this.options.key,this._onValueChange);return this.model=null};a.prototype._onValueChange=function(){var b;b=this._getCurrentValue();if(this._kb_localizer){this._kb_localizer.setObservedValue(b);b=this._kb_localizer()}return this._kb_value_observable(b)};return a})();Knockback.observable=function(c,b,a){return new Knockback.Observable(c,b,a)};var __bind=function(a,b){return function(){return a.apply(b,arguments)}};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.Observables=(function(){function a(c,f,b){var d,g,e;this.model=c;this.mappings_info=f;this.view_model=b;if(!this.model){throw new Error("Observables: model is missing")}if(!this.mappings_info){throw new Error("Observables: mappings_info is missing")}e=this.mappings_info;for(g in e){d=e[g];this.view_model[g]=kb.observable(this.model,d,this.view_model)}return this}a.prototype.destroy=function(){var b,e,d,c;c=this.mappings_info;d=__bind(function(g,f){if(this.view_model[g]){this.view_model[g].destroy()}return this.view_model[g]=null},this);for(e in c){b=c[e];d(e,b)}this.view_model=null;this.mappings_info=null;return this.model=null};a.prototype.setToDefault=function(){var c,e,d,b;d=this.mappings_info;b=[];for(e in d){c=d[e];b.push(this.view_model[e].setToDefault())}return b};return a})();Knockback.observables=function(b,c,a){return new Knockback.Observables(b,c,a)};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.TriggeredObservable=(function(){function a(b,c){this.model=b;this.event_name=c;if(!this.model){throw new Error("Observable: model is missing")}if(!this.event_name){throw new Error("Observable: event_name is missing")}_.bindAll(this,"destroy","_onGetValue","_onValueChange","_onModelLoaded","_onModelUnloaded");if(Backbone.ModelRef&&(this.model instanceof Backbone.ModelRef)){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this._onModelLoaded);this.model_ref.bind("unloaded",this._onModelUnloaded);this.model=this.model_ref.getModel()}this._kb_value_observable=ko.observable();this._kb_observable=ko.dependentObservable(this._onGetValue);this._kb_observable.destroy=this.destroy;if(!this.model_ref||this.model_ref.isLoaded()){this._onModelLoaded(this.model)}return kb.wrappedObservable(this)}a.prototype.destroy=function(){this._kb_observable.dispose();this._kb_observable=null;this._kb_value_observable=null;if(this.model){this._onModelUnloaded(this.model)}if(this.model_ref){this.model_ref.unbind("loaded",this._onModelLoaded);this.model_ref.unbind("unloaded",this._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.options=null;return this.view_model=null};a.prototype._onGetValue=function(){return this._kb_value_observable()};a.prototype._onModelLoaded=function(b){this.model=b;this.model.bind(this.event_name,this._onValueChange);return this._onValueChange()};a.prototype._onModelUnloaded=function(){if(this._kb_localizer&&this._kb_localizer.destroy){this._kb_localizer.destroy();this._kb_localizer=null}this.model.unbind(this.event_name,this._onValueChange);return this.model=null};a.prototype._onValueChange=function(){var b;b=this._kb_value_observable();if(b!==this.model){return this._kb_value_observable(this.model)}else{return this._kb_value_observable.valueHasMutated()}};return a})();Knockback.triggeredObservable=function(a,b){return new Knockback.TriggeredObservable(a,b)};