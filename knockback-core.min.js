/*
  knockback-core.js 0.16.5
  (c) 2011, 2012 Kevin Malakoff - http://kmalakoff.github.com/knockback/
  License: MIT (http://www.opensource.org/licenses/mit-license.php)
  Dependencies: Knockout.js, Backbone.js, and Underscore.js.
*/(function(){return function(e){return typeof define=="function"&&define.amd?define("knockback",["underscore","backbone","knockout"],e):e.call(this)}(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w=function(e,t){return function(){return e.apply(t,arguments)}};l=function(){function t(){}return t.VERSION="0.16.5",t.TYPE_UNKNOWN=0,t.TYPE_SIMPLE=1,t.TYPE_ARRAY=2,t.TYPE_MODEL=3,t.TYPE_COLLECTION=4,t.release=function(r,i){var s,o,u,a,f,l,h,p;if(!r||r!==Object(r)||typeof r=="function"&&!c.isObservable(r)||r.__kb_destroyed||r instanceof e.Model||r instanceof e.Collection)return this;if(m.isArray(r)){s=r.splice(0,r.length);for(f=0,h=s.length;f<h;f++)o=s[f],t.release(o);return this}r.__kb_destroyed=!0,!i||i();if(c.isObservable(r)||typeof r.dispose=="function"||typeof r.destroy=="function"||typeof r.release=="function")if(c.isObservable(r)&&m.isArray(s=r())){if(r.__kb_is_co||r.__kb_is_o&&r.valueType()===n)r.destroy?r.destroy():r.dispose&&r.dispose();else if(s.length){a=s.slice(0),s.splice(0,s.length);for(l=0,p=a.length;l<p;l++)u=a[l],t.release(u)}}else r.release?r.release():r.destroy?r.destroy():r.dispose&&r.dispose();else this.releaseKeys(r);return this},t.releaseKeys=function(e){var n,r;for(n in e)r=e[n],n==="__kb"||t.release(r,function(){return e[n]=null});return this},t.releaseOnNodeRemove=function(e,n){return e||v(this,"missing view model"),n||v(this,"missing node"),c.utils.domNodeDisposal.addDisposeCallback(n,function(){return t.release(e)})},t.renderTemplate=function(e,n,r){var i,s;return r==null&&(r={}),i=document.createElement("div"),s=c.renderTemplate(e,n,r,i,"replaceChildren"),i.children.length===1&&(i=i.children[0]),t.releaseOnNodeRemove(n,i),s.dispose(),i},t.renderAutoReleasedTemplate=function(e,t,n){return n==null&&(n={}),h("kb.renderAutoReleasedTemplate","0.16.3","Please use kb.renderTemplate instead"),this.renderTemplate(e,t,n={})},t.applyBindings=function(e,n){return c.applyBindings(e,n),t.releaseOnNodeRemove(e,n)},t}(),this.Knockback=this.kb=l,typeof exports!="undefined"&&(module.exports=l);if(!this._&&typeof require!="undefined")try{m=require("lodash")}catch(E){m=require("underscore")}else m=this._;return l._=m=m.hasOwnProperty("_")?m._:m,l.Backbone=e=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,l.ko=c=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko,d=function(e,t){throw""+(m.isString(e)?e:e.constructor.name)+": "+t+" is missing"},v=function(e,t){throw""+(m.isString(e)?e:e.constructor.name)+": "+t+" is unexpected"},h=function(e,t,n){var r;return this._legacy_warnings||(this._legacy_warnings={}),(r=this._legacy_warnings)[e]||(r[e]=0),this._legacy_warnings[e]++,console.warn("warning: '"+e+"' has been deprecated (will be removed in Knockback after "+t+"). "+n+".")},u=Array.prototype.splice,f=function(e){var t;t=m.clone(e);while(e.options)m.defaults(t,e.options),e=e.options;return delete t.options,t},s=l.TYPE_UNKNOWN,i=l.TYPE_SIMPLE,t=l.TYPE_ARRAY,r=l.TYPE_MODEL,n=l.TYPE_COLLECTION,b=function(e,t,n){return arguments.length===2?e&&e.__kb&&e.__kb.hasOwnProperty(t)?e.__kb[t]:void 0:(e||v(this,"no obj for wrapping "+t),e.__kb||(e.__kb={}),e.__kb[t]=n,n)},g=function(e,t){return u.call(e,1,0,t),e},y=function(e){var t,n,r;if(!e)return e;if(e.__kb)return"object"in e.__kb?e.__kb.object:e;if(m.isArray(e))return m.map(e,function(e){return y(e)});if(m.isObject(e)&&!c.isObservable(e)&&!m.isDate(e)&&!m.isString(e)){n={};for(t in e)r=e[t],n[t]=y(r);return n}return e},l.utils=function(){function o(){}return o.wrappedObservable=function(e,t){return b.apply(this,g(arguments,"observable"))},o.wrappedObject=function(e,t){return b.apply(this,g(arguments,"object"))},o.wrappedModel=function(e,t){return arguments.length===1?(t=b(e,"object"),m.isUndefined(t)?e:t):b(e,"object",t)},o.wrappedStore=function(e,t){return b.apply(this,g(arguments,"store"))},o.wrappedStoreIsOwned=function(e,t){return b.apply(this,g(arguments,"store_is_owned"))},o.wrappedFactory=function(e,t){return b.apply(this,g(arguments,"factory"))},o.wrappedModelWatcher=function(e,t){return b.apply(this,g(arguments,"model_watcher"))},o.wrappedModelWatcherIsOwned=function(e,t){return b.apply(this,g(arguments,"model_watcher_is_owned"))},o.wrappedDestroy=function(e){var t;if(!e.__kb)return;return e.__kb.model_watcher&&e.__kb.model_watcher.releaseCallbacks(e),t=e.__kb,e.__kb=null,t.observable&&(t.observable.destroy=t.observable.release=null,this.wrappedDestroy(t.observable),t.observable=null),t.factory=null,t.model_watcher_is_owned&&t.model_watcher.destroy(),t.model_watcher=null,t.store_is_owned&&t.store.destroy(),t.store=null},o.valueType=function(o){return o?o.__kb_is_o?o.valueType():o.__kb_is_co||o instanceof e.Collection?n:o instanceof l.ViewModel||o instanceof e.Model?r:m.isArray(o)?t:i:s},o.pathJoin=function(e,t){return(e?e[e.length-1]!=="."?""+e+".":e:"")+t},o.optionsPathJoin=function(e,t){return m.defaults({path:this.pathJoin(e.path,t)},e)},o.inferCreator=function(t,n,r,i,s){var o,u;n&&(o=n.creatorForPath(t,r));if(o)return o;if(i&&e.RelationalModel&&i instanceof e.RelationalModel){s=c.utils.unwrapObservable(s),u=m.find(i.getRelations(),function(e){return e.key===s});if(u)return u.collectionType||m.isArray(u.keyContents)?l.CollectionObservable:l.ViewModel}return t?t instanceof e.Model?l.ViewModel:t instanceof e.Collection?l.CollectionObservable:null:null},o.createFromDefaultCreator=function(t,n){return t instanceof e.Model?l.viewModel(t,n):t instanceof e.Collection?l.collectionObservable(t,n):m.isArray(t)?c.observableArray(t):c.observable(t)},o.release=function(e){return h("kb.utils.release","0.16.0","Please use kb.release instead"),l.release(e)},o}(),l.Factory=function(){function e(e){this.parent_factory=e,this.paths={}}return e.useOptionsOrCreate=function(e,t,n){var r;return e.factory&&(!e.factories||e.factories&&e.factory.hasPathMappings(e.factories,n))?l.utils.wrappedFactory(t,e.factory):(r=l.utils.wrappedFactory(t,new l.Factory(e.factory)),e.factories&&r.addPathMappings(e.factories,n),r)},e.prototype.hasPath=function(e){return this.paths.hasOwnProperty(e)||this.parent_factory&&this.parent_factory.hasPath(e)},e.prototype.addPathMapping=function(e,t){return this.paths[e]=t},e.prototype.addPathMappings=function(e,t){var n,r;for(r in e)n=e[r],this.paths[l.utils.pathJoin(t,r)]=n;return this},e.prototype.hasPathMappings=function(e,t){var n,r,i,s;n=!0;for(s in e)r=e[s],n&=(i=this.creatorForPath(null,l.utils.pathJoin(t,s)))&&r===i;return n},e.prototype.creatorForPath=function(e,t){var n;if(n=this.paths[t])return n.view_model?n.view_model:n;if(this.parent_factory)if(n=this.parent_factory.creatorForPath(e,t))return n;return null},e}(),l.Store=function(){function t(){this.observable_records=[],this.replaced_observables=[]}return t.useOptionsOrCreate=function(e,t,n){return e.store?(e.store.register(t,n,e),l.utils.wrappedStore(n,e.store)):(l.utils.wrappedStoreIsOwned(n,!0),l.utils.wrappedStore(n,new l.Store))},t.prototype.destroy=function(){var e,t,n,r,i,s,o,u;o=this.observable_records;for(n=0,i=o.length;n<i;n++)t=o[n],l.release(t.observable);u=this.replaced_observables;for(r=0,s=u.length;r<s;r++)e=u[r],l.release(e);return this.observable_records=null,this.replaced_observables=null},t.prototype.register=function(e,t,n){var r;if(!t)return;if(c.isObservable(t)||t.__kb_is_co)return;return l.utils.wrappedObject(t,e),e||(t.__kb_null=!0),r=n.creator?n.creator:n.path&&n.factory?n.factory.creatorForPath(e,n.path):null,r||(r=t.constructor),this.observable_records.push({obj:e,observable:t,creator:r}),t},t.prototype.findIndex=function(t,n){var r,i,s;if(!t||t instanceof e.Model){s=this.observable_records;for(r in s){i=s[r];if(!i.observable)continue;if(i.observable.__kb_destroyed){i.obj=null,i.observable=null;continue}if(!t&&!i.observable.__kb_null||t&&(i.observable.__kb_null||i.obj!==t))continue;if(i.creator===n||i.creator.create&&i.creator.create===n.create)return r}}return-1},t.prototype.find=function(e,t){var n;return(n=this.findIndex(e,t))<0?null:this.observable_records[n].observable},t.prototype.isRegistered=function(e){var t,n,r,i;i=this.observable_records;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.observable===e)return!0}return!1},t.prototype.findOrCreate=function(t,n){var r,i;return n.store=this,n.creator||(n.creator=l.utils.inferCreator(t,n.factory,n.path)),!n.creator&&t instanceof e.Model&&(n.creator=kv.ViewModel),r=n.creator,r?r.models_only?t:(r&&(i=this.find(t,r)),i?i:(r.create?i=r.create(t,n):i=new r(t,n),i||(i=c.observable(null)),c.isObservable(i)||this.isRegistered(i)||this.register(t,i,n),i)):l.utils.createFromDefaultCreator(t,n)},t.prototype.findOrReplace=function(e,t,n){var r,i;return e||raiseUnexpected("obj missing"),(r=this.findIndex(e,t))<0?this.register(e,n,{creator:t}):(i=this.observable_records[r],l.utils.wrappedObject(i.observable)===e||v(this,"different object"),i.observable!==n&&(i.observable.constructor===n.constructor||v(this,"replacing different type"),this.replaced_observables.push(i.observable),i.observable=n),n)},t}(),o=function(e,t,n){return!l.statistics||l.statistics.addModelEvent({name:t,model:e,key:n.key,path:n.path})},l.ModelWatcher=function(){function t(e,t,n){this._onModelUnloaded=w(this._onModelUnloaded,this),this._onModelLoaded=w(this._onModelLoaded,this),this.__kb||(this.__kb={}),this.__kb.callbacks={},this.__kb._onModelLoaded=m.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=m.bind(this._onModelUnloaded,this),n&&this.registerCallbacks(t,n),e?this.model(e):this.m=null}return t.useOptionsOrCreate=function(e,t,n,r){return e.model_watcher?(e.model_watcher.model()!==t&&e.model_watcher.model_ref!==t&&v(this,"model not matching"),l.utils.wrappedModelWatcher(n,e.model_watcher).registerCallbacks(n,r)):(l.utils.wrappedModelWatcherIsOwned(n,!0),l.utils.wrappedModelWatcher(n,new l.ModelWatcher(t)).registerCallbacks(n,r))},t.prototype.destroy=function(){return this.model(null),this.__kb.callbacks=null,l.utils.wrappedDestroy(this)},t.prototype.model=function(t){var n,r,i,s,o,u,a,f;if(arguments.length===0||this.m===t)return this.m;this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),e.ModelRef&&t instanceof e.ModelRef?(this.model_ref=t,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),t=this.model_ref.model()):delete this.model_ref,o=this.m,this.m=t,f=this.__kb.callbacks;for(r in f){n=f[r],o&&o.unbind(r,n.fn),t&&t.bind(r,n.fn),s=n.list;for(u=0,a=s.length;u<a;u++)i=s[u],i.model&&i.model(t)}return t},t.prototype.registerCallbacks=function(t,n){var r,i,s,u;return t||d(this,"obj"),n||d(this,"info"),i=n.event_name?n.event_name:"change",r=this.__kb.callbacks[i],r||(u=[],r={list:u,fn:function(e){var t,n,r;for(n=0,r=u.length;n<r;n++){t=u[n];if(t.update&&!t.rel_fn){if(e&&t.key&&e.hasChanged&&!e.hasChanged(c.utils.unwrapObservable(t.key)))continue;!l.statistics||o(e,i,t),t.update()}}return null}},this.__kb.callbacks[i]=r,this.m&&this.m.bind(i,r.fn)),s=m.defaults({obj:t},n),r.list.push(s),this.m&&(e.RelationalModel&&this.m instanceof e.RelationalModel&&this._modelBindRelatationalInfo(i,s),s.model(this.m)&&s.model),this},t.prototype.releaseCallbacks=function(e){var t,n,r,i,s,o;if(!this.__kb.callbacks)return;s=this.__kb.callbacks;for(n in s){t=s[n],o=t.list;for(r in o){i=o[r];if(i.obj===e){t.list.splice(r,1),i.rel_fn&&this._modelUnbindRelatationalInfo(n,i),i.model&&i.model(null);return}}}},t.prototype._onModelLoaded=function(t){var n,r,i,s,o,u,a,f;s=e.RelationalModel&&t instanceof e.RelationalModel,this.m=t,f=this.__kb.callbacks;for(r in f){n=f[r],t.bind(r,n.fn),o=n.list;for(u=0,a=o.length;u<a;u++)i=o[u],s&&this._modelBindRelatationalInfo(r,i),i.model&&i.model(t)}return this},t.prototype._onModelUnloaded=function(e){var t,n,r,i,s,o,u;this.m=null,u=this.__kb.callbacks;for(n in u){t=u[n],e.unbind(n,t.fn),i=t.list;for(s=0,o=i.length;s<o;s++)r=i[s],r.rel_fn&&this._modelUnbindRelatationalInfo(n,r),r.model&&r.model(null)}return this},t.prototype._modelBindRelatationalInfo=function(e,t){var n,r;if(e==="change"&&t.key&&t.update){n=c.utils.unwrapObservable(t.key),r=m.find(this.m.getRelations(),function(e){return e.key===n});if(!r)return;t.rel_fn=function(n){return!l.statistics||o(n,""+e+" (relational)",t),t.update()},r.collectionType||m.isArray(r.keyContents)?(t.is_collection=!0,this.m.bind("add:"+t.key,t.rel_fn),this.m.bind("remove:"+t.key,t.rel_fn)):this.m.bind("update:"+t.key,t.rel_fn)}return this},t.prototype._modelUnbindRelatationalInfo=function(e,t){if(!t.rel_fn)return;return t.is_collection?(this.m.unbind("add:"+t.key,t.rel_fn),this.m.unbind("remove:"+t.key,t.rel_fn)):this.m.unbind("update:"+t.key,t.rel_fn),t.rel_fn=null,this},t}(),l.modelObservable=function(e,t){return new l.ModelWatcher(e,t)},l.Observable=function(){function e(e,t,n){var r,i,s,o=this;return this.vm=n,t||d(this,"options"),this.vm||(this.vm={}),m.isString(t)||c.isObservable(t)?r=this.create_options={key:t}:r=this.create_options=f(t),this.key=r.key,delete r.key,this.key||d(this,"key"),!r.args||(this.args=r.args,delete r.args),!r.read||(this.read=r.read,delete r.read),!r.write||(this.write=r.write,delete r.write),i=r.model_watcher,delete r.model_watcher,this.vo=c.observable(null),s=l.utils.wrappedObservable(this,c.dependentObservable({read:function(){var e,t,n,r,i,s;t=[c.utils.unwrapObservable(o.key)];if(o.args)if(m.isArray(o.args)){s=o.args;for(r=0,i=s.length;r<i;r++)e=s[r],t.push(c.utils.unwrapObservable(e))}else t.push(c.utils.unwrapObservable(o.args));return o.m&&(n=o.read?o.read.apply(o.vm,t):o.m.get.apply(o.m,t),o.update(n)),c.utils.unwrapObservable(o.vo())},write:function(e){var t,n,r,i,s,u,a;i=y(e),r={},r[c.utils.unwrapObservable(o.key)]=i,n=o.write?[i]:[r];if(o.args)if(m.isArray(o.args)){a=o.args;for(s=0,u=a.length;s<u;s++)t=a[s],n.push(c.utils.unwrapObservable(t))}else n.push(c.utils.unwrapObservable(o.args));return o.m&&(o.write?o.write.apply(o.vm,n):o.m.set.apply(o.m,n)),o.update(e)},owner:this.vm})),s.__kb_is_o=!0,r.store=l.utils.wrappedStore(s,r.store),r.path=l.utils.pathJoin(r.path,this.key),r.factories&&(typeof r.factories=="function"||r.factories.create)?(r.factory=l.utils.wrappedFactory(s,new l.Factory(r.factory)),r.factory.addPathMapping(r.path,r.factories)):r.factory=l.Factory.useOptionsOrCreate(r,s,r.path),delete r.factories,s.value=m.bind(this.value,this),s.valueType=m.bind(this.valueType,this),s.destroy=m.bind(this.destroy,this),l.ModelWatcher.useOptionsOrCreate({model_watcher:i},e,this,{model:m.bind(this.model,this),update:m.bind(this.update,this),key:this.key,path:r.path}),this.__kb_value||this.update(),l.LocalizedObservable&&r.localizer&&(s=new r.localizer(s),delete r.localizer),l.DefaultObservable&&r.hasOwnProperty("default")&&(s=l.defaultObservable(s,r["default"]),delete r["default"]),s}return e.prototype.destroy=function(){return this.__kb_destroyed=!0,l.release(this.__kb_value),this.__kb_value=null,this.vm=null,this.create_options=null,l.utils.wrappedDestroy(this)},e.prototype.value=function(){return this.__kb_value},e.prototype.valueType=function(){var e;return e=this.m?this.m.get(this.key):null,this.value_type||this._updateValueObservable(e),this.value_type},e.prototype.model=function(e){if(this.__kb_destroyed)return;return arguments.length===0||this.m===e?this.m:(this.m=e,this.update())},e.prototype.update=function(e){var i,o;if(this.__kb_destroyed)return;this.m&&!arguments.length&&(e=this.m.get(c.utils.unwrapObservable(this.key))),e!==void 0||(e=null),i=l.utils.valueType(e);if(!this.__kb_value||this.__kb_value.__kb_destroyed||this.__kb_value.__kb_null&&e)this.__kb_value=null,this.value_type=void 0;o=this.__kb_value;if(m.isUndefined(this.value_type)||this.value_type!==i&&i!==s)return this.value_type===n&&i===t?o(e):this._updateValueObservable(e);if(this.value_type===r){if(typeof o.model=="function"){if(o.model()!==e)return o.model(e)}else if(l.utils.wrappedObject(o)!==e)return this._updateValueObservable(e)}else if(this.value_type===n){if(o.collection()!==e)return o.collection(e)}else if(o()!==e)return o(e)},e.prototype._updateValueObservable=function(e){var t,o,u,a;return t=this.create_options,t.creator=l.utils.inferCreator(e,t.factory,t.path,this.m,this.key),this.value_type=s,o=t.creator,u=this.__kb_value,this.__kb_value=null,u&&l.release(u),o?t.store?a=t.store.findOrCreate(e,t):o.models_only?(a=e,this.value_type=i):o.create?a=o.create(e,t):a=new o(e,t):(this.value_type=i,m.isArray(e)?a=c.observableArray(e):a=c.observable(e)),this.value_type===s&&(c.isObservable(a)?a.__kb_is_co?this.value_type=n:this.value_type=i:(this.value_type=r,typeof a.model!="function"&&l.utils.wrappedObject(a,e))),this.__kb_value=a,this.vo(a)},e}(),l.observable=function(e,t,n){return new l.Observable(e,t,n)},l.ViewModel=function(){function t(t,n,r){var i,s,o,u,a,c,h,p;!t||t instanceof e.Model||typeof t.get=="function"&&typeof t.bind=="function"||v(this,"not a model"),n||(n={}),r||(r={}),m.isArray(n)?n={keys:n}:n=f(n),this.__kb||(this.__kb={}),this.__kb.vm_keys={},this.__kb.model_keys={},this.__kb.view_model=m.isUndefined(r)?this:r,!n.internals||(this.__kb.internals=n.internals),!n.excludes||(this.__kb.excludes=n.excludes),l.Store.useOptionsOrCreate(n,t,this),this.__kb.path=n.path,l.Factory.useOptionsOrCreate(n,this,n.path),c=l.utils.wrappedModelWatcher(this,new l.ModelWatcher(t,this,{model:m.bind(this.model,this)})),n.requires&&m.isArray(n.requires)&&(o=m.clone(n.requires)),this.__kb.internals&&(o=o?m.union(o,this.__kb.internals):m.clone(this.__kb.internals));if(n.keys)if(m.isArray(n.keys))this.__kb.keys=n.keys,o=o?m.union(o,n.keys):m.clone(n.keys);else{u={},p=n.keys;for(h in p)a=p[h],u[m.isString(a)?a:a.key?a.key:h]=!0;this.__kb.keys=m.keys(u)}else s=c.model(),s&&s.attributes&&(i=m.keys(s.attributes),o=o?m.union(o,i):i);o&&this.__kb.excludes&&(o=m.difference(o,this.__kb.excludes)),m.isObject(n.keys)&&!m.isArray(n.keys)&&this._mapObservables(t,n.keys),m.isObject(n.requires)&&!m.isArray(n.requires)&&this._mapObservables(t,n.requires),!n.mappings||this._mapObservables(t,n.mappings),!o||this._createObservables(t,o),!l.statistics||l.statistics.register("ViewModel",this)}return t.extend=e.Model.extend,t.prototype.destroy=function(){var e;if(this.__kb.view_model!==this)for(e in this.__kb.vm_keys)this.__kb.view_model[e]=null;return this.__kb.view_model=null,l.releaseKeys(this),l.utils.wrappedDestroy(this),!l.statistics||l.statistics.unregister("ViewModel",this)},t.prototype.shareOptions=function(){return{store:l.utils.wrappedStore(this),factory:l.utils.wrappedFactory(this)}},t.prototype.model=function(e){var t,n,r;n=l.utils.wrappedObject(this);if(arguments.length===0||n===e)return n;if(this.__kb_null){!e||v(this,"model set on shared null");return}l.utils.wrappedObject(this,e),r=l.utils.wrappedModelWatcher(this);if(!r)return;r.model(e);if(this.__kb.keys||!e||!e.attributes)return;t=m.difference(m.keys(e.attributes),m.keys(this.__kb.model_keys));if(t)return this._createObservables(e,t)},t.prototype._createObservables=function(e,t){var n,r,i,s,o;n={store:l.utils.wrappedStore(this),factory:l.utils.wrappedFactory(this),path:this.__kb.path,model_watcher:l.utils.wrappedModelWatcher(this)};for(s=0,o=t.length;s<o;s++){r=t[s],i=this.__kb.internals&&m.contains(this.__kb.internals,r)?"_"+r:r;if(this[i])continue;this.__kb.vm_keys[i]=!0,this.__kb.model_keys[r]=!0,n.key=r,this[i]=this.__kb.view_model[i]=l.observable(e,n,this)}return this},t.prototype._mapObservables=function(e,t){var n,r,i;n={store:l.utils.wrappedStore(this),factory:l.utils.wrappedFactory(this),path:this.__kb.path,model_watcher:l.utils.wrappedModelWatcher(this)};for(i in t){r=t[i];if(this[i])continue;r=m.isString(r)?{key:r}:m.clone(r),r.key||(r.key=i),this.__kb.vm_keys[i]=!0,this.__kb.model_keys[r.key]=!0,this[i]=this.__kb.view_model[i]=l.observable(e,m.defaults(r,n),this)}return this},t}(),l.viewModel=function(e,t,n){return new l.ViewModel(e,t,n)},l.observables=function(e,t,n){return h("kb.observables","0.16.0","Please use kb.viewModel instead"),new l.ViewModel(e,t,n)},l.CollectionObservable=function(){function t(t,n){var r,i,s=this;return!t||t instanceof e.Collection||v(this,"not a collection"),n||(n={}),i=l.utils.wrappedObservable(this,c.observableArray([])),i.__kb_is_co=!0,this.in_edit=0,this.__kb||(this.__kb={}),this.__kb._onCollectionChange=m.bind(this._onCollectionChange,this),n=f(n),n.sort_attribute?this.sorted_index_fn=c.observable(this._sortAttributeFn(n.sort_attribute)):(n.sorted_index&&(h(this,"0.16.3","use sorted_index_fn instead"),n.sorted_index_fn=n.sorted_index),this.sorted_index_fn=c.observable(n.sorted_index_fn)),n.filters?this.filters=c.observableArray(m.isArray(n.filters)?n.filters:n.filters?[n.filters]:void 0):this.filters=c.observableArray([]),r=this.create_options={store:l.Store.useOptionsOrCreate(n,t,i)},this.path=n.path,r.factory=l.utils.wrappedFactory(i,this._shareOrCreateFactory(n)),r.path=l.utils.pathJoin(n.path,"models"),r.creator=r.factory.creatorForPath(null,r.path),r.creator&&(this.models_only=r.creator.models_only),i.destroy=m.bind(this.destroy,this),i.shareOptions=m.bind(this.shareOptions,this),i.collection=m.bind(this.collection,this),i.viewModelByModel=m.bind(this.viewModelByModel,this),i.sortedIndex=m.bind(this.sortedIndex,this),i.sortAttribute=m.bind(this.sortAttribute,this),i.hasViewModels=m.bind(this.hasViewModels,this),this._col=c.observable(),this.collection(t),this._mapper=c.dependentObservable(function(){var e,n,r,o,u,a,f,c;if(s.in_edit)return;i=l.utils.wrappedObservable(s),t=s._col(),t&&(r=t.models),o=s.sorted_index_fn(),e=s.filters();if(!r||t.models.length===0)a=[];else{e.length&&(r=m.filter(r,function(e){return!s._modelIsFiltered(e)}));if(o){a=[];for(f=0,c=r.length;f<c;f++)n=r[f],u=s._createViewModel(n),a.splice(o(a,u),0,u)}else s.models_only?a=e.length?r:r.slice():a=m.map(r,function(e){return s._createViewModel(e)})}return s.in_edit++,i(a),s.in_edit--}),i.subscribe(m.bind(this._onObservableArrayChange,this)),!l.statistics||l.statistics.register("CollectionObservable",this),i}return t.extend=e.Model.extend,t.prototype.destroy=function(){var e,t,n;return n=l.utils.wrappedObservable(this),t=this._col(),t&&(t.unbind("all",this.__kb._onCollectionChange),e=n(),e.splice(0,e.length)),l.release(this.filters),this.filters=this._col=this.sorted_index_fn=this._mapper=this.create_options=null,l.utils.wrappedDestroy(this),!l.statistics||l.statistics.unregister("CollectionObservable",this)},t.prototype.shareOptions=function(){var e;return e=l.utils.wrappedObservable(this),{store:l.utils.wrappedStore(e),factory:l.utils.wrappedFactory(e)}},t.prototype.collection=function(e){var t,n;return t=l.utils.wrappedObservable(this),n=this._col(),arguments.length===0||e===n?(t(),n):(n&&n.unbind("all",this.__kb._onCollectionChange),e&&e.bind("all",this.__kb._onCollectionChange),this._col(e),e)},t.prototype.filters=function(e){return e?this.filters(m.isArray(e)?e:[e]):this.filters([])},t.prototype.sortedIndex=function(e){return this.sorted_index_fn(e)},t.prototype.sortAttribute=function(e){return this.sorted_index_fn(e?this._sortAttributeFn(e):null)},t.prototype.viewModelByModel=function(e){var t;return this.models_only?null:(t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid",m.find(l.utils.wrappedObservable(this)(),function(n){return n.__kb.object[t]===e[t]}))},t.prototype.hasViewModels=function(){return!this.models_only},t.prototype._shareOrCreateFactory=function(e){var t,n,r,i;t=l.utils.pathJoin(e.path,"models"),r=e.factories;if(i=e.factory)if((n=i.creatorForPath(null,t))&&(!r||r.models===n)){if(!r)return i;if(i.hasPathMappings(r,e.path))return i}return i=new l.Factory(e.factory),r&&i.addPathMappings(r,e.path),i.creatorForPath(null,t)||(e.hasOwnProperty("models_only")?e.models_only?i.addPathMapping(t,{models_only:!0}):i.addPathMapping(t,l.ViewModel):e.view_model?i.addPathMapping(t,e.view_model):e.create?i.addPathMapping(t,{create:e.create}):i.addPathMapping(t,l.ViewModel)),i},t.prototype._onCollectionChange=function(e,t){var n,r,i,s,o;if(this.in_edit)return;switch(e){case"reset":case"resort":if(e==="resort"&&!this.sorted_index_fn())return;return this._col.notifySubscribers(this._col());case"new":case"add":if(this._modelIsFiltered(t))return;return i=l.utils.wrappedObservable(this),r=this._col(),o=this._createViewModel(t),(s=this.sorted_index_fn())?n=s(i(),o):n=r.indexOf(t),this.in_edit++,i.splice(n,0,o),this.in_edit--;case"remove":case"destroy":return this._onModelRemove(t);case"change":if(this._modelIsFiltered(t))return this._onModelRemove(t);if(this.sorted_index_fn())return this._onModelResort(t)}},t.prototype._onModelRemove=function(e){var t,n;n=this.models_only?e:this.viewModelByModel(e);if(!n)return;return t=l.utils.wrappedObservable(this),this.in_edit++,t.remove(n),this.in_edit--},t.prototype._onModelResort=function(e){var t,n,r,i,s,o;n=l.utils.wrappedObservable(this),o=this.models_only?e:this.viewModelByModel(e),r=n.indexOf(o),(i=this.sorted_index_fn())?(s=m.clone(n()),s.splice(r,1),t=i(s,o)):t=this._col().indexOf(e);if(r===t)return;return this.in_edit++,n.splice(r,1),n.splice(t,0,o),this.in_edit--},t.prototype._onObservableArrayChange=function(t){var n,r,i,s,o,u,a,f,c,h=this;if(this.in_edit)return;s=l.utils.wrappedObservable(this),n=this._col();if(!n)return;if(!this.models_only){for(u=0,f=t.length;u<f;u++){o=t[u];if(o&&!(o instanceof e.Model)){r=!0;break}}if(r)for(a=0,c=t.length;a<c;a++)o=t[a],this.create_options.store.findOrReplace(l.utils.wrappedObject(o),this.create_options.creator,o)}return i=m.map(t,function(e){return l.utils.wrappedModel(e)}),this.filters().length&&(i=m.filter(i,function(e){return!h._modelIsFiltered(e)})),this.in_edit++,n.reset(i),this.in_edit--,this},t.prototype._sortAttributeFn=function(e){return this.models_only?function(t,n){var r;return r=c.utils.unwrapObservable(e),m.sortedIndex(t,n,function(e){return e.get(r)})}:function(t,n){var r;return r=c.utils.unwrapObservable(e),m.sortedIndex(t,n,function(e){return l.utils.wrappedModel(e).get(r)})}},t.prototype._createViewModel=function(e){return this.models_only?e:this.create_options.store.findOrCreate(e,this.create_options)},t.prototype._modelIsFiltered=function(e){var t,n,r,i;n=this.filters();for(r=0,i=n.length;r<i;r++){t=n[r],t=c.utils.unwrapObservable(t);if(typeof t=="function"&&t(e)||e&&e.id===t)return!0}return!1},t}(),l.collectionObservable=function(e,t){return new l.CollectionObservable(e,t)},l.sortedIndexWrapAttr=l.siwa=function(e,t){return function(n,r){return m.sortedIndex(n,r,function(n){return new t(l.utils.wrappedModel(n).get(e))})}},a=function(e,t){var n,r;n="return ( "+e+" )",r=-1;while(++r<t)n="with(sc["+r+"]) { "+n+" }";return new Function("sc",n)},c.bindingHandlers.inject={init:function(e,t,n,r){var i;return i=l.inject(c.utils.unwrapObservable(t()),r,e,t,n),i===r||v("inject","changing the view model")}},l.inject=function(e,t,n,r,i,s){var o,u,a;return o=function(e){var o,u,a;if(m.isFunction(e))t=new e(t,n,r,i),l.releaseOnNodeRemove(t,n);else{e.view_model&&(t=new e.view_model(t,n,r,i),l.releaseOnNodeRemove(t,n));for(o in e){a=e[o];if(o==="view_model")continue;o==="create"?a(t,n,r,i):m.isObject(a)&&!m.isFunction(a)?(u=s||a&&a.create?{}:t,t[o]=l.inject(a,u,n,r,i,!0)):t[o]=a}}return t},s?o(e):(u=(a=c.dependentObservable(function(){return o(e)}))(),a.dispose(),u)},l.injectApps=function(e){var t,n,r,i,s,o,u,f;n=[],s=function(e){var t,r,i,o,u;e.__kb_injected||e.attributes&&(t=m.find(e.attributes,function(e){return e.name==="kb-app"}))&&(e.__kb_injected=!0,n.push({el:e,view_model:{},binding:t.value})),u=e.childNodes;for(i=0,o=u.length;i<o;i++)r=u[i],s(r)},s(e||document);for(u=0,f=n.length;u<f;u++){t=n[u];if(i=t.binding)i.search(/[:]/)<0||(i="{"+i+"}"),r=a(i,0)(),r||(r={}),!r.options||(o=r.options,delete r.options),t.view_model=l.inject(r,t.view_model,t.el,null,null,!0);o&&o.beforeBinding&&o.beforeBinding(t.view_model,t.el,o),l.applyBindings(t.view_model,t.el,o),o&&o.afterBinding&&o.afterBinding(t.view_model,t.el,o)}return n},this.$?this.$(function(){return l.injectApps()}):(p=function(){return document.readyState!=="complete"?setTimeout(p,0):l.injectApps()})(),l})}).call(this);